<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>تکمیل خرید | پرداخت امن</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* --- Core Variables --- */
        :root {
            --brand-color: #D4AF37; /* Default Gold */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --anim-speed: 0.4s;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh; height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* Price Font Fix */
        .price-font {
            font-family: 'Vazirmatn', sans-serif;
            font-feature-settings: "ss01";
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
            direction: ltr; 
            display: inline-block;
        }

        /* --- Main Layout --- */
        .app-container {
            width: 100%; max-width: 450px; background: var(--card-bg);
            height: 100%; position: relative; display: flex; flex-direction: column;
        }
        @media (min-width: 480px) {
            .app-container { height: 90vh; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        }

        /* --- Header & Stepper --- */
        .app-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border-color); z-index: 10; flex-shrink: 0; text-align: center; }
        
        .brand-identity { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 15px; }
        .brand-logo-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid var(--brand-color); padding: 2px; }
        .brand-name { font-weight: 900; font-size: 14px; color: var(--text-main); letter-spacing: -0.5px; }

        .stepper { display: flex; justify-content: space-between; position: relative; padding: 0 15px; max-width: 300px; margin: 0 auto; }
        .stepper::before { content: ''; position: absolute; top: 14px; left: 25px; right: 25px; height: 3px; background: #f3f4f6; z-index: 0; border-radius: 10px; }
        .step-item { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; width: 33%; }
        .step-circle { width: 30px; height: 30px; background: #fff; border: 2px solid #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-light); transition: all 0.3s ease; margin-bottom: 5px; font-weight: bold; }
        .step-label { font-size: 10px; color: var(--text-light); font-weight: bold; transition: color 0.3s; }
        
        .step-item.active .step-circle { border-color: var(--brand-color); background: var(--brand-color); color: #fff; box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05); transform: scale(1.1); }
        .step-item.active .step-label { color: var(--brand-color); }
        .step-item.completed .step-circle { border-color: #10b981; background: #10b981; color: #fff; border-width: 0; }

        /* --- Content Panels --- */
        .content-area { flex: 1; position: relative; overflow: hidden; background: #fff; }
        .step-panel {
            position: absolute; inset: 0; padding: 20px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            transition: transform var(--anim-speed) cubic-bezier(0.4, 0.0, 0.2, 1), opacity var(--anim-speed);
            opacity: 0; transform: translateX(50px); pointer-events: none; padding-bottom: 100px;
        }
        .step-panel.active-panel { opacity: 1; transform: translateX(0); pointer-events: all; z-index: 2; }

        /* --- Gallery --- */
        .gallery-container {
            position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 24px;
            overflow: hidden; margin-bottom: 20px; cursor: zoom-in;
            background: #f9fafb; border: 1px solid #f3f4f6; 
        }
        .gallery-img { 
            width: 100%; height: 100%; object-fit: cover; 
            transition: opacity 0.5s ease-in-out, transform 0.5s ease;
            display: block; position: absolute; top: 0; left: 0;
        }
        .gallery-img.active { opacity: 1; transform: scale(1); z-index: 2; }
        .gallery-img.inactive { opacity: 0; transform: scale(1.05); z-index: 1; }
        
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 36px; height: 36px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #333; font-size: 14px;
        }
        .nav-prev { right: 10px; } .nav-next { left: 10px; }
        
        .gallery-dots {
            position: absolute; bottom: 15px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 6px; z-index: 5;
        }
        .dot { width: 6px; height: 6px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; backdrop-filter: blur(2px); }
        .dot.active { background: #fff; width: 20px; border-radius: 10px; }

        /* --- Modern Desc Box --- */
        .modern-desc-box {
            background: #fff; border: 1px solid #f3f4f6; border-radius: 24px;
            margin-bottom: 24px; overflow: hidden;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.03);
        }
        .desc-header {
            padding: 16px 20px; border-bottom: 1px solid #f9fafb;
            display: flex; align-items: center; gap: 8px;
        }
        .desc-header i { color: var(--brand-color); }
        .desc-header span { font-size: 13px; font-weight: 900; color: #374151; }
        
        .desc-content-wrapper {
            position: relative; overflow: hidden; 
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 100px; padding: 20px; padding-bottom: 0;
        }
        .desc-content-wrapper.expanded { max-height: 2000px; padding-bottom: 20px; }
        
        .desc-text {
            font-size: 14px; color: #4b5563; line-height: 2;
            text-align: justify; font-weight: 500; opacity: 0.9;
        }
        
        .desc-fade-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to top, #ffffff 10%, rgba(255,255,255,0));
            pointer-events: none; transition: opacity 0.3s;
        }
        .desc-content-wrapper.expanded .desc-fade-overlay { opacity: 0; }

        .desc-action-btn {
            width: 100%; padding: 12px; background: #fcfcfc;
            color: var(--brand-color); font-size: 11px; font-weight: 800;
            display: flex; items-center; justify-content: center; gap: 6px;
            cursor: pointer; transition: all 0.3s; border-top: 1px solid #f3f4f6;
        }
        .desc-action-btn:hover { background: #f9fafb; }
        .desc-action-btn i { transition: transform 0.3s; }
        .desc-content-wrapper.expanded + .desc-action-btn i { transform: rotate(180deg); }

        /* --- Lightbox --- */
        #lightbox {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #lightbox.open { opacity: 1; pointer-events: all; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; padding: 10px; cursor: pointer; }

        /* --- Product UI --- */
        .option-section { margin-bottom: 24px; }
        .option-title { font-size: 12px; font-weight: 800; color: var(--text-main); margin-bottom: 12px; display: block; }
        
        .chip {
            padding: 10px 18px; border: 1px solid #e5e7eb; border-radius: 12px;
            font-size: 12px; color: var(--text-main); cursor: pointer; transition: all 0.2s;
            background: #fff; font-weight: 700; min-width: 60px; text-align: center;
        }
        .chip.selected {
            background: var(--brand-color); color: #fff; border-color: var(--brand-color);
            box-shadow: 0 8px 15px -5px rgba(0,0,0,0.15); transform: translateY(-2px);
        }

        .color-circle {
            width: 42px; height: 42px; border-radius: 50%; cursor: pointer;
            border: 2px solid #e5e7eb; position: relative; transition: transform 0.2s;
        }
        .color-circle.selected { transform: scale(1.15); border-color: var(--brand-color); }
        .color-circle.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 14px; text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .quantity-control {
            display: flex; align-items: center; justify-content: space-between;
            background: #fff; border-radius: 18px; width: 140px;
            border: 1px solid #f3f4f6; padding: 6px; box-shadow: 0 4px 10px -2px rgba(0,0,0,0.03);
        }
        .qty-btn {
            width: 36px; height: 36px; border: none; border-radius: 12px;
            font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: #f3f4f6; color: #111;
        }
        .qty-btn:active { transform: scale(0.9); background: var(--brand-color); color: #fff; }
        .qty-value { width: 40px; text-align: center; font-weight: 900; font-size: 18px; font-family: 'Vazirmatn'; color: #1f2937; }

        /* --- Inputs --- */
        .input-group { margin-bottom: 18px; position: relative; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--text-light); margin-bottom: 8px; }
        .input-field {
            width: 100%; padding: 14px 16px; border: 2px solid var(--border-color);
            border-radius: 16px; font-family: 'Vazirmatn'; font-size: 13px; font-weight: 600;
            transition: 0.3s; background: #fff; color: var(--text-main);
        }
        .input-field:focus { border-color: var(--brand-color); background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .select-trigger {
            width: 100%; padding: 14px 16px; border: 2px solid var(--border-color);
            border-radius: 16px; font-family: 'Vazirmatn'; font-size: 13px; font-weight: 600;
            background: #fff; color: var(--text-main); display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .select-trigger i { color: #9ca3af; }

        /* --- Searchable Modal --- */
        .search-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .search-modal.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #fff; border-radius: 24px 24px 0 0;
            height: 70vh; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-modal.open .modal-content { transform: translateY(0); }
        .modal-header { padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 900; font-size: 14px; }
        .modal-search-box { padding: 10px 15px; background: #f9fafb; border-bottom: 1px solid #f3f4f6; }
        .modal-search-input { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb; font-family: 'Vazirmatn'; }
        .modal-list { flex: 1; overflow-y: auto; padding: 10px; }
        .modal-item { padding: 12px 15px; border-bottom: 1px solid #f9fafb; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; border-radius: 8px; }
        .modal-item:hover { background: #f3f4f6; }

        /* --- Invoice --- */
        .invoice-ticket {
            background: #fff; border-radius: 24px; overflow: hidden;
            box-shadow: 0 10px 40px -5px rgba(0,0,0,0.1);
            border: 1px solid #f3f4f6; margin-bottom: 24px; position: relative;
        }
        .invoice-ticket::before, .invoice-ticket::after {
            content: ''; position: absolute; top: 60%; width: 20px; height: 20px;
            background: var(--bg-color); border-radius: 50%; z-index: 2;
        }
        .invoice-ticket::before { left: -10px; }
        .invoice-ticket::after { right: -10px; }
        .inv-top-section { padding: 24px; background: #fff; }
        .inv-divider { height: 2px; background-image: linear-gradient(to right, #e5e7eb 50%, transparent 50%); background-size: 10px 100%; position: relative; margin: 0 10px; opacity: 0.5; }
        .inv-bottom-section { padding: 24px; background: #f9fafb; }
        .inv-product-flex { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px; }
        .inv-thumb { width: 70px; height: 70px; border-radius: 16px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
        .inv-row { display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-bottom: 8px; align-items: center; }
        .inv-val { font-weight: 800; color: #111827; }
        .inv-val.discount-text { color: #ef4444; }
        .inv-total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px dashed #e5e7eb; }

        /* --- Success/Receipt --- */
        #invoice-capture-area { position: absolute; top: -9999px; left: -9999px; width: 450px; background: #fff; font-family: 'Vazirmatn', sans-serif; padding: 0; box-sizing: border-box; overflow: hidden; }
        .modern-receipt { background: #fff; border-radius: 0; padding: 40px; position: relative; background-image: radial-gradient(#f3f4f6 1px, transparent 1px); background-size: 20px 20px; }
        .receipt-card { background: #fff; border-radius: 30px; overflow: hidden; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.15); border: 1px solid #eee; }
        .rc-header { background: linear-gradient(135deg, var(--brand-color), #000); padding: 40px 30px 60px; color: white; text-align: center; position: relative; }
        .rc-header::after { content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 40px; background: #fff; border-radius: 50% 50% 0 0; }
        .rc-logo { width: 80px; height: 80px; border-radius: 20px; object-fit: cover; border: 4px solid rgba(255,255,255,0.2); margin: 0 auto 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .rc-body { padding: 10px 30px 30px; position: relative; z-index: 2; }
        .rc-status { background: #dcfce7; color: #15803d; width: fit-content; margin: 0 auto 20px; padding: 10px 30px; border-radius: 50px; font-weight: 900; font-size: 14px; display: flex; items-center; justify-content: center; gap: 8px; border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .rc-details { background: #f9fafb; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #f3f4f6; }
        .rc-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; color: #6b7280; }
        .rc-val { font-weight: 800; color: #1f2937; text-align: left; }
        .rc-barcode { height: 50px; width: 100%; margin: 20px 0 10px; opacity: 0.7; background: repeating-linear-gradient(90deg, #333 0, #333 2px, transparent 2px, transparent 4px, #333 4px, #333 8px, transparent 8px, transparent 9px); }
        .rc-code-text { text-align: center; font-family: monospace; letter-spacing: 4px; font-weight: 700; color: #333; font-size: 14px; }

        .trust-message-box { background: #f0fdf4; border: 1px dashed #bbf7d0; border-radius: 16px; padding: 12px 16px; margin-top: 16px; display: flex; items-start; gap: 10px; }
        .trust-icon-box { color: #16a34a; font-size: 16px; margin-top: 2px; }
        .trust-text-box h5 { font-size: 11px; font-weight: 900; color: #15803d; margin-bottom: 2px; }
        .trust-text-box p { font-size: 9px; font-weight: 600; color: #166534; line-height: 1.4; }

        /* --- Footer --- */
        .footer-actions { padding: 16px 20px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); background: #fff; border-top: 1px solid var(--border-color); display: flex; gap: 12px; flex-shrink: 0; box-shadow: 0 -4px 30px rgba(0,0,0,0.08); z-index: 20; }
        .btn { padding: 16px; border-radius: 16px; font-family: 'Vazirmatn'; font-size: 15px; font-weight: 800; border: none; cursor: pointer; transition: transform 0.2s; flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--brand-color); color: #fff; box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.3); }
        .btn-secondary { background: #f3f4f6; color: var(--text-main); font-weight: 700; flex: 0.35; }
        
        .hidden { display: none !important; }
        
        .badge-discount-lg { background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 900; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); animation: pulse 2s infinite; }
        .stock-warning { color: #d97706; font-size: 10px; font-weight: 800; margin-top: 5px; display: block; }
        .trust-badges-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 24px; margin-bottom: 24px; }
        .trust-badge-minimal { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 12px 8px; border-radius: 16px; background: #f9fafb; border: 1px solid #f3f4f6; transition: 0.2s; }
        .trust-badge-minimal:hover { background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .trust-icon { font-size: 20px; opacity: 0.9; }
        .trust-text { font-size: 10px; font-weight: 800; color: #4b5563; text-align: center; white-space: nowrap; }

        /* --- Loader --- */
        #loading-screen { background: #111; position: fixed; inset: 0; z-index: 200; display: flex; flex-direction: column; items-center; justify-content: center; transition: opacity 0.5s; overflow: hidden; }
        .loader-content { position: relative; z-index: 10; text-align: center; width: 100%; }
        .loader-store-name { font-size: 28px; font-weight: 900; color: #fff; letter-spacing: -1px; text-transform: uppercase; margin-bottom: 5px; opacity: 0; animation: fadeUp 0.8s 0.2s forwards; }
        .loader-status { font-size: 10px; color: #888; letter-spacing: 4px; text-transform: uppercase; font-weight: 700; opacity: 0; animation: fadeUp 0.8s 0.5s forwards; }
        .light-beam { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .beam-line { position: absolute; top: 50%; left: -100%; width: 50%; height: 2px; background: linear-gradient(90deg, transparent, var(--brand-color), #fff, transparent); opacity: 0.8; box-shadow: 0 0 20px var(--brand-color); animation: shootBeam 2s infinite ease-in-out; }
        .powered-by-frame { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 8px 20px; border-radius: 50px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); display: flex; items-center; gap: 8px; opacity: 0; animation: fadeIn 1s 1s forwards; }
        .powered-text { font-size: 9px; color: #888; font-weight: 700; letter-spacing: 1px; }
        .powered-brand { font-size: 10px; color: #fff; font-weight: 900; }
        @keyframes shootBeam { 0% { left: -50%; opacity: 0; } 50% { opacity: 1; } 100% { left: 150%; opacity: 0; } }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(20px); } }
        @keyframes fadeIn { to { opacity: 1; } from { opacity: 0; } }

        /* Digital Delivery Box */
        .digital-delivery-box {
            background: #eef2ff; border: 1px dashed #6366f1; border-radius: 16px;
            padding: 16px; margin: 20px 0; text-align: left; position: relative;
        }
        .dd-title { color: #4338ca; font-size: 12px; font-weight: 800; margin-bottom: 8px; display: flex; items-center; gap: 6px; }
        .dd-content { font-family: monospace; font-size: 12px; color: #312e81; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #c7d2fe; word-break: break-all; }
        .dd-copy-btn { position: absolute; top: 12px; left: 12px; font-size: 10px; color: #6366f1; cursor: pointer; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="light-beam"><div class="beam-line"></div></div>
        <div class="loader-content">
            <h1 class="loader-store-name" id="loader-store-name">STORE LOADING</h1>
            <p class="loader-status">WEBLEGEND ENGINE</p>
        </div>
        <div class="powered-by-frame">
            <span class="powered-text">قدرت گرفته از</span>
            <span class="powered-brand">WEBLEGEND</span>
        </div>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <div id="lightbox-close"><i class="fa-solid fa-times"></i></div>
        <img id="lightbox-img" src="" onclick="event.stopPropagation()">
    </div>

    <div id="search-modal" class="search-modal" onclick="closeSearchModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modal-title-text">انتخاب کنید</span>
                <button onclick="closeSearchModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-times text-gray-500"></i></button>
            </div>
            <div class="modal-search-box"><input type="text" id="modal-search" class="modal-search-input" placeholder="جستجو..." oninput="filterModalList()"></div>
            <div id="modal-list" class="modal-list"></div>
        </div>
    </div>

    <div id="invoice-capture-area">
        <div class="modern-receipt">
            <div class="receipt-card">
                <div class="rc-header" id="rc-header-bg">
                    <img id="rc-logo" src="img/logo01.png" class="rc-logo">
                    <h2 class="text-xl font-black mb-1" id="rc-store-name">فروشگاه شما</h2>
                    <p class="text-[10px] opacity-80 tracking-widest uppercase">Official Digital Receipt</p>
                </div>
                <div class="rc-body">
                    <div class="rc-status"><i class="fa-solid fa-circle-check"></i> پرداخت موفق</div>
                    <div class="rc-details mb-4">
                        <div class="flex items-start gap-4">
                            <img id="rc-prod-img" src="" class="w-16 h-16 rounded-xl object-cover border border-gray-200 shadow-sm flex-shrink-0">
                            <div class="flex flex-col justify-center min-h-[64px]">
                                <h3 class="font-black text-sm text-gray-900 mb-2 leading-tight" id="rc-prod-name">محصول</h3>
                                <div id="rc-prod-meta" class="flex flex-wrap gap-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="rc-details">
                        <div class="rc-row"><span>خریدار</span><span class="rc-val" id="rc-customer">---</span></div>
                        <div class="rc-row"><span>تاریخ</span><span class="rc-val" id="rc-date">---</span></div>
                        <div class="rc-row flex items-center justify-between">
                            <span>مبلغ کل</span>
                            <div class="flex items-baseline gap-1 dir-ltr">
                                <span class="rc-val text-lg text-emerald-600 price-font" id="rc-total-amount">---</span>
                                <span class="text-[10px] text-gray-400 font-bold">تومان</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="rc-digital-section" class="hidden mb-4">
                        <div class="bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                             <p class="text-[10px] font-bold text-gray-500 mb-1">پیام تحویل / لینک دانلود:</p>
                             <p class="text-xs font-mono break-all text-black" id="rc-delivery-note">...</p>
                        </div>
                    </div>

                    <div class="rc-barcode"></div>
                    <div class="rc-code-text" id="rc-code">ORD-123456</div>
                    <div class="text-center mt-4 pt-4 border-t border-dashed border-gray-200">
                        <p class="text-[10px] text-gray-400 font-bold mb-1">از خرید شما سپاسگزاریم ❤️</p>
                        <p class="text-[9px] text-gray-300 font-mono" id="rc-link">weblegend.ir</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container hidden" id="main-app">
        <header class="app-header">
            <div class="brand-identity">
                <img src="" id="brand-logo" class="brand-logo-img hidden">
                <span class="brand-name" id="brand-name">فروشگاه آنلاین</span>
            </div>
            <div class="stepper">
                <div class="step-item active" id="step-indicator-1">
                    <div class="step-circle"><i class="fa-solid fa-bag-shopping"></i></div>
                    <span class="step-label">انتخاب</span>
                </div>
                <div class="step-item" id="step-indicator-2">
                    <div class="step-circle"><i class="fa-solid fa-clipboard-user"></i></div>
                    <span class="step-label">اطلاعات</span>
                </div>
                <div class="step-item" id="step-indicator-3">
                    <div class="step-circle"><i class="fa-solid fa-credit-card"></i></div>
                    <span class="step-label">پرداخت</span>
                </div>
            </div>
        </header>

        <main class="content-area">
            <section class="step-panel active-panel" id="panel-1">
                <div class="gallery-container" onclick="openLightbox()">
                    <div class="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full text-xs z-10 pointer-events-none backdrop-blur-sm"><i class="fa-solid fa-expand"></i></div>
                    <div class="gallery-nav nav-next" onclick="event.stopPropagation(); nextImage()"><i class="fa-solid fa-chevron-left"></i></div>
                    <div id="gallery-wrapper" class="w-full h-full relative"></div>
                    <div class="gallery-nav nav-prev" onclick="event.stopPropagation(); prevImage()"><i class="fa-solid fa-chevron-right"></i></div>
                    <div class="gallery-dots" id="gallery-dots"></div>
                </div>

                <div id="product-content" class="px-5 pb-5 opacity-0 transition-opacity duration-500">
                    <div class="flex items-end justify-between mb-4 pb-4 border-b border-gray-100">
                        <div>
                             <span id="product-cat" class="text-[9px] bg-gray-100 px-2 py-1 rounded-md text-gray-500 font-bold mb-2 inline-block">دسته‌بندی</span>
                             <div id="price-display-area"></div>
                        </div>
                        <div class="text-left">
                            <span class="text-[10px] text-gray-400 font-bold">قیمت نهایی</span>
                        </div>
                    </div>
                    <h1 class="text-xl font-black text-gray-900 mb-4 leading-snug" id="product-name">...</h1>
                    <div class="modern-desc-box">
                        <div class="desc-header"><i class="fa-solid fa-align-right"></i><span>توضیحات و جزئیات</span></div>
                        <div class="desc-content-wrapper" id="desc-wrapper">
                            <p class="desc-text" id="product-desc">...</p>
                            <div class="desc-fade-overlay"></div>
                        </div>
                        <div class="desc-action-btn" onclick="toggleDescription()">
                            <span id="desc-toggle-text">مشاهده کامل توضیحات</span>
                            <i class="fa-solid fa-chevron-down" id="desc-toggle-icon"></i>
                        </div>
                    </div>
                    <div id="dynamic-options-container" class="mb-8 space-y-2"></div>
                    <div class="mb-6 flex items-center justify-between bg-gray-50 p-4 rounded-2xl border border-gray-100">
                        <div><span class="option-title mb-0">تعداد:</span><span id="stock-warning" class="stock-warning hidden"></span></div>
                        <div class="quantity-control">
                            <button class="qty-btn" onclick="updateQty(1)"><i class="fa-solid fa-plus"></i></button>
                            <span class="qty-value price-font" id="qty-display">1</span>
                            <button class="qty-btn" onclick="updateQty(-1)"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="step-panel" id="panel-2">
                <div class="px-2 pt-2">
                    <div class="bg-blue-50 text-blue-700 text-xs font-bold p-3 rounded-xl mb-4 flex items-center gap-2 hidden" id="digital-notice">
                        <i class="fa-solid fa-cloud-arrow-down"></i>
                        <span>این یک محصول دانلودی است. نیازی به آدرس نیست.</span>
                    </div>

                    <div class="input-group">
                        <label>نام و نام خانوادگی</label>
                        <input type="text" id="input-name" class="input-field" placeholder="مثلا: علی محمدی">
                    </div>
                    <div class="input-group">
                        <label>شماره موبایل (جهت ارسال سفارش)</label>
                        <input type="tel" inputmode="numeric" id="input-mobile" class="input-field text-left dir-ltr font-mono tracking-widest" placeholder="0912..." maxlength="11">
                    </div>
                    
                    <div id="shipping-fields">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="input-group">
                                <label>استان</label>
                                <div class="select-trigger" onclick="openSearchModal('province')">
                                    <span id="display-province">انتخاب کنید</span>
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </div>
                                <input type="hidden" id="input-province">
                            </div>
                            <div class="input-group">
                                <label>شهر</label>
                                <div class="select-trigger opacity-50" id="city-trigger" onclick="openSearchModal('city')">
                                    <span id="display-city">انتخاب کنید</span>
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </div>
                                <input type="hidden" id="input-city">
                            </div>
                        </div>
                        <div class="input-group hidden" id="manual-city-group">
                            <label>نام شهر خود را بنویسید</label>
                            <input type="text" id="input-city-manual" class="input-field" placeholder="نام شهر...">
                        </div>
                        <div class="input-group">
                            <label>آدرس دقیق</label>
                            <textarea id="input-address" class="input-field" rows="2" placeholder="خیابان، کوچه، پلاک، واحد..."></textarea>
                        </div>
                        <div class="input-group">
                            <label>کد پستی (۱۰ رقمی)</label>
                            <input type="tel" inputmode="numeric" id="input-postal" class="input-field text-left dir-ltr font-mono tracking-widest" placeholder="1234567890" maxlength="10">
                        </div>
                    </div>
                </div>
            </section>

            <section class="step-panel" id="panel-3">
                <div id="invoice-view">
                    <div class="invoice-ticket">
                        <div class="inv-top-section">
                            <div class="inv-product-flex">
                                <img id="summ-img" src="" class="inv-thumb">
                                <div>
                                    <h4 id="summ-name" class="font-black text-sm text-gray-900 line-clamp-2 mb-2">نام محصول</h4>
                                    <div class="flex flex-wrap gap-1" id="summ-meta"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 space-y-2">
                                <div class="inv-row"><span>مبلغ محصول (×<span id="summ-qty">1</span>)</span><span class="inv-val price-font" id="summ-product-total">0</span></div>
                                <div class="inv-row hidden" id="inv-discount-row"><span>تخفیف</span><span class="inv-val price-font discount-text" id="summ-discount">0</span></div>
                                <div class="inv-row" id="inv-shipping-row"><span>هزینه ارسال</span><span class="inv-val price-font" id="summ-shipping">0</span></div>
                            </div>
                        </div>
                        <div class="inv-divider"></div>
                        <div class="inv-bottom-section">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-3">اطلاعات خریدار</p>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></div>
                                    <div>
                                        <div class="text-xs font-bold text-gray-800" id="summ-customer-name">...</div>
                                        <div class="text-[10px] text-gray-400 font-mono" id="summ-customer-phone">...</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3" id="summ-address-box">
                                    <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center text-xs flex-shrink-0"><i class="fa-solid fa-location-dot"></i></div>
                                    <div class="text-[10px] font-bold text-gray-600 leading-relaxed mt-1" id="summ-customer-address">...</div>
                                </div>
                            </div>
                            <div class="inv-total-row">
                                <span class="font-black text-gray-900 text-sm">مبلغ قابل پرداخت</span>
                                <span class="text-xl font-black price-font" style="color: var(--brand-color)" id="summ-final-total">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trust-message-box">
                        <div class="trust-icon-box"><i class="fa-solid fa-shield-check"></i></div>
                        <div class="trust-text-box">
                            <h5>تضمین خرید امن</h5>
                            <p id="trust-msg-text">بعد از پرداخت، رسید دیجیتال و کد رهگیری پستی به صورت پیامک برای شما ارسال می‌شود.</p>
                        </div>
                    </div>
                </div>

                <div id="success-view" class="hidden text-center py-10 animate-fade-in relative">
                    <div class="w-24 h-24 rounded-full flex items-center justify-center text-white text-4xl mx-auto mb-6 shadow-2xl shadow-green-200 transform hover:scale-110 transition" style="background: #10b981;">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="text-2xl font-black text-gray-900 mb-2">سفارش ثبت شد!</h2>
                    <p class="text-gray-500 text-xs mb-8 leading-relaxed px-8">سفارش شما با موفقیت در سیستم ثبت گردید.</p>
                    
                    <div id="success-digital-delivery" class="hidden px-4 mb-4">
                        <div class="digital-delivery-box">
                            <div class="dd-title"><i class="fa-solid fa-box-open"></i> محموله دیجیتال شما</div>
                            <div class="dd-content" id="success-delivery-note">...</div>
                            <div class="dd-copy-btn" onclick="copyDeliveryNote()"><i class="fa-regular fa-copy"></i> کپی</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-5 mb-6 mx-4 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-green-100 text-green-600 text-[9px] px-2 py-1 rounded-bl-lg font-bold">پرداخت موفق</div>
                        <div class="flex justify-between text-xs mb-3 mt-1">
                            <span class="text-gray-500 font-bold">کد پیگیری:</span>
                            <span class="font-mono font-black text-gray-900 text-lg tracking-widest" id="tracking-code-display">---</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3 px-4">
                        <button onclick="downloadInvoice()" class="w-full bg-brand-color/10 text-brand-color border border-brand-color font-bold py-3 rounded-xl hover:bg-brand-color/20 transition flex items-center justify-center gap-2 text-sm">
                            <i class="fa-solid fa-download"></i><span>دانلود رسید خرید</span>
                        </button>
                        <button onclick="goBackToStore()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition flex items-center justify-center gap-2">
                            <span>بازگشت به فروشگاه</span><i class="fa-solid fa-store"></i>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer-actions" id="footer-actions">
            <button class="btn btn-secondary hidden" id="btn-back" onclick="prevStep()"><i class="fa-solid fa-arrow-right"></i></button>
            <button class="btn btn-primary" id="btn-next" onclick="nextStep()">
                <span id="btn-next-text">تایید و ادامه</span>
                <i class="fa-solid fa-arrow-left" id="btn-next-icon"></i>
            </button>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let productData = null;
        let sellerProfile = null;
        let productImages = [];
        let currentImgIndex = 0;
        let selectedOptions = {}; 
        let orderQty = 1;
        let currentStep = 1;
        let shippingCost = 0;
        let activeModalType = null;
        let finalCalculatedPrice = 0;
        
        // V2.0 State
        let currentVariantPrice = null;
        let isDigital = false;
        let variantPricesMap = {};

        const locations = { "تهران": ["تهران", "اسلامشهر", "شهریار"], "البرز": ["کرج", "فردیس"], "اصفهان": ["اصفهان", "کاشان"], "فارس": ["شیراز", "مرودشت"], "خراسان رضوی": ["مشهد", "نیشابور"], "آذربایجان شرقی": ["تبریز"], "مازندران": ["ساری", "بابل"], "خوزستان": ["اهواز"], "گیلان": ["رشت"], "سایر": ["سایر"] };

        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) { document.getElementById('loading-screen').innerHTML = '<div class="text-white font-bold px-4 text-center text-sm">لینک معتبر نیست</div>'; return; }

            try {
                const { data: prod, error } = await supabase.from('store_products').select('*').eq('id', productId).single();
                if (error || !prod) throw new Error("محصول یافت نشد.");
                productData = prod;
                
                // V2.0: Check Type & Variant Prices
                isDigital = (prod.type === 'digital');
                variantPricesMap = prod.variant_prices || {};
                if(isDigital) setupDigitalMode();

                const { data: profile } = await supabase.from('store_profiles').select('*').eq('user_id', productData.user_id).single();
                sellerProfile = profile;

                applyTheme(sellerProfile);
                try { productImages = JSON.parse(prod.image); if(!Array.isArray(productImages)) productImages = [prod.image]; } catch(e) { productImages = [prod.image || 'img/logo01.png']; }

                renderPage(prod);
                const loader = document.getElementById('loading-screen');
                setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; document.getElementById('main-app').classList.remove('hidden'); }, 500); }, 1500);

            } catch (err) { document.getElementById('loading-screen').innerHTML = `<div class="text-red-500 font-bold px-4 text-center text-sm">${err.message}</div>`; }
        }

        function setupDigitalMode() {
            // UI adjustments for digital products
            document.getElementById('shipping-fields').classList.add('hidden');
            document.getElementById('digital-notice').classList.remove('hidden');
            document.getElementById('inv-shipping-row').classList.add('hidden');
            document.getElementById('summ-address-box').classList.add('hidden');
            document.getElementById('trust-msg-text').innerText = "بعد از پرداخت، لینک دانلود یا اطلاعات سرویس فوراً نمایش داده می‌شود.";
            
            // Stepper Icon Change
            document.querySelector('#step-indicator-2 i').className = 'fa-solid fa-user-check';
        }

        window.openSearchModal = (type) => { activeModalType = type; document.getElementById('search-modal').classList.add('open'); renderModalList(type === 'province' ? Object.keys(locations) : (locations[document.getElementById('input-province').value] || [])); };
        function renderModalList(list) { const c = document.getElementById('modal-list'); c.innerHTML = ''; list.forEach(i => { const d = document.createElement('div'); d.className = 'modal-item'; d.innerText = i; d.onclick = () => { setSelection(activeModalType, i); document.getElementById('search-modal').classList.remove('open'); }; c.appendChild(d); }); }
        window.closeSearchModal = () => document.getElementById('search-modal').classList.remove('open');
        function setSelection(t, v) { document.getElementById(`input-${t}`).value = v; document.getElementById(`display-${t}`).innerText = v; document.getElementById(`display-${t}`).style.color='#111'; if(t==='province'){ document.getElementById('city-trigger').classList.remove('opacity-50'); } }

        function calculateShipping() {
            if(isDigital) return 0;
            const province = document.getElementById('input-province').value;
            let base = Number(productData.shipping_cost || 0);
            return (province === 'تهران') ? base : base + 15000;
        }

        function applyTheme(p) { if(p){ if(p.theme_color) document.documentElement.style.setProperty('--brand-color', p.theme_color); if(p.store_name){ document.getElementById('brand-name').innerText=p.store_name; document.getElementById('loader-store-name').innerText=p.store_name; } if(p.store_logo) document.getElementById('brand-logo').src=p.store_logo; } }

        function renderPage(p) {
            document.getElementById('product-content').classList.remove('opacity-0');
            document.getElementById('product-name').innerText = p.name;
            document.getElementById('product-cat').innerText = p.category || 'عمومی';
            document.getElementById('product-desc').innerText = p.description || 'توضیحات تکمیلی ثبت نشده است.';
            
            // Custom CTA Text
            if(p.cta_text) document.getElementById('btn-next-text').innerText = p.cta_text;

            updatePriceDisplay();
            updateGallery();
            renderDynamicOptions(p.attributes);
        }

        function updatePriceDisplay() {
            const basePrice = currentVariantPrice !== null ? currentVariantPrice : productData.price;
            const priceContainer = document.getElementById('price-display-area');
            
            if (productData.discount_info && productData.discount_info.active && productData.discount_info.percent > 0) {
                const discountedPrice = basePrice - (basePrice * productData.discount_info.percent / 100);
                priceContainer.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs text-gray-400 line-through decoration-red-400 decoration-1">${new Intl.NumberFormat('en-US').format(basePrice)}</span>
                        <span class="badge-discount-lg">${productData.discount_info.percent}% تخفیف</span>
                    </div>
                    <span class="text-3xl font-black text-gray-900 leading-none tracking-tight price-font text-emerald-600">${new Intl.NumberFormat('en-US').format(discountedPrice)} <span class="text-xs text-gray-400 font-bold">تومان</span></span>`;
            } else {
                priceContainer.innerHTML = `<span class="text-3xl font-black text-gray-900 leading-none tracking-tight price-font" style="color: var(--brand-color)">${new Intl.NumberFormat('en-US').format(basePrice)} <span class="text-xs text-gray-400 font-bold">تومان</span></span>`;
            }
        }

        function renderDynamicOptions(attributes) {
            const container = document.getElementById('dynamic-options-container'); container.innerHTML = '';
            if (!attributes) return;

            Object.keys(attributes).forEach(key => {
                const values = attributes[key];
                if (!values || values.length === 0) return;
                
                const section = document.createElement('div'); section.className = 'option-section';
                const title = document.createElement('span'); title.className = 'option-title';
                title.innerText = `${key}:`; section.appendChild(title);
                const wrapper = document.createElement('div');

                const isColor = values[0].startsWith('#') && (values[0].length === 4 || values[0].length === 7);
                if (isColor) wrapper.className = 'flex gap-3 flex-wrap'; else wrapper.className = 'flex gap-2 flex-wrap';

                values.forEach((val, idx) => {
                    const el = document.createElement('div');
                    if(isColor) {
                        el.className = 'color-circle'; el.style.backgroundColor = val;
                        if(val.toLowerCase()==='#ffffff') el.style.border='1px solid #ccc';
                    } else {
                        el.className = 'chip'; el.innerText = val;
                    }
                    
                    if(idx === 0) { 
                        el.classList.add('selected'); selectedOptions[key] = val;
                        // Check initial variant price
                        checkVariantPrice(key, val);
                    }

                    el.onclick = () => {
                        Array.from(wrapper.children).forEach(c => c.classList.remove('selected'));
                        el.classList.add('selected');
                        selectedOptions[key] = val;
                        checkVariantPrice(key, val);
                    };
                    wrapper.appendChild(el);
                });
                section.appendChild(wrapper); container.appendChild(section);
            });
        }

        function checkVariantPrice(key, val) {
            // V2 Logic: Check if "key:val" exists in variant_prices
            const lookupKey = `${key}:${val}`; // e.g., "colors:#000000" or "sizes:XL"
            if (variantPricesMap && variantPricesMap[lookupKey]) {
                currentVariantPrice = parseInt(variantPricesMap[lookupKey]);
            } else {
                // If checking this key didn't yield a price, we shouldn't reset IF another attribute set the price.
                // Simplified MVP: Reset to null (base price) if not found for THIS click.
                // Ideally we check all selected options.
                let foundPrice = null;
                for (const [k, v] of Object.entries(selectedOptions)) {
                    const combined = `${k}:${v}`;
                    if(variantPricesMap[combined]) foundPrice = parseInt(variantPricesMap[combined]);
                }
                currentVariantPrice = foundPrice;
            }
            updatePriceDisplay();
        }

        window.updateQty = (n) => {
            const next = orderQty + n;
            if (productData.inventory_type === 'managed' && n > 0 && next > productData.stock_quantity) { showToast('موجودی کافی نیست', 'error'); return; }
            if(next > 0) orderQty = next; document.getElementById('qty-display').innerText = orderQty;
        };

        window.nextStep = () => {
            if (currentStep === 1) {
                if(productData.inventory_type === 'managed' && productData.stock_quantity <= 0) return showToast('ناموجود', 'error');
                goToStep(2);
            } else if (currentStep === 2) {
                if (!validateInfo()) return;
                shippingCost = calculateShipping();
                updateSummary();
                goToStep(3);
                document.getElementById('btn-next-text').innerText = 'پرداخت امن';
                document.getElementById('btn-next-icon').className = 'fa-solid fa-lock';
            } else if (currentStep === 3) {
                submitOrder();
            }
        };
        window.prevStep = () => { if(currentStep > 1) { goToStep(currentStep - 1); if(currentStep===2) { document.getElementById('btn-next-text').innerText = 'تایید و ادامه'; document.getElementById('btn-next-icon').className='fa-solid fa-arrow-left'; } } };

        function goToStep(s) {
            document.querySelectorAll('.step-panel').forEach(p => { p.classList.remove('active-panel'); p.style.opacity='0'; p.style.transform='translateX(50px)'; });
            const n = document.getElementById(`panel-${s}`); n.classList.add('active-panel'); setTimeout(()=> { n.style.opacity='1'; n.style.transform='translateX(0)'; }, 50);
            document.querySelectorAll('.step-item').forEach((i,x) => { i.classList.remove('active','completed'); if(x+1===s) i.classList.add('active'); if(x+1<s) i.classList.add('completed'); });
            currentStep = s; document.getElementById('btn-back').classList.toggle('hidden', s===1);
        }

        function validateInfo() {
            const name = document.getElementById('input-name').value.trim();
            const mobile = document.getElementById('input-mobile').value.trim();
            if (!name || !mobile) { showToast("نام و موبایل الزامی است", "error"); return false; }
            if (mobile.length < 10) { showToast("موبایل نامعتبر", "error"); return false; }
            
            if(!isDigital) {
                const prov = document.getElementById('input-province').value;
                const city = document.getElementById('input-city').value;
                const addr = document.getElementById('input-address').value.trim();
                if (!prov || !city || !addr) { showToast("آدرس کامل الزامی است", "error"); return false; }
            }
            return true;
        }

        function updateSummary() {
            const base = currentVariantPrice !== null ? currentVariantPrice : productData.price;
            let finalUnit = base;
            if (productData.discount_info?.active) finalUnit = base - (base * productData.discount_info.percent / 100);

            const totalProd = finalUnit * orderQty;
            finalCalculatedPrice = totalProd + shippingCost; 

            document.getElementById('summ-img').src = productImages[0];
            document.getElementById('summ-name').innerText = productData.name;
            document.getElementById('summ-qty').innerText = orderQty;
            document.getElementById('summ-product-total').innerText = new Intl.NumberFormat('en-US').format(totalProd);
            document.getElementById('summ-shipping').innerText = new Intl.NumberFormat('en-US').format(shippingCost);
            document.getElementById('summ-final-total').innerText = new Intl.NumberFormat('en-US').format(finalCalculatedPrice) + ' تومان';
            document.getElementById('summ-customer-name').innerText = document.getElementById('input-name').value;
            
            // Receipt
            document.getElementById('rc-customer').innerText = document.getElementById('input-name').value;
            document.getElementById('rc-prod-name').innerText = productData.name;
            document.getElementById('rc-prod-img').src = productImages[0];
            document.getElementById('rc-total-amount').innerText = new Intl.NumberFormat('en-US').format(finalCalculatedPrice);

            const metaContainer = document.getElementById('summ-meta'); metaContainer.innerHTML = '';
            const rcMeta = document.getElementById('rc-prod-meta'); rcMeta.innerHTML = '';
            
            for (const [k, v] of Object.entries(selectedOptions)) {
                const h = v.startsWith('#') ? `<div style="background:${v};width:12px;height:12px;border-radius:50%;border:1px solid #ccc"></div>` : `<span class="text-[9px] bg-gray-100 px-1 rounded">${v}</span>`;
                metaContainer.innerHTML += h; rcMeta.innerHTML += h;
            }
        }

        async function submitOrder() {
            const btn = document.getElementById('btn-next'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال پردازش...'; btn.disabled = true;
            try {
                const fullAddress = isDigital ? 'محصول دانلودی' : `${document.getElementById('input-province').value}، ${document.getElementById('input-city').value}، ${document.getElementById('input-address').value}`;
                
                // --- SECURITY: Sending total_price: 0 to let Server Trigger calculate real price ---
                const { data, error } = await supabase.from('store_orders').insert([{
                    product_id: productData.id,
                    seller_id: productData.user_id,
                    customer_name: document.getElementById('input-name').value,
                    customer_phone: document.getElementById('input-mobile').value,
                    customer_address: fullAddress,
                    customer_postal_code: isDigital ? '0000000000' : document.getElementById('input-postal').value,
                    quantity: orderQty,
                    selected_options: selectedOptions,
                    status: 'paid',
                    total_price: 0 
                }]).select();

                if (error) {
                     if (error.message.includes('Stock')) throw new Error("موجودی تمام شد!");
                     throw error;
                }

                // Success
                document.getElementById('invoice-view').classList.add('hidden');
                document.getElementById('footer-actions').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                
                const order = data[0];
                document.getElementById('tracking-code-display').innerText = order.tracking_code || `ORD-${order.id}`;
                document.getElementById('rc-code').innerText = order.tracking_code || `ORD-${order.id}`;
                document.getElementById('rc-total-amount').innerText = new Intl.NumberFormat('en-US').format(order.total_price); // Server Price

                // Digital Delivery Note Logic
                if(isDigital && productData.delivery_note) {
                    document.getElementById('success-digital-delivery').classList.remove('hidden');
                    document.getElementById('success-delivery-note').innerText = productData.delivery_note;
                    document.getElementById('rc-digital-section').classList.remove('hidden');
                    document.getElementById('rc-delivery-note').innerText = productData.delivery_note;
                }

                fireConfetti();

            } catch (err) { showToast(err.message, "error"); btn.innerHTML = 'تلاش مجدد'; btn.disabled = false; }
        }

        window.copyDeliveryNote = () => { navigator.clipboard.writeText(document.getElementById('success-delivery-note').innerText); showToast('کپی شد'); };
        window.downloadInvoice = () => {
             const area = document.getElementById('invoice-capture-area');
             document.getElementById('rc-date').innerText = new Date().toLocaleDateString('fa-IR');
             html2canvas(area, {scale:3}).then(c => { const a=document.createElement('a'); a.download='Receipt.png'; a.href=c.toDataURL(); a.click(); });
        };
        window.goBackToStore = () => window.location.href = `store.html?id=${productData.user_id}`;
        function fireConfetti() { const c=200,d={origin:{y:0.7}}; function f(r,o){confetti(Object.assign({},d,o,{particleCount:Math.floor(c*r)}))} f(0.25,{spread:26,startVelocity:55}); f(0.2,{spread:60}); }
        
        // Gallery
        window.updateGallery = () => { const w=document.getElementById('gallery-wrapper'); w.innerHTML=''; productImages.forEach((u,i)=>{ const m=document.createElement('img'); m.src=u; m.className=`gallery-img ${i===currentImgIndex?'active':'inactive'}`; w.appendChild(m); }); document.getElementById('lightbox-img').src=productImages[currentImgIndex]; };
        window.nextImage = () => { currentImgIndex=(currentImgIndex+1)%productImages.length; updateGallery(); };
        window.prevImage = () => { currentImgIndex=(currentImgIndex-1+productImages.length)%productImages.length; updateGallery(); };
        window.openLightbox = () => document.getElementById('lightbox').classList.add('open');
        window.closeLightbox = () => document.getElementById('lightbox').classList.remove('open');
        window.toggleDescription = () => { const w=document.getElementById('desc-wrapper'); w.classList.toggle('expanded'); document.getElementById('desc-toggle-text').innerText = w.classList.contains('expanded')?'بستن توضیحات':'مشاهده کامل'; };
        function showToast(m,t='success'){ Toastify({text:m,duration:3000,gravity:"top",style:{background:t==='success'?(sellerProfile?.theme_color||"#10B981"):"#EF4444",borderRadius:"12px"}}).showToast(); }

        initPage();
    </script>
</body>
</html>