<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>فرماندهی کل | WebLegend God Mode</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        god: { 
                            gold: '#D4AF37', 
                            goldHover: '#F9E59E', 
                            black: '#050505', 
                            panel: '#0F0F0F',
                            surface: '#181818',
                            danger: '#EF4444',
                            success: '#10B981'
                        } 
                    },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-gold': 'pulseGold 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGold: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(212, 175, 55, 0.1)' }, '50%': { boxShadow: '0 0 0 10px rgba(212, 175, 55, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body { background-color: #000; color: #e5e5e5; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }
        
        /* Glass Components */
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .nav-item {
            position: relative; transition: all 0.3s ease;
            border-right: 2px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(90deg, rgba(212,175,55,0.1) 0%, transparent 100%);
            color: #D4AF37;
        }
        .nav-item.active { border-right-color: #D4AF37; }
        .nav-item.active i { transform: scale(1.1); text-shadow: 0 0 10px rgba(212,175,55,0.5); }

        /* Custom Inputs */
        .god-input {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: white; transition: all 0.3s;
        }
        .god-input:focus { border-color: #D4AF37; box-shadow: 0 0 15px rgba(212,175,55,0.1); }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #D4AF37; margin-top: -6px; cursor: pointer; box-shadow: 0 0 10px rgba(212,175,55,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #333; border-radius: 2px;
        }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }
        .st-pending { background: rgba(234, 179, 8, 0.1); color: #fbbf24; border: 1px solid rgba(234, 179, 8, 0.2); }
        .st-active { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .st-done { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="flex h-screen font-sans">

    <div id="login-gate" class="fixed inset-0 z-[100] bg-black flex items-center justify-center">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none"></div>
        <div class="w-full max-w-md p-8 glass-panel rounded-3xl relative overflow-hidden animate-slide-up">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-god-gold to-transparent"></div>
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-tr from-god-gold to-yellow-700 rounded-full mx-auto flex items-center justify-center text-4xl text-black font-black shadow-[0_0_30px_rgba(212,175,55,0.3)] mb-4">W</div>
                <h1 class="text-2xl font-black text-white tracking-tighter">WEB <span class="text-god-gold">LEGEND</span></h1>
                <p class="text-xs text-gray-500 uppercase tracking-[0.3em] mt-1">Command Center</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Admin Identity" class="w-full p-4 rounded-xl god-input text-center font-mono placeholder-gray-600 outline-none text-sm" required>
                <input type="password" id="password" placeholder="Access Key" class="w-full p-4 rounded-xl god-input text-center font-mono placeholder-gray-600 outline-none text-sm" required>
                <button type="submit" id="login-btn" class="w-full py-4 bg-god-gold hover:bg-white text-black font-black rounded-xl transition duration-300 shadow-[0_0_20px_rgba(212,175,55,0.2)] hover:shadow-[0_0_30px_rgba(255,255,255,0.4)] flex items-center justify-center gap-2">
                    <i class="fas fa-fingerprint"></i> ورود امن
                </button>
            </form>
            <p class="text-[9px] text-center text-gray-600 mt-6 font-mono">RESTRICTED ACCESS // LEVEL 99</p>
        </div>
    </div>

    <aside class="w-20 lg:w-64 bg-god-panel border-l border-white/5 flex flex-col z-20 transition-all duration-300 hidden" id="main-sidebar">
        <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-white/5">
            <div class="w-10 h-10 bg-god-gold rounded-xl flex items-center justify-center text-black font-black text-xl shadow-lg shadow-god-gold/20">W</div>
            <div class="hidden lg:block mr-3">
                <h2 class="font-bold text-sm text-white">پنل مدیریت</h2>
                <p class="text-[9px] text-god-gold uppercase">God Mode</p>
            </div>
        </div>
        
        <nav class="flex-1 py-6 space-y-2 px-2">
            <button onclick="switchView('dashboard')" class="nav-item active w-full p-4 lg:px-6 rounded-xl flex items-center justify-center lg:justify-start gap-4 text-gray-400">
                <i class="fas fa-chart-line text-lg w-6 text-center"></i> <span class="hidden lg:block text-sm font-bold">داشبورد</span>
            </button>
            <div class="px-6 mt-4 mb-2 hidden lg:block"><p class="text-[10px] text-gray-600 font-bold uppercase tracking-wider">سرویس‌ها</p></div>
            <button onclick="switchView('projects')" class="nav-item w-full p-4 lg:px-6 rounded-xl flex items-center justify-center lg:justify-start gap-4 text-gray-400">
                <i class="fas fa-layer-group text-lg w-6 text-center"></i> <span class="hidden lg:block text-sm font-bold">پروژه‌ها</span>
            </button>
            <div class="px-6 mt-4 mb-2 hidden lg:block"><p class="text-[10px] text-gray-600 font-bold uppercase tracking-wider">پلتفرم</p></div>
            <button onclick="switchView('users')" class="nav-item w-full p-4 lg:px-6 rounded-xl flex items-center justify-center lg:justify-start gap-4 text-gray-400">
                <i class="fas fa-users text-lg w-6 text-center"></i> <span class="hidden lg:block text-sm font-bold">فروشگاه‌ها</span>
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <button onclick="logout()" class="w-full py-3 rounded-xl bg-white/5 hover:bg-god-danger/10 text-gray-400 hover:text-god-danger transition flex items-center justify-center gap-2">
                <i class="fas fa-power-off"></i> <span class="hidden lg:block text-xs font-bold">خروج اضطراری</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 bg-black relative flex flex-col h-full overflow-hidden hidden" id="main-content">
        <header class="h-20 border-b border-white/5 flex items-center justify-between px-6 lg:px-10 bg-god-panel/50 backdrop-blur-md sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-black text-white" id="page-title">داشبورد فرماندهی</h2>
                <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                    <span class="w-2 h-2 bg-god-gold rounded-full"></span>
                    <span class="text-xs font-mono text-gray-300" id="server-time">--:--</span>
                </div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-b from-gray-700 to-black border border-white/10 overflow-hidden">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Admin" class="w-full h-full object-cover opacity-80">
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 lg:p-10 scroll-smooth relative" id="content-scroll">
            
            <div id="view-dashboard" class="space-y-6 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-god-gold/10 rounded-full blur-2xl group-hover:bg-god-gold/20 transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase">درآمد کل (تخمینی)</p>
                                <h3 class="text-2xl font-black text-white mt-1 font-mono" id="dash-revenue">...</h3>
                            </div>
                            <i class="fas fa-coins text-god-gold text-2xl"></i>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div class="bg-god-gold h-full w-[70%]"></div></div>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase">پروژه‌های فعال</p>
                                <h3 class="text-2xl font-black text-white mt-1 font-mono" id="dash-active-projects">...</h3>
                            </div>
                            <i class="fas fa-briefcase text-blue-500 text-2xl"></i>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div class="bg-blue-500 h-full w-[45%]"></div></div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase">فروشگاه‌ها</p>
                                <h3 class="text-2xl font-black text-white mt-1 font-mono" id="dash-stores">...</h3>
                            </div>
                            <i class="fas fa-store text-purple-500 text-2xl"></i>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div class="bg-purple-500 h-full w-[30%]"></div></div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-red-500/10 rounded-full blur-2xl group-hover:bg-red-500/20 transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase">سفارشات پلتفرم</p>
                                <h3 class="text-2xl font-black text-white mt-1 font-mono" id="dash-total-orders">...</h3>
                            </div>
                            <i class="fas fa-shopping-basket text-red-500 text-2xl"></i>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div class="bg-red-500 h-full w-[60%]"></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass-panel p-6 rounded-2xl border border-white/5">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-white flex items-center gap-2"><i class="fas fa-chart-area text-god-gold"></i> جریان نقدینگی</h3>
                            <select class="bg-black border border-white/10 rounded-lg text-xs px-2 py-1 text-gray-400 outline-none">
                                <option>ماهانه</option>
                                <option>سالانه</option>
                            </select>
                        </div>
                        <div class="h-[300px] w-full">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-2xl border border-white/5 flex flex-col">
                        <h3 class="font-bold text-white mb-4">وضعیت سیستم</h3>
                        <div class="space-y-4 flex-1">
                            <div class="bg-white/5 p-4 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-xs font-bold text-gray-300">Database</span>
                                </div>
                                <span class="text-xs text-green-500 font-mono">ONLINE</span>
                            </div>
                            <div class="bg-white/5 p-4 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-xs font-bold text-gray-300">Storage</span>
                                </div>
                                <span class="text-xs text-green-500 font-mono">HEALTHY</span>
                            </div>
                            <div class="bg-white/5 p-4 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-xs font-bold text-gray-300">Auth System</span>
                                </div>
                                <span class="text-xs text-green-500 font-mono">SECURE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-projects" class="hidden space-y-6 animate-slide-up">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-black text-white">پروژه‌های آژانس</h2>
                        <p class="text-xs text-gray-500 mt-1">مدیریت سفارشات طراحی سایت، سئو و توسعه اختصاصی</p>
                    </div>
                    <button onclick="openProjectModal()" class="bg-god-gold hover:bg-white text-black px-6 py-3 rounded-xl font-black text-sm shadow-lg shadow-god-gold/20 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> پروژه جدید
                    </button>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-white/5 text-xs text-gray-400 font-bold uppercase border-b border-white/5">
                                <tr>
                                    <th class="p-5">مشتری</th>
                                    <th class="p-5">نوع پروژه</th>
                                    <th class="p-5">وضعیت</th>
                                    <th class="p-5">پیشرفت</th>
                                    <th class="p-5">مالی</th>
                                    <th class="p-5 text-center">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="projects-table-body" class="divide-y divide-white/5 text-sm text-gray-300">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-users" class="hidden space-y-6 animate-slide-up">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-black text-white">امپراتوری فروشگاه‌ها</h2>
                        <p class="text-xs text-gray-500 mt-1">لیست تمام کاربرانی که فروشگاه ساخته‌اند</p>
                    </div>
                    <div class="bg-white/5 px-4 py-2 rounded-xl border border-white/5">
                        <input type="text" placeholder="جستجوی فروشگاه..." class="bg-transparent border-none outline-none text-xs text-white w-40 md:w-64 placeholder-gray-600 font-bold">
                        <i class="fas fa-search text-gray-600"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="stores-grid">
                    </div>
            </div>

        </div>
    </main>

    <div id="project-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-god-surface w-full max-w-lg rounded-3xl border border-white/10 shadow-2xl relative animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-god-panel rounded-t-3xl">
                <h3 class="text-lg font-black text-white" id="modal-title">ثبت پروژه جدید</h3>
                <button onclick="closeProjectModal()" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="project-form" class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="proj-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">نام مشتری</label>
                        <input type="text" id="proj-client" class="w-full p-3 rounded-xl god-input outline-none font-bold" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">شماره تماس</label>
                        <input type="text" id="proj-phone" class="w-full p-3 rounded-xl god-input outline-none font-mono text-left dir-ltr" required>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">عنوان پروژه (خدمت)</label>
                    <select id="proj-name" class="w-full p-3 rounded-xl god-input outline-none font-bold bg-god-surface">
                        <option value="طراحی سایت فروشگاهی">طراحی سایت فروشگاهی</option>
                        <option value="طراحی سایت شرکتی">طراحی سایت شرکتی</option>
                        <option value="سئو و بهینه‌سازی">سئو و بهینه‌سازی</option>
                        <option value="توسعه اختصاصی (کدنویسی)">توسعه اختصاصی (کدنویسی)</option>
                        <option value="مشاوره دیجیتال مارکتینگ">مشاوره دیجیتال مارکتینگ</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">مبلغ کل (تومان)</label>
                        <input type="number" id="proj-price" class="w-full p-3 rounded-xl god-input outline-none font-mono" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">دریافتی (تومان)</label>
                        <input type="number" id="proj-paid" class="w-full p-3 rounded-xl god-input outline-none font-mono" placeholder="0">
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-xs font-bold text-gray-500">درصد پیشرفت</label>
                        <span class="text-xs font-bold text-god-gold" id="proj-progress-val">0%</span>
                    </div>
                    <input type="range" id="proj-progress" min="0" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('proj-progress-val').innerText = this.value + '%'">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">وضعیت فعلی</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="setModalStatus('بررسی اولیه')" class="status-select-btn p-2 rounded-lg border border-white/10 text-xs font-bold hover:bg-white/5 transition text-center" data-val="بررسی اولیه">بررسی اولیه</button>
                        <button type="button" onclick="setModalStatus('در حال انجام')" class="status-select-btn p-2 rounded-lg border border-white/10 text-xs font-bold hover:bg-white/5 transition text-center" data-val="در حال انجام">در حال انجام</button>
                        <button type="button" onclick="setModalStatus('تکمیل شده')" class="status-select-btn p-2 rounded-lg border border-white/10 text-xs font-bold hover:bg-white/5 transition text-center" data-val="تکمیل شده">تکمیل شده</button>
                    </div>
                    <input type="hidden" id="proj-status" value="بررسی اولیه">
                </div>

            </form>

            <div class="p-6 border-t border-white/5 bg-god-panel rounded-b-3xl flex gap-3">
                <button onclick="deleteProject()" id="btn-delete" class="hidden px-4 py-3 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl hover:bg-red-500/20 transition"><i class="fas fa-trash"></i></button>
                <button onclick="saveProject()" class="flex-1 bg-god-gold hover:bg-white text-black font-black py-3 rounded-xl shadow-lg shadow-god-gold/20 transition">ذخیره اطلاعات</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let revenueChart = null;

        // --- UTILS ---
        const formatMoney = (n) => new Intl.NumberFormat('fa-IR').format(n);
        function showToast(msg, type='success') {
            Toastify({
                text: msg, duration: 3000, gravity: "bottom-center",
                style: { background: type === 'success' ? "#10B981" : "#EF4444", borderRadius: "8px", fontSize: "12px", fontFamily: "Vazirmatn", boxShadow: "0 10px 30px rgba(0,0,0,0.5)" }
            }).showToast();
        }
        function updateTime() {
            const now = new Date();
            document.getElementById('server-time').innerText = now.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
        }
        setInterval(updateTime, 1000);

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> بررسی هویت...';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                // Success
                currentUser = data.user;
                initAdminPanel();
                
            } catch (err) {
                showToast(err.message, 'error');
                btn.innerHTML = originalContent;
                document.getElementById('password').value = '';
            }
        });

        window.logout = async () => {
            await supabase.auth.signOut();
            location.reload();
        };

        function initAdminPanel() {
            document.getElementById('login-gate').classList.add('hidden');
            document.getElementById('main-sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            loadDashboardData();
            loadProjects();
            loadUsers();
        }

        // --- DASHBOARD ---
        async function loadDashboardData() {
            // 1. Fetch Projects for Revenue & Active Count
            const { data: projects } = await supabase.from('projects').select('*');
            let agencyRevenue = 0;
            let activeProjCount = 0;
            
            if(projects) {
                projects.forEach(p => {
                    agencyRevenue += (p.paid_amount || 0);
                    if(p.status === 'در حال انجام' || p.status === 'بررسی اولیه') activeProjCount++;
                });
            }

            // 2. Fetch Stores Count (Profiles)
            const { count: storesCount } = await supabase.from('store_profiles').select('*', { count: 'exact', head: true });

            // 3. Estimate Platform Revenue (This is tricky with RLS, trying best effort or mockup for Admin)
            // Ideally Admin should have a view or special function. For UI demo we use aggregated project revenue + placeholder for stores.
            
            document.getElementById('dash-revenue').innerText = formatMoney(agencyRevenue) + ' ت';
            document.getElementById('dash-active-projects').innerText = activeProjCount;
            document.getElementById('dash-stores').innerText = storesCount || 0;
            
            // Render Chart
            renderRevenueChart(projects || []);
        }

        function renderRevenueChart(projects) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Group payments by date (mocking somewhat as we don't have transaction log table for agency yet, using updated_at)
            const labels = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور'];
            const data = [0, 0, 0, 0, 0, 0]; 
            // Mock data population for visual impact
            if(projects.length > 0) {
                 const total = projects.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
                 data[5] = total; 
                 data[4] = total * 0.8; 
                 data[3] = total * 0.5;
            }

            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'درآمد',
                        data: data,
                        borderColor: '#D4AF37',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(212,175,55,0.4)');
                            gradient.addColorStop(1, 'rgba(212,175,55,0)');
                            return gradient;
                        },
                        fill: true, tension: 0.4, borderWidth: 3, pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666', font: { family: 'Vazirmatn' } } },
                        y: { display: false }
                    }
                }
            });
        }

        // --- PROJECTS (AGENCY) ---
        async function loadProjects() {
            const tbody = document.getElementById('projects-table-body');
            tbody.innerHTML = '<tr class="animate-pulse"><td colspan="6" class="p-5 text-center text-xs text-gray-500">در حال دریافت داده‌ها...</td></tr>';

            const { data: projects, error } = await supabase.from('projects').select('*').order('created_at', { ascending: false });
            
            tbody.innerHTML = '';
            if(!projects || projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-600 text-xs">پروژه‌ای یافت نشد</td></tr>';
                return;
            }

            projects.forEach(p => {
                let statusClass = 'st-pending';
                if(p.status === 'در حال انجام') statusClass = 'st-active';
                if(p.status === 'تکمیل شده') statusClass = 'st-done';

                const progressColor = p.progress === 100 ? 'bg-green-500' : 'bg-god-gold';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition border-b border-white/5 last:border-0 group';
                tr.innerHTML = `
                    <td class="p-5">
                        <div class="font-bold text-white">${p.client_name || 'ناشناس'}</div>
                        <div class="text-[10px] text-gray-500 font-mono">${p.owner_phone}</div>
                    </td>
                    <td class="p-5 font-bold text-gray-400">${p.project_name || '---'}</td>
                    <td class="p-5"><span class="status-badge ${statusClass}">${p.status}</span></td>
                    <td class="p-5 w-1/5">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-mono text-gray-400">${p.progress}%</span>
                        </div>
                        <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full ${progressColor}" style="width: ${p.progress}%"></div>
                        </div>
                    </td>
                    <td class="p-5 font-mono text-gray-300">
                        <div class="text-xs">کل: ${formatMoney(p.total_price)}</div>
                        <div class="text-[10px] text-green-500 mt-1">پرداخت: ${formatMoney(p.paid_amount)}</div>
                    </td>
                    <td class="p-5 text-center">
                        <button class="edit-proj-btn w-8 h-8 rounded-lg bg-white/5 hover:bg-god-gold hover:text-black transition flex items-center justify-center text-gray-400 shadow-sm">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                    </td>
                `;
                // Bind data to button
                tr.querySelector('.edit-proj-btn').onclick = () => openProjectModal(p);
                tbody.appendChild(tr);
            });
        }

        // --- PROJECT MODAL LOGIC ---
        window.openProjectModal = (proj = null) => {
            const modal = document.getElementById('project-modal');
            const form = document.getElementById('project-form');
            const delBtn = document.getElementById('btn-delete');
            modal.classList.remove('hidden');

            if(proj) {
                document.getElementById('modal-title').innerText = 'ویرایش پروژه';
                document.getElementById('proj-id').value = proj.id;
                document.getElementById('proj-client').value = proj.client_name;
                document.getElementById('proj-phone').value = proj.owner_phone;
                document.getElementById('proj-name').value = proj.project_name;
                document.getElementById('proj-price').value = proj.total_price;
                document.getElementById('proj-paid').value = proj.paid_amount;
                document.getElementById('proj-progress').value = proj.progress;
                document.getElementById('proj-progress-val').innerText = proj.progress + '%';
                window.setModalStatus(proj.status);
                delBtn.classList.remove('hidden');
            } else {
                document.getElementById('modal-title').innerText = 'ثبت پروژه جدید';
                form.reset();
                document.getElementById('proj-id').value = '';
                document.getElementById('proj-progress-val').innerText = '0%';
                window.setModalStatus('بررسی اولیه');
                delBtn.classList.add('hidden');
            }
        };
        window.closeProjectModal = () => document.getElementById('project-modal').classList.add('hidden');

        window.setModalStatus = (status) => {
            document.getElementById('proj-status').value = status;
            document.querySelectorAll('.status-select-btn').forEach(btn => {
                if(btn.dataset.val === status) {
                    btn.classList.add('bg-white', 'text-black', 'border-transparent');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('bg-white', 'text-black', 'border-transparent');
                }
            });
        };

        window.saveProject = async () => {
            const id = document.getElementById('proj-id').value;
            const payload = {
                client_name: document.getElementById('proj-client').value,
                owner_phone: document.getElementById('proj-phone').value,
                project_name: document.getElementById('proj-name').value,
                total_price: parseInt(document.getElementById('proj-price').value) || 0,
                paid_amount: parseInt(document.getElementById('proj-paid').value) || 0,
                progress: parseInt(document.getElementById('proj-progress').value) || 0,
                status: document.getElementById('proj-status').value
            };

            if(!payload.client_name || !payload.owner_phone) {
                showToast('نام مشتری و شماره تماس الزامی است', 'error'); return;
            }

            let error;
            if(id) {
                const res = await supabase.from('projects').update(payload).eq('id', id);
                error = res.error;
            } else {
                const res = await supabase.from('projects').insert([payload]);
                error = res.error;
            }

            if(error) showToast('خطا: ' + error.message, 'error');
            else { showToast('پروژه ذخیره شد'); closeProjectModal(); loadProjects(); loadDashboardData(); }
        };

        window.deleteProject = async () => {
            const id = document.getElementById('proj-id').value;
            if(!id || !confirm('آیا از حذف این پروژه اطمینان دارید؟')) return;
            const { error } = await supabase.from('projects').delete().eq('id', id);
            if(error) showToast('خطا در حذف', 'error');
            else { showToast('پروژه حذف شد'); closeProjectModal(); loadProjects(); loadDashboardData(); }
        };

        // --- USERS (STORES) ---
        async function loadUsers() {
            const grid = document.getElementById('stores-grid');
            const { data: profiles } = await supabase.from('store_profiles').select('*').order('created_at', {ascending: false});

            grid.innerHTML = '';
            if(!profiles || profiles.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 text-sm">هنوز فروشگاهی ساخته نشده است.</p>';
                return;
            }

            profiles.forEach(p => {
                const card = document.createElement('div');
                card.className = 'glass-panel p-5 rounded-2xl border border-white/5 hover:border-god-gold/50 transition group';
                card.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-white/5 border border-white/10 p-1 overflow-hidden">
                            <img src="${p.store_logo || 'img/logo01.png'}" class="w-full h-full object-cover rounded-full">
                        </div>
                        <div>
                            <h4 class="font-bold text-white text-sm">${p.store_name || 'فروشگاه بی‌نام'}</h4>
                            <p class="text-[10px] text-gray-500 font-mono mt-0.5">${p.instagram_id || '@no_insta'}</p>
                        </div>
                        <a href="store.html?id=${p.user_id}" target="_blank" class="mr-auto w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-gray-400 hover:text-white hover:bg-god-gold transition">
                            <i class="fas fa-external-link-alt text-xs"></i>
                        </a>
                    </div>
                    <div class="flex justify-between items-center text-[10px] text-gray-500 border-t border-white/5 pt-3">
                        <span><i class="fas fa-calendar ml-1"></i> ${new Date(p.created_at).toLocaleDateString('fa-IR')}</span>
                        <span class="text-god-gold">ID: ${p.slug || '---'}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- NAVIGATION ---
        window.switchView = (viewName) => {
            // Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            event.currentTarget?.classList.add('active');

            // Header Title
            const titles = { 'dashboard': 'داشبورد فرماندهی', 'projects': 'مدیریت پروژه‌ها', 'users': 'فروشگاه‌های پلتفرم' };
            document.getElementById('page-title').innerText = titles[viewName];

            // Views Toggle
            ['dashboard', 'projects', 'users'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if(v === viewName) {
                    el.classList.remove('hidden');
                    el.classList.add('animate-slide-up');
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('animate-slide-up');
                }
            });
        }

    </script>
</body>
</html>