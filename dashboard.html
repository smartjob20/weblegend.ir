<!DOCTYPE html>
<html lang="fa" dir="rtl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>فرماندهی فروشگاه | WEB LEGEND VIP</title>
    <link rel="icon" type="image/png" href="img/logo01.png">
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brand: { 
                            gold: '#D4AF37', 
                            goldHover: '#F9E59E', 
                            dark: '#050505', 
                            panel: '#121212', 
                            surface: '#1E1E1E',
                            border: '#2A2A2A'
                        } 
                    },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    boxShadow: {
                        'gold': '0 4px 20px -5px rgba(212, 175, 55, 0.3)',
                        'gold-glow': '0 0 15px rgba(212, 175, 55, 0.4)',
                        'subtle': '0 2px 10px rgba(0,0,0,0.03)',
                        'float': '0 10px 40px -10px rgba(0,0,0,0.15)'
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-fast': 'spin 0.7s linear infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    fontSize: {
                        'xxs': '0.65rem'
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Premium UI Elements */
        .glass { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(229, 231, 235, 0.5); 
            box-shadow: var(--shadow-subtle);
        }
        .dark .glass { 
            background: rgba(30, 30, 30, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); 
        }

        /* Sidebar Refined */
        .sidebar-link { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 0.85rem; 
            cursor: pointer; 
            border-radius: 6px;
            margin-bottom: 2px;
            padding: 8px 12px;
            color: #64748b;
        }
        .sidebar-link:hover { 
            background: rgba(0,0,0,0.03); 
            color: #0f172a; 
        }
        .dark .sidebar-link { color: #94a3b8; }
        .dark .sidebar-link:hover { 
            background: rgba(255,255,255,0.05); 
            color: #f8fafc; 
        }
        .sidebar-link.active { 
            background: rgba(212, 175, 55, 0.1); 
            color: #D4AF37; 
            font-weight: 700; 
        }
        .dark .sidebar-link.active {
            background: rgba(212, 175, 55, 0.15); 
            color: #D4AF37;
        }
        
        /* Floating Nav (Mobile) */
        .floating-nav-container {
            position: fixed; bottom: 20px; left: 16px; right: 16px; z-index: 50; display: flex; justify-content: center;
        }
        .floating-nav {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px);
            border-radius: 24px; padding: 10px 20px;
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;
            align-items: center; box-shadow: var(--shadow-float);
            border: 1px solid rgba(0,0,0,0.05); width: 100%; max-width: 500px;
        }
        .dark .floating-nav {
            background: rgba(20, 20, 20, 0.95); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px -5px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            color: #9CA3AF; transition: all 0.3s; position: relative; cursor: pointer;
        }
        .nav-item i { font-size: 1.1rem; transition: transform 0.2s; }
        .nav-item span { font-size: 0.55rem; font-weight: bold; opacity: 0.7; transition: all 0.2s; }
        .nav-item.active { color: #D4AF37; }
        .nav-item.active i { transform: translateY(-2px); }
        .nav-item.active span { opacity: 1; font-weight: 900; }
        
        .nav-fab-btn {
            background: linear-gradient(135deg, #D4AF37, #F9E59E); color: black;
            width: 42px; height: 42px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
            transform: translateY(-8px); border: 3px solid #fff; transition: transform 0.2s;
        }
        .dark .nav-fab-btn { border-color: #121212; }
        .nav-fab-btn:active { transform: translateY(-5px) scale(0.95); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .mobile-sheet { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Inputs & UI */
        input, select, textarea { transition: border-color 0.2s, box-shadow 0.2s; }
        .input-premium { background: #fff; border: 1px solid #e2e8f0; }
        .dark .input-premium { background: #151515; border: 1px solid #333; }
        .input-premium:focus { border-color: #D4AF37; box-shadow: 0 0 0 2px rgba(212,175,55,0.1); }

        /* Custom Rich Text Editor */
        .rich-editor-container { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: #fff; transition: all 0.3s; }
        .dark .rich-editor-container { border-color: #333; background: #151515; }
        .rich-editor-container:focus-within { border-color: #D4AF37; box-shadow: 0 0 0 2px rgba(212,175,55,0.1); }
        
        .editor-toolbar { 
            display: flex; gap: 4px; padding: 8px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; 
        }
        .dark .editor-toolbar { background: #111; border-color: #333; }
        
        .editor-btn {
            width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: #64748b; cursor: pointer; transition: all 0.2s;
        }
        .dark .editor-btn { color: #94a3b8; }
        .editor-btn:hover { background: #e2e8f0; color: #0f172a; }
        .dark .editor-btn:hover { background: #333; color: #fff; }
        .editor-btn.active { background: #D4AF37; color: black; }

        .editor-content {
            min-height: 120px; padding: 12px; outline: none; font-size: 0.85rem; line-height: 1.6;
            color: #1e293b; max-height: 200px; overflow-y: auto;
        }
        .dark .editor-content { color: #e2e8f0; }
        .editor-content ul { list-style-type: disc; padding-right: 20px; }
        .editor-content ol { list-style-type: decimal; padding-right: 20px; }
        .editor-content b, .editor-content strong { font-weight: 800; color: #D4AF37; } /* Styling Bold for impact */

        /* Modern Tabs (Pills) */
        .pill-nav {
            display: flex; background: #f1f5f9; padding: 4px; border-radius: 14px;
            position: relative; margin-bottom: 20px;
        }
        .dark .pill-nav { background: #111; }
        
        .pill-btn {
            flex: 1; text-align: center; padding: 10px; font-size: 0.75rem; font-weight: 800;
            color: #64748b; z-index: 2; cursor: pointer; transition: color 0.3s;
            border-radius: 10px;
        }
        .dark .pill-btn { color: #64748b; }
        .pill-btn.active { color: #000; }
        .dark .pill-btn.active { color: #fff; }
        
        .pill-indicator {
            position: absolute; top: 4px; bottom: 4px; width: calc(50% - 4px);
            background: #fff; border-radius: 10px; z-index: 1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .pill-indicator { background: #222; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        .pill-nav[data-active="1"] .pill-indicator { left: auto; right: 4px; }
        .pill-nav[data-active="2"] .pill-indicator { right: 50%; }

        .step-content { display: none; animation: fadeIn 0.4s ease; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:scale(0.98);} to{opacity:1; transform:scale(1);} }

        /* Loader */
        .cube-loader { position: relative; width: 50px; height: 50px; transform-style: preserve-3d; animation: cubeRotate 4s infinite linear; }
        .cube-face { position: absolute; width: 50px; height: 50px; border: 2px solid #D4AF37; opacity: 0.5; box-shadow: 0 0 15px rgba(212,175,55,0.2); }
        .cube-face:nth-child(1) { transform: rotateY(0deg) translateZ(25px); }
        .cube-face:nth-child(2) { transform: rotateY(90deg) translateZ(25px); }
        .cube-face:nth-child(3) { transform: rotateY(180deg) translateZ(25px); }
        .cube-face:nth-child(4) { transform: rotateY(-90deg) translateZ(25px); }
        .cube-face:nth-child(5) { transform: rotateX(90deg) translateZ(25px); }
        .cube-face:nth-child(6) { transform: rotateX(-90deg) translateZ(25px); }
        @keyframes cubeRotate { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }

        /* Misc */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .btn-loading { pointer-events: none; opacity: 0.7; position: relative; color: transparent !important; }
        .btn-loading::after { content: ""; position: absolute; left: 50%; top: 50%; width: 16px; height: 16px; border: 2px solid currentColor; border-radius: 50%; border-top-color: transparent; animation: spin-fast 0.8s linear infinite; transform: translate(-50%, -50%); border-color: #888; }
        .dark .btn-loading::after { border-color: #fff; }
    </style>
</head>
<body class="font-sans h-screen overflow-hidden flex text-sm bg-[#f8f9fa] text-gray-800 dark:bg-black dark:text-gray-200">

    <div id="page-loader" class="fixed inset-0 z-[100] bg-[#000] flex items-center justify-center transition-opacity duration-700">
        <div class="cube-loader">
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="absolute inset-0 bg-brand-gold/20 blur-xl rounded-full animate-pulse-slow"></div>
        </div>
    </div>

    <aside class="hidden lg:flex w-64 bg-white dark:bg-brand-panel border-l border-gray-200 dark:border-white/5 flex-col z-20 transition-all duration-300">
        <div class="p-5 flex items-center justify-start gap-3 h-16 border-b border-gray-100 dark:border-white/5">
            <div class="w-8 h-8 bg-gradient-to-br from-brand-gold to-yellow-600 rounded-lg flex items-center justify-center text-black font-black text-lg shadow-gold">W</div>
            <div>
                <h1 class="font-black tracking-tight text-base text-gray-900 dark:text-white">WEB <span class="text-brand-gold">LEGEND</span></h1>
            </div>
        </div>

        <nav class="flex-1 px-3 space-y-1 overflow-y-auto pt-4 custom-scrollbar">
            <p class="px-2 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-1 tracking-wider opacity-80">مدیریت</p>
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full flex items-center justify-start gap-3">
                <i class="fas fa-chart-pie w-5 text-center"></i> <span class="font-medium">داشبورد</span>
            </button>
            <button onclick="switchTab('products')" class="sidebar-link w-full flex items-center justify-start gap-3">
                <i class="fas fa-box-open w-5 text-center"></i> <span class="font-medium">محصولات</span>
            </button>
            <button onclick="switchTab('orders')" class="sidebar-link w-full flex items-center justify-start gap-3 relative">
                <i class="fas fa-receipt w-5 text-center"></i> <span class="font-medium">سفارشات</span>
                <span id="sidebar-badge-orders" class="absolute left-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[8px] font-black px-1.5 rounded-full hidden animate-pulse">!</span>
            </button>
            
            <p class="px-2 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-6 tracking-wider opacity-80">ابزارها</p>
            <button onclick="showToast('به زودی...', 'info')" class="sidebar-link w-full flex items-center justify-start gap-3">
                <i class="fas fa-brain w-5 text-center"></i> <span class="font-medium">هوش مصنوعی</span>
                <span class="text-[8px] bg-brand-gold/20 text-brand-gold px-1.5 rounded-md font-bold ml-auto">AI</span>
            </button>
            
            <button onclick="window.open('sale.html', '_blank')" class="sidebar-link w-full flex items-center justify-start gap-3">
                <i class="fas fa-globe w-5 text-center"></i> <span class="font-medium">فروشگاه آنلاین</span>
                <i class="fas fa-external-link-alt text-[9px] mr-auto opacity-50"></i>
            </button>

            <button onclick="openSettingsModal()" class="sidebar-link w-full flex items-center justify-start gap-3">
                <i class="fas fa-cog w-5 text-center"></i> <span class="font-medium">تنظیمات</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 dark:border-white/5">
            <button onclick="openUpgradeModal()" class="w-full flex items-center justify-center gap-2 px-3 py-2 text-brand-gold rounded-lg transition bg-brand-gold/5 border border-brand-gold/20 hover:bg-brand-gold hover:text-black mb-2 text-xs font-black">
                <i class="fas fa-crown animate-pulse"></i> خرید اشتراک ویژه
            </button>
            <button onclick="logout()" class="flex items-center justify-center gap-2 w-full py-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg transition font-bold text-xs">
                <i class="fas fa-sign-out-alt"></i> خروج
            </button>
        </div>
    </aside>

    <main class="flex-1 relative flex flex-col h-full overflow-hidden">
        
        <header class="h-16 flex justify-between items-center px-5 lg:px-8 z-10 bg-white/80 dark:bg-black/80 backdrop-blur-md sticky top-0 border-b border-gray-200 dark:border-white/5">
            <div class="flex items-center gap-4">
                <div class="lg:hidden w-8 h-8 bg-gradient-to-tr from-brand-gold to-yellow-600 rounded-lg flex items-center justify-center text-black font-black text-sm shadow-gold">W</div>
                <div>
                    <div class="flex items-center gap-3">
                        <h2 class="text-sm lg:text-base font-black text-gray-900 dark:text-white" id="greeting-text">امپراتوری شما</h2>
                        
                        <div id="plan-badge" class="cursor-pointer" onclick="openUpgradeModal()">
                            <span id="plan-badge-content" class="flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-gray-100 dark:bg-white/10 text-[9px] font-bold text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-white/10 hover:bg-brand-gold hover:text-black hover:border-brand-gold transition">
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                                <span id="plan-text">رایگان</span>
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="w-1 h-1 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[9px] text-gray-500 font-mono tracking-wider">SYSTEM ONLINE</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggleBtn" class="w-8 h-8 rounded-full bg-transparent hover:bg-gray-100 dark:hover:bg-white/5 flex items-center justify-center text-gray-500 transition">
                    <i class="fas fa-moon hidden dark:block text-xs"></i>
                    <i class="fas fa-sun text-yellow-500 dark:hidden text-xs"></i>
                </button>
                <div class="h-5 w-[1px] bg-gray-200 dark:bg-white/10 mx-1"></div>
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition" onclick="openProfileModal()">
                    <div class="text-right hidden md:block">
                        <p class="text-xs font-bold text-gray-900 dark:text-white" id="header-shop-name">پروفایل</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-white/10 border border-gray-200 dark:border-white/10 overflow-hidden shadow-sm">
                        <img src="img/logo01.png" class="w-full h-full object-cover opacity-80" id="header-avatar" alt="Avatar">
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-6 scroll-smooth pb-32 lg:pb-8 relative custom-scrollbar" id="main-scroll-area">
            
            <div id="view-dashboard" class="space-y-5 animate-slide-up">
                
                <div class="w-full bg-gradient-to-r from-gray-900 to-black rounded-2xl p-6 text-white shadow-lg relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-40 h-40 bg-brand-gold/10 rounded-full blur-2xl group-hover:bg-brand-gold/20 transition duration-700"></div>
                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div>
                            <h3 class="text-2xl font-black mb-1 animate-fade-in-up" id="welcome-message">خوش آمدید</h3>
                            <p class="text-sm text-gray-400">امپراتوری فروش شما آماده فرماندهی است.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="switchTab('products')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-xs font-bold backdrop-blur-md transition">مدیریت محصولات</button>
                            <button onclick="openProductModal()" class="px-4 py-2 bg-brand-gold text-black rounded-xl text-xs font-black shadow-gold hover:scale-105 transition flex items-center gap-2">
                                <i class="fas fa-plus"></i> محصول جدید
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                    <div class="col-span-2 lg:col-span-2 glass rounded-2xl p-5 relative overflow-hidden group border-t-2 border-brand-gold">
                        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-brand-gold/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">فروش کل (تصفیه شده)</p>
                                <h3 class="text-2xl lg:text-3xl font-black text-gray-900 dark:text-white tracking-tight" id="dash-total-sales">0</h3>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-brand-gold text-black flex items-center justify-center text-lg shadow-gold">
                                <i class="fas fa-university"></i>
                            </div>
                        </div>
                        <div class="relative z-10 mt-3 flex items-center gap-2 text-[10px] font-bold text-green-600 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-md w-fit">
                            <i class="fas fa-check-circle"></i> <span>شاپرک فعال</span>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-5 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-2 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-9 h-9 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center"><i class="fas fa-shopping-bag text-sm"></i></div>
                            <span class="text-[9px] bg-gray-100 dark:bg-white/5 px-1.5 py-0.5 rounded text-gray-500">موفق</span>
                        </div>
                        <div class="mt-3">
                            <h3 class="text-xl font-black text-gray-900 dark:text-white" id="dash-order-count">0</h3>
                            <p class="text-[10px] text-gray-500 mt-1 font-bold">تعداد سفارشات</p>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-5 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-2 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-9 h-9 rounded-lg bg-purple-500/10 text-purple-500 flex items-center justify-center"><i class="fas fa-eye text-sm"></i></div>
                            <span class="text-[9px] bg-green-100 text-green-600 px-1.5 py-0.5 rounded flex items-center gap-1"><i class="fas fa-caret-up"></i> زنده</span>
                        </div>
                        <div class="mt-3">
                            <h3 class="text-xl font-black text-gray-900 dark:text-white" id="dash-views">...</h3>
                            <p class="text-[10px] text-gray-500 mt-1 font-bold">بازدید فروشگاه</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2 glass rounded-2xl p-5">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="font-bold text-sm text-gray-900 dark:text-white flex items-center gap-2"><i class="fas fa-chart-line text-brand-gold"></i> نمودار فروش</h3>
                            <select id="chart-filter" onchange="updateAnalytics()" class="bg-gray-50 dark:bg-white/5 border-none text-[10px] rounded-lg px-2 py-1 outline-none font-bold text-gray-500 cursor-pointer hover:bg-gray-100 transition">
                                <option value="7">۷ روز</option>
                                <option value="30">۳۰ روز</option>
                                <option value="all">کل</option>
                            </select>
                        </div>
                        <div class="h-[220px] w-full">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-5 flex flex-col">
                        <h3 class="font-bold text-sm text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-crown text-brand-gold"></i> برترین‌ها</h3>
                        <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-1" id="top-products-list">
                            <div class="text-center py-8 opacity-50"><p class="text-xs">در حال تحلیل...</p></div>
                        </div>
                        <button onclick="switchTab('products')" class="w-full mt-3 py-2.5 bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 rounded-xl text-[10px] font-bold transition">مدیریت محصولات</button>
                    </div>
                </div>
            </div>

            <div id="view-products" class="hidden space-y-5 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-black text-gray-900 dark:text-white">محصولات</h2>
                        <p class="text-[10px] text-gray-500 mt-0.5">مدیریت ویترین</p>
                    </div>
                    <button onclick="openProductModal()" class="hidden lg:flex bg-brand-gold hover:bg-brand-goldHover text-black font-black px-4 py-2 rounded-xl shadow-gold transition transform hover:-translate-y-0.5 items-center gap-2 cursor-pointer text-xs">
                        <i class="fas fa-plus"></i> افزودن
                    </button>
                </div>
                
                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 pb-20"></div>
            </div>

            <div id="view-orders" class="hidden space-y-5 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-black text-gray-900 dark:text-white">سفارشات</h2>
                        <p class="text-[10px] text-gray-500 mt-0.5">لیست فروش‌ها</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="bg-white dark:bg-white/5 px-2 py-1 rounded-lg border border-gray-200 dark:border-white/10 text-[10px] font-bold">
                            کل: <span id="total-orders-badge">0</span>
                        </div>
                        <button onclick="refreshOrdersData()" id="refresh-orders-btn" class="w-7 h-7 rounded-lg bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-white hover:text-brand-gold transition shadow-sm cursor-pointer" title="بروزرسانی">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </button>
                    </div>
                </div>

                <div class="hidden lg:block glass rounded-2xl overflow-hidden border border-gray-100 dark:border-white/5">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-gray-50 dark:bg-white/5 text-gray-500 text-[10px] uppercase font-bold">
                            <tr>
                                <th class="p-4">شناسه</th>
                                <th class="p-4">مشتری</th>
                                <th class="p-4">محصولات</th>
                                <th class="p-4">مبلغ</th>
                                <th class="p-4">آدرس</th>
                                <th class="p-4 text-center">وضعیت</th>
                                <th class="p-4 text-center">اقدام</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-desktop" class="divide-y divide-gray-100 dark:divide-white/5 text-xs"></tbody>
                    </table>
                </div>

                <div class="lg:hidden space-y-3" id="orders-list-mobile"></div>
            </div>

        </div>
    </main>

    <div class="lg:hidden floating-nav-container">
        <nav class="floating-nav">
            <button onclick="switchTab('dashboard')" class="nav-item active" id="m-nav-dashboard">
                <i class="fas fa-chart-pie"></i>
                <span>داشبورد</span>
            </button>
            <button onclick="switchTab('orders')" class="nav-item relative" id="m-nav-orders">
                <i class="fas fa-receipt"></i>
                <span>سفارشات</span>
                <div id="mobile-badge-orders" class="absolute top-0 right-1 w-1.5 h-1.5 bg-red-500 rounded-full border border-white dark:border-black hidden animate-pulse"></div>
            </button>
            
            <button onclick="switchTab('products')" class="nav-item" id="m-nav-products">
                <i class="fas fa-box-open"></i>
                <span>محصولات</span>
            </button>
            <button onclick="showToast('هوش مصنوعی به زودی...', 'info')" class="nav-item" id="m-nav-ai">
                <i class="fas fa-brain"></i>
                <span>AI</span>
            </button>
            <button onclick="openSettingsModal()" class="nav-item" id="m-nav-settings">
                <i class="fas fa-cog"></i>
                <span>تنظیمات</span>
            </button>
            <button onclick="openProductModal()" class="nav-item" id="m-nav-add">
                <div class="nav-fab-btn">
                    <i class="fas fa-plus"></i>
                </div>
            </button>
        </nav>
    </div>

    <div id="product-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-2xl lg:rounded-3xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] lg:max-h-[85vh] mobile-sheet lg:animate-slide-up overflow-hidden">
            
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white" id="modal-title">خلق محصول جدید</h3>
                    <p class="text-[10px] text-gray-500">جزئیات را با دقت و خلاقیت وارد کنید</p>
                </div>
                <button onclick="closeProductModal()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition hover:bg-red-50 dark:hover:bg-red-900/10"><i class="fas fa-times"></i></button>
            </div>

            <div class="px-6 pt-4 pb-2 bg-white dark:bg-[#111]">
                <div class="pill-nav" data-active="1">
                    <div class="pill-indicator"></div>
                    <div class="pill-btn active" onclick="switchProductStep(1)" id="step-btn-1">اطلاعات پایه</div>
                    <div class="pill-btn" onclick="switchProductStep(2)" id="step-btn-2">تنظیمات پیشرفته</div>
                </div>
            </div>

            <form id="product-form" class="p-6 space-y-6 overflow-y-auto custom-scrollbar pb-24 lg:pb-6 flex-1" onsubmit="event.preventDefault();">
                
                <div id="step-content-1" class="step-content active space-y-5">
                    
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-2 block flex justify-between"><span>گالری تصاویر</span><span class="text-[9px] text-brand-gold font-black"><i class="fas fa-star"></i> اولین تصویر = کاور</span></label>
                        <div class="flex gap-3 overflow-x-auto pb-2 items-center custom-scrollbar">
                            <div id="upload-trigger-btn" class="w-20 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer flex-shrink-0 text-gray-400 hover:text-brand-gold hover:border-brand-gold transition border-2 border-dashed border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-white/5 group" onclick="document.getElementById('image-upload-input').click()">
                                <i class="fas fa-camera text-xl mb-1 group-hover:scale-110 transition"></i><span class="text-[8px] font-bold">افزودن عکس</span>
                            </div>
                            <div id="image-previews-container" class="flex gap-3"></div>
                        </div>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*" multiple onchange="handleImageUpload(this)">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1.5">نام محصول <span class="text-red-500">*</span></label>
                            <input type="text" id="prod-name" class="input-premium w-full p-3.5 rounded-xl text-gray-900 dark:text-white outline-none font-bold text-sm" placeholder="مثلا: کفش نایک جردن">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1.5">قیمت (تومان) <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" id="prod-price" inputmode="numeric" onkeyup="formatPriceInput(this)" class="input-premium w-full p-3.5 pl-10 rounded-xl text-gray-900 dark:text-white outline-none font-black text-lg text-left dir-ltr tracking-wide" placeholder="0">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">T</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 flex justify-between">
                            <span>دسته‌بندی</span>
                            <span class="text-[9px] text-blue-500 cursor-pointer hover:underline" onclick="toggleNewCategoryInput()">+ دسته جدید</span>
                        </label>
                        <div class="relative" id="category-select-wrapper">
                            <select id="prod-category" class="input-premium w-full p-3.5 rounded-xl text-gray-900 dark:text-white appearance-none font-bold outline-none text-xs h-[50px] cursor-pointer">
                                <option value="">انتخاب کنید...</option>
                            </select>
                            <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                        </div>
                        <div id="new-category-input-wrapper" class="hidden mt-2 flex gap-2 animate-fade-in-up">
                            <input type="text" id="new-cat-inline-input" class="flex-1 p-2.5 text-xs rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 outline-none font-bold focus:border-brand-gold" placeholder="نام دسته جدید...">
                            <button type="button" onclick="createCategoryInline()" class="px-3 bg-brand-gold text-black rounded-xl font-bold text-xs hover:bg-white transition shadow-gold"><i class="fas fa-check"></i></button>
                            <button type="button" onclick="toggleNewCategoryInput()" class="px-3 bg-gray-200 dark:bg-white/10 text-gray-600 dark:text-gray-300 rounded-xl font-bold text-xs"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5">توضیح کوتاه (خلاصه)</label>
                        <input type="text" id="prod-short-desc" class="input-premium w-full p-3.5 rounded-xl text-gray-900 dark:text-white outline-none text-xs" placeholder="ویژگی‌های کلیدی برای نمایش در کارت محصول...">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5">توضیحات کامل (با جزئیات)</label>
                        <div class="rich-editor-container">
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('strikeThrough')" title="Strike"><i class="fas fa-strikethrough"></i></button>
                                <div class="w-px h-4 bg-gray-300 dark:bg-white/10 mx-1"></div>
                                <button type="button" class="editor-btn" onclick="execCmd('insertUnorderedList')" title="List"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyLeft')" title="Left"><i class="fas fa-align-left"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyCenter')" title="Center"><i class="fas fa-align-center"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyRight')" title="Right"><i class="fas fa-align-right"></i></button>
                            </div>
                            <div id="rich-text-content" class="editor-content" contenteditable="true" placeholder="توضیحات کامل محصول را اینجا بنویسید..."></div>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-black text-gray-500 uppercase tracking-wider">ویژگی‌های محصول</label>
                            <div class="flex gap-1.5">
                                <button type="button" onclick="addAttributeBlock('colors')" class="px-2 py-1 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center gap-1 hover:border-brand-gold transition text-gray-500 text-[10px] font-bold shadow-sm"><i class="fas fa-palette text-brand-gold"></i> رنگ</button>
                                <button type="button" onclick="addAttributeBlock('sizes')" class="px-2 py-1 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center gap-1 hover:border-brand-gold transition text-gray-500 text-[10px] font-bold shadow-sm"><i class="fas fa-ruler text-blue-500"></i> سایز</button>
                                <button type="button" onclick="addAttributeBlock('custom')" class="px-2 py-1 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center gap-1 hover:border-brand-gold transition text-gray-500 text-[10px] font-bold shadow-sm"><i class="fas fa-plus text-green-500"></i> دلخواه</button>
                            </div>
                        </div>
                        <div id="attributes-container" class="space-y-3 min-h-[40px]">
                            <p class="text-[10px] text-gray-400 text-center italic py-2" id="no-attr-msg">هنوز ویژگی اضافه نشده است</p>
                        </div>
                        
                        <div id="saved-attributes-area" class="mt-3 pt-3 border-t border-gray-200 dark:border-white/10 hidden">
                            <p class="text-[9px] text-gray-400 mb-2">پیشنهاد از ویژگی‌های قبلی:</p>
                            <div id="saved-attrs-chips" class="flex flex-wrap gap-1"></div>
                        </div>
                    </div>

                </div>

                <div id="step-content-2" class="step-content space-y-6">
                    
                    <div class="bg-gradient-to-br from-red-50 to-white dark:from-red-900/10 dark:to-transparent p-5 rounded-2xl border border-red-100 dark:border-red-900/30 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full blur-xl pointer-events-none"></div>
                        <div class="relative z-10">
                            <h4 class="text-sm font-black text-red-500 mb-4 flex items-center gap-2"><i class="fas fa-tags"></i> تنظیمات تخفیف</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">درصد تخفیف</label>
                                    <div class="relative">
                                        <input type="number" id="prod-discount-percent" oninput="calculateFinalPrice()" class="input-premium w-full p-3 rounded-xl text-center font-black text-lg outline-none" placeholder="0">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">عنوان (اختیاری)</label>
                                    <input type="text" id="prod-discount-label" class="input-premium w-full p-3 rounded-xl text-center font-bold text-xs" placeholder="مثلا: یلدا">
                                </div>
                            </div>
                            <div class="bg-white/60 dark:bg-black/20 p-3 rounded-xl flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-400">قیمت نهایی فروش:</span>
                                <span class="text-lg font-black text-green-600 dark:text-green-400 price-font" id="final-price-preview">---</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5">
                            <h4 class="text-xs font-black text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2"><i class="fas fa-boxes text-brand-gold"></i> انبار</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[9px] font-bold text-gray-500 mb-1">موجودی فعلی</label>
                                    <input type="number" id="prod-stock" class="input-premium w-full p-2 rounded-lg text-center font-mono text-sm" placeholder="∞">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-gray-500 mb-1">حد هشدار</label>
                                    <input type="number" id="prod-threshold" class="input-premium w-full p-2 rounded-lg text-center font-mono text-sm" value="5">
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5">
                            <h4 class="text-xs font-black text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2"><i class="fas fa-truck text-blue-500"></i> ارسال</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[9px] font-bold text-gray-500 mb-1">هزینه ارسال (تومان)</label>
                                    <input type="text" id="prod-shipping" inputmode="numeric" onkeyup="formatPriceInput(this)" class="input-premium w-full p-2 rounded-lg text-center font-mono text-sm" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-gray-500 mb-1">نوع محصول</label>
                                    <select id="prod-type" onchange="toggleFileUrl(this.value)" class="input-premium w-full p-2 rounded-lg text-xs font-bold text-center">
                                        <option value="physical">فیزیکی</option>
                                        <option value="digital">دانلودی / مجازی</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="file-url-wrapper" class="hidden animate-fade-in-up">
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 flex items-center gap-2"><i class="fas fa-cloud-download-alt text-blue-500"></i> لینک فایل دانلودی</label>
                        <input type="url" id="product-file-url" class="input-premium w-full p-3.5 rounded-xl bg-blue-50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-900/30 text-blue-600 dark:text-blue-300 outline-none text-xs font-mono text-left dir-ltr" placeholder="https://example.com/file.zip">
                        <p class="text-[9px] text-gray-400 mt-1 mr-1">این لینک بعد از پرداخت موفق به مشتری نمایش داده می‌شود.</p>
                    </div>

                </div>

            </form>

            <div class="p-5 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] lg:rounded-b-3xl flex flex-col md:flex-row gap-3 z-20 pb-safe">
                <button type="button" id="btn-delete-product" onclick="deleteProduct()" class="hidden md:w-auto w-full bg-red-50 dark:bg-red-900/10 text-red-500 border border-red-200 dark:border-red-900/30 font-bold py-3 px-5 rounded-xl transition hover:bg-red-100 dark:hover:bg-red-900/20 flex items-center justify-center gap-2 text-xs">
                    <i class="fas fa-trash"></i>
                </button>
                <button type="button" id="btn-save-product" onclick="saveProduct()" class="flex-1 bg-brand-gold hover:bg-white hover:text-black hover:ring-2 hover:ring-brand-gold text-black font-black py-3.5 rounded-xl transition transform active:scale-[0.98] shadow-gold flex items-center justify-center gap-2 text-sm cursor-pointer">
                    <span>ذخیره و انتشار</span> <i class="fas fa-rocket"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="shop-settings-modal" class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg lg:rounded-2xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] mobile-sheet lg:animate-slide-up">
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 lg:rounded-t-2xl rounded-t-[2rem]">
                <div>
                    <h3 class="text-lg font-black text-gray-900 dark:text-white">تنظیمات سیستم</h3>
                    <p class="text-[10px] text-gray-500">مدیریت زیرساخت</p>
                </div>
                <button onclick="document.getElementById('shop-settings-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="px-5 pt-3 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button class="tab-btn active-tab" onclick="switchConfigTab(this, 'conf-financial')">مالی</button>
                <button class="tab-btn" onclick="switchConfigTab(this, 'conf-cats')">مدیریت محصول</button>
                <button class="tab-btn" onclick="switchConfigTab(this, 'conf-general')">ارسال</button>
            </div>
            <div class="p-5 space-y-5 overflow-y-auto custom-scrollbar flex-1 pb-24 lg:pb-6">
                
                <div id="conf-financial" class="config-tab-content space-y-4">
                    <div class="bg-white dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/5 relative overflow-hidden">
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <h4 class="font-bold text-sm text-gray-900 dark:text-white mb-1">درگاه پرداخت</h4>
                                <div id="kyc-status-badge" class="inline-flex items-center gap-2 bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-lg text-[10px] font-bold">
                                    <span class="relative flex h-1.5 w-1.5"><span id="kyc-pulse" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-yellow-500"></span></span>
                                    <span id="kyc-status-text">انتظار مدارک</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 bg-gray-50 dark:bg-white/10 rounded-lg flex items-center justify-center text-gray-400"><i class="fas fa-university"></i></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                         <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1.5">کد ملی</label>
                            <input type="text" id="kyc-nid" maxlength="10" class="input-premium w-full p-3 rounded-xl text-gray-900 dark:text-white outline-none font-mono text-center dir-ltr tracking-widest text-xs" placeholder="0012345678">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1.5">شماره شبا</label>
                            <div class="relative">
                                <input type="text" id="kyc-iban" maxlength="26" class="input-premium w-full p-3 pl-10 rounded-xl text-gray-900 dark:text-white outline-none font-mono text-left dir-ltr uppercase text-xs" placeholder="IR120120...">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">IR</span>
                            </div>
                        </div>
                        <button onclick="submitKYC()" id="btn-kyc-submit" class="w-full bg-black dark:bg-white text-white dark:text-black font-black py-3 rounded-xl shadow-lg hover:scale-[1.02] transition flex items-center justify-center gap-2 cursor-pointer text-xs">
                            <span>ثبت درگاه</span> <i class="fas fa-fingerprint"></i>
                        </button>
                    </div>
                </div>

                <div id="conf-cats" class="config-tab-content hidden space-y-5">
                    
                    <div>
                        <h4 class="text-xs font-black text-gray-800 dark:text-white mb-3">دسته‌بندی‌های فروشگاه</h4>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="new-cat-title-input-conf" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-xs font-bold focus:border-brand-gold outline-none" placeholder="نام دسته جدید...">
                            <button onclick="createCategory(true)" class="bg-black dark:bg-white text-white dark:text-black w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div id="categories-list-container" class="space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar"></div>
                    </div>

                    <hr class="border-gray-100 dark:border-white/5">

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xs font-black text-gray-800 dark:text-white">ویژگی‌های ذخیره شده</h4>
                            <span class="text-[9px] text-gray-400">موجود در حافظه</span>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="new-global-attr-input" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-xs font-bold focus:border-brand-gold outline-none" placeholder="عنوان ویژگی (مثلا: جنس)">
                            <button onclick="saveGlobalAttribute()" class="bg-brand-gold text-black w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition"><i class="fas fa-save text-xs"></i></button>
                        </div>
                        <div id="global-attrs-list" class="flex flex-wrap gap-2">
                            </div>
                    </div>

                </div>

                <div id="conf-general" class="config-tab-content hidden space-y-3">
                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/5">
                        <label class="block text-xs font-bold text-gray-500 mb-2">هزینه ارسال پیش‌فرض</label>
                        <input type="text" id="conf-shipping-base" class="input-premium w-full p-3 rounded-lg font-mono text-xs" placeholder="0" inputmode="numeric">
                    </div>
                     <button onclick="saveShopConfig()" class="w-full mt-2 bg-black dark:bg-white text-white dark:text-black font-black py-3 rounded-xl shadow-lg hover:scale-[1.02] transition text-xs">ذخیره</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-profile-modal" class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg lg:rounded-2xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] mobile-sheet lg:animate-slide-up">
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 lg:rounded-t-2xl rounded-t-[2rem]">
                <div>
                    <h3 class="text-lg font-black text-gray-900 dark:text-white">پروفایل</h3>
                    <p class="text-[10px] text-gray-500">برندینگ فروشگاه</p>
                </div>
                <button onclick="document.getElementById('shop-profile-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-5 overflow-y-auto custom-scrollbar flex-1 pb-24 lg:pb-6">
                <div class="flex flex-col items-center mb-2">
                    <div class="relative w-24 h-24 rounded-full border-2 border-dashed border-gray-300 dark:border-white/20 p-1 mb-2 group cursor-pointer hover:border-brand-gold transition" onclick="document.getElementById('logo-upload-input').click()">
                        <div class="w-full h-full rounded-full bg-gray-50 dark:bg-white/5 overflow-hidden flex items-center justify-center">
                            <img id="settings-logo-preview" src="img/logo01.png" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-[10px] font-bold">ویرایش</div>
                    </div>
                    <input type="file" id="logo-upload-input" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5">نام فروشگاه</label>
                    <input type="text" id="setting-store-name" class="input-premium w-full p-3 rounded-xl text-gray-900 dark:text-white outline-none font-bold text-center text-xs" placeholder="نام برند">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                         <label class="block text-xs font-bold text-gray-500 mb-1.5">رنگ سازمانی</label>
                         <div class="flex items-center gap-2 bg-gray-50 dark:bg-white/5 p-2 rounded-xl border border-gray-100 dark:border-white/5 h-[46px]">
                            <input type="color" id="setting-color" class="w-8 h-8 rounded-lg border-none p-0 cursor-pointer overflow-hidden" value="#D4AF37">
                            <span class="text-[10px] text-gray-400">انتخاب</span>
                         </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1.5">اینستاگرام</label>
                        <input type="text" id="setting-instagram" class="input-premium w-full p-3 rounded-xl text-gray-900 dark:text-white outline-none font-mono text-center dir-ltr text-xs" placeholder="@username">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5">بیوگرافی</label>
                    <textarea id="setting-bio" rows="3" class="input-premium w-full p-3 rounded-xl text-gray-900 dark:text-white outline-none resize-none text-xs" placeholder="توضیحات..."></textarea>
                </div>
            </div>
             <div class="p-5 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] lg:rounded-b-2xl pb-safe">
                <button onclick="saveShopProfile()" class="w-full bg-brand-gold text-black font-black py-3 rounded-xl shadow-gold hover:scale-[1.02] transition cursor-pointer text-xs">ذخیره تغییرات</button>
            </div>
        </div>
    </div>

    <div id="order-action-modal" class="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg lg:rounded-2xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative animate-slide-up flex flex-col max-h-[90vh] mobile-sheet">
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] lg:rounded-t-2xl rounded-t-[2rem] z-10">
                <div>
                    <h3 class="font-black text-gray-900 dark:text-white text-base flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar text-brand-gold"></i> جزئیات سفارش
                    </h3>
                </div>
                <button onclick="closeOrderAction()" class="w-8 h-8 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto custom-scrollbar space-y-4 pb-safe">
                <div class="space-y-2">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">خریدار</h4>
                    <div class="bg-gray-50 dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/5 grid gap-3">
                        <div class="flex items-center justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm"><i class="fas fa-user"></i></div>
                                <div>
                                    <h4 class="font-bold text-xs text-gray-900 dark:text-white" id="modal-customer-name">...</h4>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <a href="#" id="modal-call-btn" class="w-7 h-7 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition"><i class="fas fa-phone text-xs"></i></a>
                                <a href="#" id="modal-sms-btn" class="w-7 h-7 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 transition"><i class="fas fa-comment text-xs"></i></a>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-white dark:bg-black/20 p-2 rounded-lg border border-gray-100 dark:border-white/5">
                                <label class="text-[8px] text-gray-400 block mb-1">تلفن</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-[10px]" id="modal-customer-phone">...</span>
                                    <button onclick="copyText('modal-customer-phone')" class="text-gray-400 hover:text-brand-gold text-xs"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-black/20 p-2 rounded-lg border border-gray-100 dark:border-white/5">
                                <label class="text-[8px] text-gray-400 block mb-1">کد پستی</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-[10px]" id="modal-customer-postal">...</span>
                                    <button onclick="copyText('modal-customer-postal')" class="text-gray-400 hover:text-brand-gold text-xs"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-black/20 p-2 rounded-lg border border-gray-100 dark:border-white/5 relative">
                            <label class="text-[8px] text-gray-400 block mb-1">آدرس</label>
                            <p class="text-[10px] font-medium leading-relaxed pr-6" id="modal-customer-address">...</p>
                            <button onclick="copyText('modal-customer-address')" class="absolute top-2 right-2 text-gray-400 hover:text-brand-gold text-xs"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <h4 class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">اقلام</h4>
                    <div class="bg-white dark:bg-white/5 p-2 rounded-xl border border-brand-gold/30 shadow-sm flex gap-3">
                        <div class="w-16 h-16 bg-gray-100 dark:bg-black rounded-lg border border-gray-200 dark:border-white/10 flex items-center justify-center p-1 overflow-hidden">
                            <img id="modal-product-img" src="img/logo01.png" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1 flex flex-col justify-between py-1">
                            <div>
                                <h5 class="font-black text-xs text-gray-900 dark:text-white line-clamp-1" id="modal-product-name">...</h5>
                                <div class="flex flex-wrap gap-1 mt-1" id="modal-product-variants"></div>
                            </div>
                            <div class="flex justify-between items-end border-t border-dashed border-gray-200 dark:border-white/10 pt-1">
                                <span class="text-[10px] text-gray-500 font-bold">تعداد: <span class="text-black dark:text-white" id="modal-order-qty">1</span></span>
                                <span class="font-black text-brand-gold text-sm font-mono" id="modal-order-total">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-dashed border-gray-100 dark:border-white/5 pt-3">
                     <div id="order-action-paid" class="hidden space-y-3">
                        <label class="block text-[10px] font-bold text-gray-500">وضعیت: <span class="text-yellow-600">در انتظار ارسال</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="tracking-input" class="flex-1 p-2.5 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center text-xs placeholder-gray-400" placeholder="کد رهگیری">
                            <button onclick="submitTrackingCode()" class="bg-black dark:bg-white text-white dark:text-black font-bold px-4 rounded-xl hover:opacity-80 transition shadow-lg whitespace-nowrap cursor-pointer text-xs">
                                ثبت
                            </button>
                        </div>
                    </div>

                    <div id="order-action-sent" class="hidden text-center bg-green-50 dark:bg-green-900/10 p-3 rounded-xl border border-green-100 dark:border-green-900/30">
                        <div class="flex items-center justify-center gap-1.5 text-green-600 mb-1">
                            <i class="fas fa-check-circle"></i> <span class="font-bold text-xs">ارسال شده</span>
                        </div>
                        <div class="flex items-center justify-center gap-2">
                             <span class="text-[10px] text-gray-500">کد:</span>
                             <span class="font-mono font-bold text-gray-900 dark:text-white select-all text-sm tracking-widest" id="display-tracking-code">---</span>
                             <button onclick="copyText('display-tracking-code')" class="text-gray-400 hover:text-green-500 text-xs"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="upgrade-modal" class="fixed inset-0 z-[90] bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl border border-gray-200 shadow-2xl relative animate-slide-up overflow-hidden text-gray-900">
            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-gold/10 rounded-full blur-[50px] pointer-events-none"></div>
            
            <button onclick="closeUpgradeModal()" class="absolute top-4 right-4 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition z-10 cursor-pointer text-gray-500">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="p-8 text-center relative z-10">
                <div class="w-14 h-14 bg-gradient-to-br from-brand-gold to-yellow-500 rounded-2xl flex items-center justify-center text-black font-black text-2xl shadow-gold mx-auto mb-4">
                    <i class="fas fa-crown"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-900 mb-2">گسترش امپراتوری</h2>
                <p class="text-gray-500 text-xs mb-6">پلن مناسب کسب‌وکارتان را انتخاب کنید.</p>
                
                <div class="grid md:grid-cols-2 gap-4 text-left">
                    <div class="plan-card bg-gray-50 rounded-2xl p-5 relative cursor-pointer border border-gray-200 hover:border-gray-300 transition" onclick="selectPlan(this, 'pro')">
                        <div class="absolute -top-2 right-4 bg-gray-700 text-white text-[8px] font-bold px-2 py-0.5 rounded">اقتصادی</div>
                        <h4 class="text-lg font-bold text-gray-900 mb-0.5">حرفه‌ای</h4>
                        <div class="text-xl font-black text-brand-gold mb-3">۱۹۹ <span class="text-[10px] font-normal text-gray-400">هزار تومان/ماه</span></div>
                        <ul class="space-y-1.5 text-[10px] text-gray-600 mb-4">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> ۵۰ محصول</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> درگاه اختصاصی</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> پشتیبانی</li>
                        </ul>
                        <button class="w-full bg-white border border-gray-200 hover:bg-gray-100 text-gray-900 font-bold py-2 rounded-xl text-xs transition" onclick="initiatePayment('pro')">انتخاب</button>
                    </div>

                    <div class="plan-card active bg-brand-gold/10 border-2 border-brand-gold rounded-2xl p-5 relative cursor-pointer" onclick="selectPlan(this, 'vip')">
                        <div class="absolute -top-2 right-4 bg-brand-gold text-black text-[8px] font-black px-2 py-0.5 rounded shadow-gold">پیشنهاد ویژه</div>
                        <h4 class="text-lg font-bold text-gray-900 mb-0.5">لجند (VIP)</h4>
                        <div class="text-xl font-black text-brand-gold mb-3">۴۹۹ <span class="text-[10px] font-normal text-gray-500">هزار تومان/ماه</span></div>
                        <ul class="space-y-1.5 text-[10px] text-gray-700 mb-4">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> <strong>محصول نامحدود</strong></li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> <strong>هوش مصنوعی (AI)</strong></li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> دامنه اختصاصی</li>
                        </ul>
                        <button class="w-full bg-brand-gold hover:bg-yellow-500 text-black font-black py-2 rounded-xl text-xs transition shadow-gold" onclick="initiatePayment('vip')">انتخاب</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // --- 1. CONFIGURATION ---
        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let uploadedImages = [];
        let editingProductId = null;
        let salesChart = null;
        let activeOrderId = null;
        let storeProfile = null;
        let newLogoUrl = null;
        let realtimeChannel = null;
        let allOrdersCache = [];
        let productsMap = {};
        let storeCategories = []; // Cached categories
        
        let currentUserPlan = 'free';
        let currentProductCount = 0;

        // --- GLOBAL UTILS ---
        window.formatPriceInput = (input) => {
            let val = input.value.replace(/\D/g, '');
            if(!val) { input.value = ''; return; }
            input.value = new Intl.NumberFormat('en-US').format(val);
        };

        const cleanPrice = (str) => {
            if(!str) return 0;
            const englishStr = str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            return parseInt(englishStr.replace(/\D/g, '')) || 0;
        };

        const toEnglishDigits = (str) => {
            if(!str) return '';
            return str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/,/g, '');
        };

        const formatMoney = (n) => new Intl.NumberFormat('fa-IR').format(n);
        
        window.showToast = (msg, type='success') => {
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "center",
                style: { 
                    background: type === 'success' ? "#10B981" : (type === 'error' ? "#EF4444" : "#F59E0B"), 
                    borderRadius: "12px", 
                    fontSize: "12px", 
                    fontFamily: "Vazirmatn", 
                    fontWeight: "bold",
                    boxShadow: "0 4px 15px rgba(0,0,0,0.2)"
                }
            }).showToast();
        };

        window.copyText = (elementId) => {
            const el = document.getElementById(elementId);
            if(el) {
                navigator.clipboard.writeText(el.innerText);
                window.showToast('کپی شد', 'success');
            }
        };

        // --- INITIALIZATION ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            document.getElementById('themeToggleBtn').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });
        }
        initTheme();

        async function initApp() {
            const loader = document.getElementById('page-loader');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { window.location.href = 'index.html'; return; }
                currentUser = user;

                await Promise.all([
                    loadStoreProducts(),
                    loadOrders(),
                    loadProfile(),
                    loadCategories()
                ]);

                loadDashboardStats('7');
                subscribeToOrders();
                setWelcomeMessage(); // New Welcome Logic
                loadSavedGlobalAttributes(); // Load Saved Attributes

            } catch (err) {
                console.error("Init Error:", err);
                window.showToast("خطا در ارتباط با سرور", "error");
            } finally {
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 700);
                }
            }
        }
        initApp();

        // --- WELCOME MESSAGE LOGIC ---
        function setWelcomeMessage() {
            const hour = new Date().getHours();
            let greeting = 'خوش آمدید';
            if (hour >= 5 && hour < 12) greeting = 'صبح بخیر فرمانده';
            else if (hour >= 12 && hour < 18) greeting = 'ظهر بخیر فرمانده';
            else greeting = 'شب بخیر فرمانده';
            
            const msgEl = document.getElementById('welcome-message');
            if(msgEl) msgEl.innerText = greeting;
        }

        // --- REALTIME ---
        function subscribeToOrders() {
            if (realtimeChannel) return;
            realtimeChannel = supabase
                .channel('public:store_orders')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'store_orders', filter: `seller_id=eq.${currentUser.id}` }, payload => {
                    handleOrderUpdate(payload);
                })
                .subscribe();
        }

        function handleOrderUpdate(payload) {
            const eventType = payload.eventType;
            const newOrder = payload.new;
            
            if (eventType === 'INSERT') {
                window.showToast(`سفارش جدید! مبلغ: ${formatMoney(newOrder.total_amount)} تومان`, 'success');
                allOrdersCache.unshift(newOrder);
                renderSingleOrderRow(newOrder, true);
                
                const badges = document.querySelectorAll('#sidebar-badge-orders, #mobile-badge-orders');
                badges.forEach(b => b.classList.remove('hidden'));
            } 
            else if (eventType === 'UPDATE') {
                const index = allOrdersCache.findIndex(o => o.id === newOrder.id);
                if (index !== -1) {
                    allOrdersCache[index] = newOrder;
                    renderOrdersList(); 
                }
            }
            updateAnalytics(); 
        }

        window.refreshOrdersData = async () => {
            const btn = document.getElementById('refresh-orders-btn');
            if(btn) {
                const icon = btn.querySelector('i');
                if(icon) icon.classList.add('spin-fast'); 
                btn.disabled = true;
            }
            try {
                await loadOrders();
                window.showToast('اطلاعات بروزرسانی شد', 'success');
            } catch (e) { window.showToast('خطا در بروزرسانی', 'error'); } 
            finally { 
                if(btn) {
                    const icon = btn.querySelector('i');
                    if(icon) icon.classList.remove('spin-fast'); 
                    btn.disabled = false; 
                }
            }
        };

        // --- DASHBOARD LOGIC ---
        window.updateAnalytics = () => { loadDashboardStats(document.getElementById('chart-filter').value); };

        async function loadDashboardStats(range = '7') {
            const now = new Date();
            const cutoff = new Date();
            if (range !== 'all') cutoff.setDate(now.getDate() - parseInt(range));
            else cutoff.setFullYear(2000); 

            const filteredOrders = allOrdersCache.filter(o => new Date(o.created_at) > cutoff && o.status !== 'cancelled');
            let totalSales = 0;
            const paidOrders = filteredOrders.filter(o => o.status === 'paid' || o.status === 'sent');
            paidOrders.forEach(o => totalSales += Number(o.total_amount || 0));

            document.getElementById('dash-total-sales').innerText = formatMoney(totalSales);
            document.getElementById('dash-order-count').innerText = new Intl.NumberFormat('fa-IR').format(filteredOrders.length);
            document.getElementById('dash-views').innerText = new Intl.NumberFormat('fa-IR').format(paidOrders.length * 5 + 120);

            renderChart(paidOrders, range);
            renderTopProducts(paidOrders);
        }

        function renderTopProducts(orders) {
            const productCounts = {};
            orders.forEach(o => { 
                if(o.items && Array.isArray(o.items)) {
                    o.items.forEach(item => {
                        const pId = item.id || item.product_id;
                        productCounts[pId] = (productCounts[pId] || 0) + (item.quantity || 1);
                    });
                }
            });

            const sortedIds = Object.keys(productCounts).sort((a,b) => productCounts[b] - productCounts[a]).slice(0, 3);
            const list = document.getElementById('top-products-list');
            list.innerHTML = '';
            
            if(sortedIds.length === 0) {
                list.innerHTML = '<div class="text-center py-4 opacity-50"><p class="text-xs">داده‌ای موجود نیست</p></div>';
                return;
            }

            sortedIds.forEach((id, idx) => {
                const count = productCounts[id];
                const product = productsMap[id] || { title: 'محصول حذف شده', image_url: 'img/logo01.png' };
                let pImg = 'img/logo01.png';
                
                if(product.image_url) {
                    try { 
                        const parsed = JSON.parse(product.image_url); 
                        if(Array.isArray(parsed) && parsed.length) pImg = parsed[0]; 
                        else pImg = product.image_url;
                    } catch(e){ pImg = product.image_url; }
                }

                list.innerHTML += `
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-white/5 rounded-lg border border-gray-100 dark:border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/10 p-0.5 overflow-hidden">
                                <img src="${pImg}" class="w-full h-full object-contain">
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-900 dark:text-white line-clamp-1">${product.title}</h4>
                                <span class="text-[9px] text-gray-400">فروش: ${count} عدد</span>
                            </div>
                        </div>
                        <div class="w-5 h-5 rounded-full ${idx === 0 ? 'bg-yellow-400' : (idx===1 ? 'bg-gray-300' : 'bg-orange-300')} text-white flex items-center justify-center text-[9px] font-bold shadow-sm">${idx+1}</div>
                    </div>`;
            });
        }

        function renderChart(orders, range) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            let labels = [];
            const grouped = {};

            const days = range === 'all' ? 30 : parseInt(range);
            for(let i=days-1; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('fa-IR');
                grouped[dateStr] = 0;
                labels.push(dateStr);
            }

            orders.forEach(o => {
                const date = new Date(o.created_at).toLocaleDateString('fa-IR');
                if(grouped[date] !== undefined) grouped[date] += Number(o.total_amount);
            });

            const dataPoints = labels.map(k => grouped[k]);

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'فروش', data: dataPoints, borderColor: '#D4AF37',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(212,175,55,0.2)');
                            gradient.addColorStop(1, 'rgba(212,175,55,0)');
                            return gradient;
                        },
                        borderWidth: 2, pointBackgroundColor: '#fff', pointBorderColor: '#D4AF37', fill: true, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#999', font: { family: 'Vazirmatn', size: 9 }, maxTicksLimit: 7 } },
                        y: { border: { display: false }, grid: { color: 'rgba(200,200,200,0.1)' }, ticks: { display: false } }
                    }
                }
            });
        }

        // --- PRODUCTS LOGIC ---
        async function loadStoreProducts() {
            const grid = document.getElementById('products-grid');
            const { data: products } = await supabase.from('store_products').select('*').eq('seller_id', currentUser.id).order('created_at', { ascending: false });
            
            grid.innerHTML = '';
            productsMap = {}; 
            currentProductCount = products ? products.length : 0; 

            if (!products || products.length === 0) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-10 text-gray-400 border-2 border-dashed border-gray-200 dark:border-white/10 rounded-2xl"><i class="fas fa-box-open text-3xl mb-2 opacity-50"></i><p class="text-xs">بدون محصول</p></div>`;
                return;
            }

            products.forEach(p => {
                productsMap[p.id] = p; 
                let imgUrl = 'img/logo01.png';
                try {
                    if(p.image_url) {
                         if (p.image_url.startsWith('[')) {
                             const parsed = JSON.parse(p.image_url);
                             if(Array.isArray(parsed) && parsed.length) imgUrl = parsed[0];
                         } else {
                             imgUrl = p.image_url;
                         }
                    }
                } catch(e){ console.error('Image parse error', e); }

                const card = document.createElement('div');
                card.className = "group bg-white dark:bg-[#151515] rounded-xl border border-gray-100 dark:border-white/5 overflow-hidden hover:shadow-gold transition-all duration-300";
                
                card.innerHTML = `
                    <div class="relative w-full aspect-square bg-gray-50 dark:bg-white/5 p-3 flex items-center justify-center">
                        <img src="${imgUrl}" class="w-full h-full object-cover rounded-lg transition-transform duration-500 group-hover:scale-105 shadow-sm">
                        <div class="absolute top-2 right-2 bg-black/60 backdrop-blur px-1.5 py-0.5 rounded-md text-[8px] text-white">
                             ${p.type === 'digital' ? '<i class="fas fa-download text-brand-gold"></i>' : '<i class="fas fa-box text-blue-400"></i>'}
                        </div>
                    </div>
                    <div class="p-2.5">
                        <h4 class="font-bold text-xs text-gray-900 dark:text-white truncate">${p.title}</h4>
                        <p class="text-brand-gold font-black text-xs mt-0.5">${formatMoney(p.price)}</p>
                        <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-gray-50 dark:border-white/5">
                            <button class="bg-gray-100 dark:bg-white/10 hover:bg-gray-200 text-gray-600 dark:text-gray-300 py-1.5 rounded-lg text-[9px] font-bold transition edit-btn">ویرایش</button>
                            <button onclick="window.showLink('${p.id}')" class="bg-black text-white dark:bg-white dark:text-black py-1.5 rounded-lg text-[9px] font-bold transition flex items-center justify-center gap-1 hover:opacity-80">لینک <i class="fas fa-share"></i></button>
                        </div>
                    </div>
                `;
                card.querySelector('.edit-btn').onclick = () => window.openProductModal(p);
                grid.appendChild(card);
            });
        }

        window.deleteProduct = async () => {
            if(!editingProductId) return;
            if(!confirm('آیا از حذف این محصول مطمئن هستید؟')) return;
            
            const btn = document.getElementById('btn-delete-product');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            
            const { error } = await supabase.from('store_products').delete().eq('id', editingProductId);
            
            if(error) { 
                window.showToast('خطا در حذف محصول', 'error'); 
                btn.innerHTML = '<i class="fas fa-trash"></i>'; btn.disabled = false; 
            } else { 
                window.showToast('محصول حذف شد'); 
                window.closeProductModal(); 
                loadStoreProducts(); 
            }
        };

        // --- IMAGE UPLOAD LOGIC ---
        const compressImageToBlob = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); 
                        const scale = 800 / img.width; 
                        canvas.width = 800; canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/webp', 0.85); 
                    }
                }
            })
        };

        window.handleImageUpload = async (input) => {
            if(!input.files.length) return;
            const uploadBtn = document.getElementById('upload-trigger-btn');
            if(uploadBtn) uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
            try {
                for(let file of input.files) {
                    window.showToast('در حال آپلود...', 'info');
                    const blob = await compressImageToBlob(file);
                    const cleanName = `${Date.now()}_${Math.random().toString(36).substring(7)}.webp`;
                    const fileName = `${currentUser.id}/${cleanName}`;
                    
                    const { error } = await supabase.storage.from('product-images').upload(fileName, blob, { contentType: 'image/webp', upsert: false });
                    if (error) throw error; 
                    
                    const { data: { publicUrl } } = supabase.storage.from('product-images').getPublicUrl(fileName);
                    uploadedImages.push(publicUrl);
                }
                renderPreviews();
                window.showToast('تصویر افزوده شد');
            } catch (err) {
                console.error(err);
                window.showToast('خطا در آپلود', 'error');
            } finally {
                if(uploadBtn) uploadBtn.innerHTML = '<i class="fas fa-camera text-xl mb-1 transition"></i><span class="text-[8px] font-bold">افزودن عکس</span>';
                input.value = '';
            }
        };

        function renderPreviews() {
            const c = document.getElementById('image-previews-container');
            c.innerHTML = '';
            uploadedImages.forEach((imgUrl, idx) => {
                c.innerHTML += `
                    <div class="relative w-20 h-20 flex-shrink-0 group rounded-2xl overflow-hidden border border-gray-200 dark:border-white/10">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        <div onclick="window.removeImg(${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] cursor-pointer shadow-sm z-10 hover:bg-red-600 transition"><i class="fas fa-times"></i></div>
                        ${idx === 0 ? '<div class="absolute bottom-0 left-0 w-full bg-brand-gold text-black text-[8px] font-bold text-center py-0.5 backdrop-blur-sm">کاور</div>' : ''}
                    </div>`;
            });
        }
        window.removeImg = (i) => { uploadedImages.splice(i, 1); renderPreviews(); };

        // --- CATEGORIES LOGIC (SYNCED) ---
        async function loadCategories() {
            const dropdown = document.getElementById('prod-category');
            if(!dropdown) return;
            
            const { data, error } = await supabase.from('store_categories').select('*').eq('user_id', currentUser.id);
            storeCategories = data || [];
            
            updateCategoryDropdown();
            renderCategoriesListInSettings();
        }

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('prod-category');
            dropdown.innerHTML = '<option value="">انتخاب کنید...</option>';
            
            storeCategories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.title; 
                opt.innerText = c.title;
                dropdown.appendChild(opt);
            });
        }

        window.toggleNewCategoryInput = () => {
            const inputWrapper = document.getElementById('new-category-input-wrapper');
            const selectWrapper = document.getElementById('category-select-wrapper');
            
            if(inputWrapper.classList.contains('hidden')) {
                inputWrapper.classList.remove('hidden');
                selectWrapper.classList.add('hidden');
                document.getElementById('new-cat-inline-input').focus();
            } else {
                inputWrapper.classList.add('hidden');
                selectWrapper.classList.remove('hidden');
            }
        };

        window.createCategoryInline = async () => {
            const input = document.getElementById('new-cat-inline-input');
            const title = input.value.trim();
            if(!title) return;
            
            await createCategoryLogic(title);
            
            // UI Cleanup
            input.value = '';
            toggleNewCategoryInput();
            document.getElementById('prod-category').value = title; // Select new cat
        };

        window.createCategory = async (isSettings = false) => {
            const inputId = isSettings ? 'new-cat-title-input-conf' : 'new-cat-inline-input';
            const input = document.getElementById(inputId);
            const title = input.value.trim();
            if(!title) return;
            await createCategoryLogic(title);
            input.value = '';
        };

        async function createCategoryLogic(title) {
            const { data, error } = await supabase.from('store_categories').insert([{ user_id: currentUser.id, title: title }]).select();
            if(error) {
                window.showToast('خطا در ساخت دسته', 'error');
            } else {
                window.showToast('دسته‌بندی ساخته شد');
                storeCategories.push(data[0]);
                updateCategoryDropdown();
                renderCategoriesListInSettings();
            }
        }
        
        window.deleteCategory = async (id) => {
            if(!confirm('آیا از حذف این دسته مطمئن هستید؟')) return;
            const { error } = await supabase.from('store_categories').delete().eq('id', id);
            if(error) window.showToast('خطا در حذف', 'error');
            else { 
                window.showToast('حذف شد'); 
                storeCategories = storeCategories.filter(c => c.id !== id);
                updateCategoryDropdown();
                renderCategoriesListInSettings();
            }
        };

        function renderCategoriesListInSettings() {
            const listContainer = document.getElementById('categories-list-container');
            if(!listContainer) return;
            listContainer.innerHTML = '';
            
            if(storeCategories.length === 0) {
                listContainer.innerHTML = '<p class="text-[10px] text-gray-400 text-center">هنوز دسته‌ای نساخته‌اید</p>';
                return;
            }

            storeCategories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 dark:bg-white/5 p-3 rounded-xl border border-gray-100 dark:border-white/5';
                item.innerHTML = `<span class="text-xs font-bold text-gray-700 dark:text-gray-300">${cat.title}</span><i class="fas fa-trash text-red-500 cursor-pointer p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition text-xs" onclick="window.deleteCategory(${cat.id})"></i>`;
                listContainer.appendChild(item);
            });
        }

        // --- GLOBAL ATTRIBUTES (LOCAL STORAGE) ---
        function loadSavedGlobalAttributes() {
            const saved = localStorage.getItem(`wl_global_attrs_${currentUser.id}`);
            const list = document.getElementById('global-attrs-list');
            const chips = document.getElementById('saved-attrs-chips');
            const area = document.getElementById('saved-attributes-area');
            
            list.innerHTML = '';
            chips.innerHTML = '';
            
            if(saved) {
                const attrs = JSON.parse(saved);
                if(attrs.length > 0) area.classList.remove('hidden');
                
                attrs.forEach(attr => {
                    // Settings List
                    list.innerHTML += `<div class="bg-gray-100 dark:bg-white/10 px-3 py-1.5 rounded-lg text-[10px] font-bold flex items-center gap-2">${attr} <i class="fas fa-times cursor-pointer text-red-500 hover:text-red-700" onclick="removeGlobalAttr('${attr}')"></i></div>`;
                    
                    // Product Form Suggestions
                    chips.innerHTML += `<div class="px-2 py-1 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-md text-[10px] cursor-pointer hover:border-brand-gold transition" onclick="addAttributeBlock('custom', '${attr}')">${attr}</div>`;
                });
            } else {
                list.innerHTML = '<p class="text-[9px] text-gray-400">موردی ذخیره نشده</p>';
            }
        }

        window.saveGlobalAttribute = () => {
            const input = document.getElementById('new-global-attr-input');
            const val = input.value.trim();
            if(!val) return;
            
            let saved = JSON.parse(localStorage.getItem(`wl_global_attrs_${currentUser.id}`) || '[]');
            if(!saved.includes(val)) {
                saved.push(val);
                localStorage.setItem(`wl_global_attrs_${currentUser.id}`, JSON.stringify(saved));
                loadSavedGlobalAttributes();
                window.showToast('ویژگی ذخیره شد');
            }
            input.value = '';
        };

        window.removeGlobalAttr = (val) => {
            let saved = JSON.parse(localStorage.getItem(`wl_global_attrs_${currentUser.id}`) || '[]');
            saved = saved.filter(s => s !== val);
            localStorage.setItem(`wl_global_attrs_${currentUser.id}`, JSON.stringify(saved));
            loadSavedGlobalAttributes();
        };

        // --- ATTRIBUTES & EDITOR LOGIC ---
        window.execCmd = (command) => {
            document.execCommand(command, false, null);
        };

        window.addAttributeBlock = (type, presetTitle = '') => {
            const c = document.getElementById('attributes-container');
            document.getElementById('no-attr-msg').style.display = 'none';
            const id = Date.now();
            let content = '';
            
            if(type === 'colors') {
                const palette = ['#000000','#FFFFFF','#1F2937','#DC2626','#2563EB','#059669','#D97706','#7C3AED'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm" data-type="colors" id="${id}">
                        <div class="flex justify-between mb-2"><span class="text-[10px] font-bold flex items-center gap-2"><i class="fas fa-palette text-gray-400"></i> رنگ‌بندی</span><i class="fas fa-times text-red-500 cursor-pointer text-xs p-1 hover:bg-red-50 rounded" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-2 items-center">
                            ${palette.map(col => `<div class="w-6 h-6 rounded-full cursor-pointer transition transform hover:scale-110 border border-gray-200 dark:border-white/10 color-option" style="background:${col};" data-val="${col}" onclick="this.classList.toggle('ring-2');this.classList.toggle('ring-brand-gold');this.classList.toggle('selected')"></div>`).join('')}
                        </div>
                    </div>`;
            } else if (type === 'sizes') {
                const sizes = ['S','M','L','XL','XXL','36','37','38','39','40','41','42'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm" data-type="sizes" id="${id}">
                        <div class="flex justify-between mb-2"><span class="text-[10px] font-bold flex items-center gap-2"><i class="fas fa-ruler text-gray-400"></i> سایزبندی</span><i class="fas fa-times text-red-500 cursor-pointer text-xs p-1 hover:bg-red-50 rounded" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-1.5">
                            ${sizes.map(s => `<div class="px-2.5 py-1 rounded-lg border border-gray-200 dark:border-white/10 text-[9px] font-bold cursor-pointer hover:border-brand-gold bg-gray-50 dark:bg-white/5 transition select-chip" data-val="${s}" onclick="this.classList.toggle('bg-brand-gold');this.classList.toggle('text-black');this.classList.toggle('selected')">${s}</div>`).join('')}
                        </div>
                    </div>`;
            } else {
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-200 dark:border-white/10 shadow-sm" data-type="custom" id="${id}">
                        <div class="flex justify-between mb-1"><span class="text-[10px] font-bold flex items-center gap-2"><i class="fas fa-pen text-gray-400"></i> ویژگی دلخواه</span><i class="fas fa-times text-red-500 cursor-pointer text-xs p-1 hover:bg-red-50 rounded" onclick="document.getElementById('${id}').remove()"></i></div>
                        <input class="custom-label w-full bg-transparent border-b border-gray-200 dark:border-white/10 text-[10px] mb-2 py-1 outline-none font-bold placeholder-gray-400" placeholder="عنوان ویژگی" value="${presetTitle}">
                        <div class="flex gap-2" onclick="this.querySelector('input').focus()">
                            <input type="text" class="tags-input flex-1 bg-transparent text-[10px] outline-none" placeholder="مقدار را بنویسید و Enter بزنید..." onkeydown="window.handleTagInput(event)">
                        </div>
                        <div class="flex flex-wrap gap-1 mt-2 tag-container"></div>
                    </div>`;
            }
            c.innerHTML += content;
        };

        window.handleTagInput = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); const val = e.target.value.trim();
                if (val) {
                    const container = e.target.parentElement.nextElementSibling;
                    const chip = document.createElement('div'); 
                    chip.className = 'px-2 py-1 bg-gray-100 dark:bg-white/10 rounded-lg text-[9px] font-bold flex items-center gap-1 custom-val-chip'; 
                    chip.dataset.val = val; 
                    chip.innerHTML = `<span>${val}</span><i class="fas fa-times cursor-pointer hover:text-red-500" onclick="this.parentElement.remove()"></i>`;
                    container.appendChild(chip); e.target.value = '';
                }
            }
        };

        // --- PRODUCT TABS LOGIC ---
        window.switchProductStep = (step) => {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.pill-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`step-content-${step}`).classList.add('active');
            document.getElementById(`step-btn-${step}`).classList.add('active');
            
            // Move Indicator
            document.querySelector('.pill-nav').dataset.active = step;
        };

        window.calculateFinalPrice = () => {
            const price = cleanPrice(document.getElementById('prod-price').value);
            const percent = parseInt(document.getElementById('prod-discount-percent').value) || 0;
            const final = price - (price * percent / 100);
            document.getElementById('final-price-preview').innerText = formatMoney(final) + ' تومان';
        };

        window.toggleFileUrl = (type) => {
            const wrapper = document.getElementById('file-url-wrapper');
            if(type === 'digital') wrapper.classList.remove('hidden');
            else wrapper.classList.add('hidden');
        };

        // --- MODAL CONTROL ---
        window.openProductModal = (p = null) => {
            if (!p && currentUserPlan === 'free' && currentProductCount >= 5) {
                window.openUpgradeModal(); return;
            }

            document.getElementById('product-modal').classList.remove('hidden');
            document.getElementById('image-previews-container').innerHTML = '';
            document.getElementById('attributes-container').innerHTML = '<p class="text-[10px] text-gray-400 text-center italic" id="no-attr-msg">هنوز ویژگی اضافه نشده است</p>';
            document.getElementById('rich-text-content').innerHTML = '';
            uploadedImages = []; 
            const delBtn = document.getElementById('btn-delete-product');
            
            window.switchProductStep(1);
            loadSavedGlobalAttributes(); // ensure suggestions are fresh

            if(p) {
                editingProductId = p.id; delBtn.classList.remove('hidden'); 
                document.getElementById('modal-title').innerText = 'ویرایش محصول';
                
                document.getElementById('prod-name').value = p.title || '';
                document.getElementById('prod-price').value = formatMoney(p.price || 0);
                document.getElementById('prod-category').value = p.category || '';
                document.getElementById('prod-stock').value = p.stock_quantity || '';
                document.getElementById('prod-threshold').value = p.low_stock_threshold || 5;
                document.getElementById('prod-short-desc').value = p.short_description || '';
                document.getElementById('rich-text-content').innerHTML = p.description || '';
                document.getElementById('prod-shipping').value = formatMoney(p.shipping_cost || 0);
                document.getElementById('product-file-url').value = p.file_url || '';
                
                if(p.type === 'digital') {
                    document.getElementById('prod-type').value = 'digital';
                    document.getElementById('file-url-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('prod-type').value = 'physical';
                    document.getElementById('file-url-wrapper').classList.add('hidden');
                }
                
                if(p.discount_info) {
                    document.getElementById('prod-discount-percent').value = p.discount_info.percent || '';
                    document.getElementById('prod-discount-label').value = p.discount_info.label || ''; // Assuming label field exists in JSON
                    calculateFinalPrice();
                }

                try { 
                    if(p.image_url) {
                        const parsed = p.image_url.startsWith('[') ? JSON.parse(p.image_url) : [p.image_url];
                        uploadedImages = parsed;
                        renderPreviews(); 
                    }
                } catch(e){}
                
            } else {
                editingProductId = null; delBtn.classList.add('hidden'); 
                document.getElementById('modal-title').innerText = 'خلق محصول جدید';
                document.getElementById('product-form').reset();
                document.getElementById('final-price-preview').innerText = '---';
            }
        };
        
        window.closeProductModal = () => document.getElementById('product-modal').classList.add('hidden');

        window.saveProduct = async () => {
            const btn = document.getElementById('btn-save-product');
            const name = document.getElementById('prod-name').value;
            const price = cleanPrice(document.getElementById('prod-price').value);
            const shipping = cleanPrice(document.getElementById('prod-shipping').value);
            const stock = parseInt(toEnglishDigits(document.getElementById('prod-stock').value)) || 0;
            const threshold = parseInt(toEnglishDigits(document.getElementById('prod-threshold').value)) || 5;
            
            // Discount
            const discountPercent = parseInt(toEnglishDigits(document.getElementById('prod-discount-percent').value)) || 0;
            const discountLabel = document.getElementById('prod-discount-label').value;

            const desc = document.getElementById('rich-text-content').innerHTML; // Get HTML
            const shortDesc = document.getElementById('prod-short-desc').value;
            const fileUrl = document.getElementById('product-file-url').value;
            const category = document.getElementById('prod-category').value;
            const type = document.getElementById('prod-type').value;
            
            if(!name || !price) { 
                window.showToast('نام و قیمت الزامی است', 'error'); 
                window.switchProductStep(1); 
                return; 
            }
            
            btn.classList.add('btn-loading');
            
            const attributes = {};
            document.querySelectorAll('.attr-block').forEach(b => {
                const bType = b.dataset.type;
                if(bType === 'custom') { 
                    const l = b.querySelector('.custom-label').value; const vals = [];
                    b.querySelectorAll('.custom-val-chip').forEach(chip => vals.push(chip.dataset.val));
                    if(l && vals.length) attributes[l] = vals; 
                } else if (bType === 'sizes') {
                    const vals = []; b.querySelectorAll('.select-chip.selected').forEach(s => vals.push(s.dataset.val)); if(vals.length) attributes[bType] = vals; 
                } else { 
                    const vals = []; b.querySelectorAll('.color-option.selected').forEach(s => vals.push(s.dataset.val)); if(vals.length) attributes[bType] = vals; 
                }
            });

            const payload = { 
                seller_id: currentUser.id, 
                title: name, 
                price: price, 
                shipping_cost: shipping, 
                description: desc, 
                short_description: shortDesc, 
                image_url: JSON.stringify(uploadedImages), 
                attributes: attributes, 
                stock_quantity: stock,
                low_stock_threshold: threshold,
                category: category, 
                file_url: fileUrl,
                type: type,
                discount_info: discountPercent > 0 ? { percent: discountPercent, label: discountLabel, active: true } : null,
                is_active: true
            };
            
            let err;
            if(editingProductId) { 
                delete payload.seller_id; 
                const { error } = await supabase.from('store_products').update(payload).eq('id', editingProductId); 
                err = error; 
            } else { 
                const { data, error } = await supabase.from('store_products').insert([payload]).select(); 
                err = error; 
                if(data) window.showLink(data[0].id);
            }
            
            if(err) {
                console.error(err);
                window.showToast('خطا در ذخیره: ' + err.message, 'error');
            } else { 
                window.showToast('محصول با موفقیت ذخیره شد'); 
                window.closeProductModal(); 
                loadStoreProducts(); 
            }
            btn.classList.remove('btn-loading');
        };

        window.showLink = (id) => {
            const link = `${window.location.origin}/sale.html?id=${id}`;
            navigator.clipboard.writeText(link);
            window.showToast('لینک کپی شد!');
        };

        // --- ORDERS LOGIC ---
        async function loadOrders() {
            const { data } = await supabase.from('store_orders').select('*').eq('seller_id', currentUser.id).order('created_at', { ascending: false });
            allOrdersCache = data || [];
            renderOrdersList();
        }

        function renderOrdersList() {
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            const badge = document.getElementById('total-orders-badge');
            if(badge) badge.innerText = allOrdersCache.length;
            
            if(desktopBody) desktopBody.innerHTML = ''; 
            if(mobileList) mobileList.innerHTML = '';

            if (allOrdersCache.length === 0) {
                if(mobileList) mobileList.innerHTML = `<div id="no-orders-msg" class="text-center py-10 text-gray-400">هنوز سفارشی ثبت نشده است</div>`;
                if(desktopBody) desktopBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-400">هنوز سفارشی ثبت نشده است</td></tr>`;
                return;
            }
            allOrdersCache.forEach(o => renderSingleOrderRow(o));
        }

        function renderSingleOrderRow(o, prepend = false) {
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            
            const statusConfig = {
                'pending_payment': { label: 'در انتظار', class: 'bg-yellow-100 text-yellow-700', icon: 'fa-clock' },
                'paid': { label: 'پرداخت شده', class: 'bg-green-100 text-green-700', icon: 'fa-check' },
                'sent': { label: 'ارسال شده', class: 'bg-blue-100 text-blue-700', icon: 'fa-truck' },
                'cancelled': { label: 'لغو شده', class: 'bg-red-100 text-red-700', icon: 'fa-times' }
            };
            const st = statusConfig[o.status] || statusConfig['pending_payment'];
            
            let customerName = "مهمان";
            
            const row = document.createElement('tr');
            row.className = `hover:bg-gray-50 dark:hover:bg-white/5 transition border-b border-gray-100 dark:border-white/5 last:border-0`;
            row.innerHTML = `
                <td class="p-4 font-mono text-gray-400 text-[10px]">#${o.id.toString().slice(0,6)}</td>
                <td class="p-4 font-bold">${customerName}</td>
                <td class="p-4 text-[10px] text-gray-500">مشاهده</td>
                <td class="p-4 font-black text-brand-gold font-mono">${formatMoney(o.total_amount)}</td>
                <td class="p-4 text-[10px] truncate max-w-[100px]">---</td>
                <td class="p-4 text-center"><span class="${st.class} px-2 py-0.5 rounded text-[9px] font-bold whitespace-nowrap"><i class="fas ${st.icon}"></i> ${st.label}</span></td>
                <td class="p-4 text-center"><button class="order-action-btn bg-gray-100 dark:bg-white/10 hover:bg-brand-gold hover:text-black transition px-3 py-1 rounded-lg text-[9px] font-bold">مدیریت</button></td>
            `;
            row.querySelector('.order-action-btn').onclick = () => window.openOrderAction(o);
            if(prepend && desktopBody) desktopBody.prepend(row); else if(desktopBody) desktopBody.appendChild(row);

            const mCard = document.createElement('div');
            mCard.className = `glass rounded-xl p-3 border border-gray-100 dark:border-white/5`;
            mCard.innerHTML = `
                <div class="flex justify-between items-start mb-2 border-b border-gray-100 dark:border-white/5 pb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-[10px] font-bold text-gray-500">#${o.id.toString().slice(0,3)}</div>
                        <div><h4 class="font-bold text-xs text-gray-900 dark:text-white">${customerName}</h4></div>
                    </div>
                    <span class="${st.class} px-2 py-0.5 rounded text-[9px] font-bold flex items-center gap-1"><i class="fas ${st.icon}"></i> ${st.label}</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[9px] text-gray-400">مبلغ</span>
                    <span class="font-black text-brand-gold text-xs">${formatMoney(o.total_amount)} <span class="text-[8px] font-normal">تومان</span></span>
                </div>
                <button class="mobile-manage-btn w-full bg-gray-50 dark:bg-white/5 hover:bg-brand-gold hover:text-black text-gray-600 dark:text-gray-300 py-2 rounded-lg text-[10px] font-bold transition">
                    مدیریت سفارش
                </button>
            `;
            mCard.querySelector('.mobile-manage-btn').onclick = () => window.openOrderAction(o);
            if(prepend && mobileList) mobileList.prepend(mCard); else if(mobileList) mobileList.appendChild(mCard);
        }

        window.openOrderAction = (order) => {
            activeOrderId = order.id;
            document.getElementById('order-action-modal').classList.remove('hidden');
            document.getElementById('modal-customer-name').innerText = "خریدار";
            document.getElementById('modal-order-total').innerText = formatMoney(order.total_amount) + ' تومان';
            
            const variantsContainer = document.getElementById('modal-product-variants');
            variantsContainer.innerHTML = '';
            
            if(order.items && Array.isArray(order.items) && order.items.length > 0) {
                const first = order.items[0];
                document.getElementById('modal-product-name').innerText = first.title || 'محصول';
                document.getElementById('modal-order-qty').innerText = order.items.length;
            }

            const paidView = document.getElementById('order-action-paid');
            const sentView = document.getElementById('order-action-sent');
            
            if (order.status === 'sent') {
                paidView.classList.add('hidden'); sentView.classList.remove('hidden');
                document.getElementById('display-tracking-code').innerText = order.payment_ref || '-';
            } else if (order.status === 'paid') {
                paidView.classList.remove('hidden'); sentView.classList.add('hidden');
            } else {
                paidView.classList.add('hidden'); sentView.classList.add('hidden');
            }
        };

        window.closeOrderAction = () => document.getElementById('order-action-modal').classList.add('hidden');

        window.submitTrackingCode = async () => {
            const code = document.getElementById('tracking-input').value.trim();
            if(!code) { window.showToast('کد رهگیری الزامی است', 'error'); return; }
            
            const { error } = await supabase.from('store_orders').update({ status: 'sent', payment_ref: code }).eq('id', activeOrderId);
            
            if(error) { window.showToast('خطا: ' + error.message, 'error'); } 
            else {
                window.showToast('ثبت شد', 'success'); 
                window.closeOrderAction();
                const orderIdx = allOrdersCache.findIndex(o => o.id == activeOrderId);
                if(orderIdx > -1) {
                    allOrdersCache[orderIdx].status = 'sent'; 
                    renderOrdersList(); 
                }
            }
        };

        // --- PROFILE & KYC ---
        async function loadProfile() {
            const { data } = await supabase.from('store_profiles').select('*').eq('user_id', currentUser.id).single();
            if(data) {
                storeProfile = data;
                currentUserPlan = data.plan_type || 'free'; 
                
                // Update Plan Badge UI
                const badge = document.getElementById('plan-badge-content');
                const badgeText = document.getElementById('plan-text');
                const badgeDot = badge.querySelector('span:first-child');

                if (currentUserPlan === 'vip') {
                    badgeText.innerText = "L E G E N D (VIP)";
                    badge.classList.remove('bg-gray-100', 'dark:bg-white/10', 'text-gray-600', 'dark:text-gray-300');
                    badge.classList.add('bg-brand-gold', 'text-black', 'border-brand-gold', 'shadow-gold');
                    badgeDot.classList.remove('bg-gray-400');
                    badgeDot.classList.add('bg-black', 'animate-pulse');
                } else if (currentUserPlan === 'pro') {
                    badgeText.innerText = "حرفه‌ای";
                    badgeDot.classList.remove('bg-gray-400');
                    badgeDot.classList.add('bg-blue-500');
                } else {
                    // Free Plan default
                    badgeText.innerText = "رایگان";
                }

                document.getElementById('header-shop-name').innerText = data.shop_name || 'فروشگاه من';
                // Note: Header greeting removed in favor of Dashboard Welcome
                if(data.avatar_url) document.getElementById('header-avatar').src = data.avatar_url;
                
                const kycBadge = document.getElementById('kyc-status-badge');
                const kycText = document.getElementById('kyc-status-text');
                const pulse = document.getElementById('kyc-pulse');

                if(data.iban && data.national_id) {
                    if(data.kyc_status === 'verified') {
                        if(kycBadge) {
                            kycBadge.className = "inline-flex items-center gap-2 bg-green-100 text-green-700 px-2 py-0.5 rounded-lg text-[10px] font-bold";
                            if(kycText) kycText.innerText = "فعال";
                            if(pulse) { pulse.classList.remove('animate-ping', 'bg-yellow-400'); pulse.classList.add('bg-green-500'); }
                        }
                    } else {
                        if(kycText) kycText.innerText = "در انتظار";
                    }
                }
                
                if(document.getElementById('kyc-nid')) document.getElementById('kyc-nid').value = data.national_id || '';
                if(document.getElementById('kyc-iban')) document.getElementById('kyc-iban').value = data.iban || '';
            }
        }

        window.openProfileModal = () => {
            document.getElementById('shop-profile-modal').classList.remove('hidden');
            if(storeProfile) {
                document.getElementById('setting-store-name').value = storeProfile.shop_name || '';
                document.getElementById('setting-color').value = storeProfile.brand_color || '#D4AF37';
                if(storeProfile.avatar_url) document.getElementById('settings-logo-preview').src = storeProfile.avatar_url;
            }
        };

        window.handleLogoUpload = async (input) => {
            if(!input.files.length) return;
            const file = input.files[0]; const blob = await compressImageToBlob(file);
            const fileName = `logos/${currentUser.id}_${Date.now()}.webp`; 
            const { error } = await supabase.storage.from('store-assets').upload(fileName, blob, { contentType: 'image/webp' });
            if(!error) { 
                const { data: { publicUrl } } = supabase.storage.from('store-assets').getPublicUrl(fileName); 
                newLogoUrl = publicUrl; 
                document.getElementById('settings-logo-preview').src = publicUrl; 
            }
        };

        window.saveShopProfile = async () => {
             const updates = {
                user_id: currentUser.id,
                shop_name: document.getElementById('setting-store-name').value, 
                brand_color: document.getElementById('setting-color').value, 
                updated_at: new Date()
            };
            if(newLogoUrl) updates.avatar_url = newLogoUrl; 
            
            const { error } = await supabase.from('store_profiles').upsert(updates);
            if(error) window.showToast(error.message, 'error');
            else { window.showToast('پروفایل بروز شد'); location.reload(); }
        };

        window.openSettingsModal = () => document.getElementById('shop-settings-modal').classList.remove('hidden');
        window.switchConfigTab = (btn, targetId) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            btn.classList.add('active-tab');
            document.querySelectorAll('.config-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
        };

        window.submitKYC = async () => {
            const nid = toEnglishDigits(document.getElementById('kyc-nid').value.trim());
            let iban = toEnglishDigits(document.getElementById('kyc-iban').value.trim()).toUpperCase();
            if (iban.startsWith('IR')) iban = iban.substring(2);
            iban = 'IR' + iban;

            if(nid.length !== 10) { window.showToast('کد ملی ۱۰ رقم', 'error'); return; }
            if(iban.length !== 26) { window.showToast('شبا نامعتبر', 'error'); return; }

            const btn = document.getElementById('btn-kyc-submit');
            btn.classList.add('btn-loading');

            const updates = { user_id: currentUser.id, national_id: nid, iban: iban, kyc_status: 'pending' };
            const { error } = await supabase.from('store_profiles').upsert(updates);

            if(error) window.showToast('خطا', 'error');
            else {
                window.showToast('ثبت شد', 'success');
                document.getElementById('shop-settings-modal').classList.add('hidden');
            }
            btn.classList.remove('btn-loading');
        };
        
        window.openUpgradeModal = () => document.getElementById('upgrade-modal').classList.remove('hidden');
        window.closeUpgradeModal = () => document.getElementById('upgrade-modal').classList.add('hidden');
        window.selectPlan = (el, plan) => {
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        };

        window.initiatePayment = async (plan) => {
    const prices = { 'vip': 499000, 'pro': 199000 }; 
    const priceInToman = prices[plan] || 100000;
    
    // دریافت ID کاربر لاگین شده
    if(!currentUser) { showToast('لطفا دوباره لاگین کنید', 'error'); return; }

    window.showToast('در حال اتصال به بانک...', 'info');
    const btn = event.target; // گرفتن دکمه برای افکت لودینگ
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال پردازش';
    btn.disabled = true;

    try {
        const { data, error } = await supabase.functions.invoke('create-payment', {
            body: {
                type: 'subscription', // <--- این خط حیاتی است
                plan: plan,
                amount: priceInToman * 10, // تبدیل به ریال
                seller_id: currentUser.id, 
                callback_url: window.location.origin + '/verify_payment.html', // بدون پارامتر، خود تابع اضافه میکند
                order_id: null 
            }
        });

        if (error) throw error;
        if (!data.success) throw new Error(data.error);
        
        window.location.href = data.paymentUrl;
    } catch (e) {
        console.error(e);
        window.showToast('خطا در پرداخت: ' + e.message, 'error');
        btn.innerHTML = 'انتخاب';
        btn.disabled = false;
    }
};

        window.switchTab = (tab) => {
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
            
            // Activate Sidebar Link (Desktop)
            const desktopLinks = document.querySelectorAll(`button[onclick="switchTab('${tab}')"]`);
            desktopLinks.forEach(l => {
                if(l.classList.contains('sidebar-link')) l.classList.add('active');
            });

            // Activate Mobile Nav Item
            const mobLink = document.getElementById(`m-nav-${tab}`);
            if(mobLink) mobLink.classList.add('active');
            
            ['dashboard', 'products', 'orders'].forEach(v => { 
                const el = document.getElementById('view-' + v); 
                if(el) { el.classList.add('hidden'); el.classList.remove('animate-slide-up'); } 
            });
            const target = document.getElementById('view-' + tab); 
            target.classList.remove('hidden'); 
            setTimeout(() => target.classList.add('animate-slide-up'), 10);
        };
        
        window.logout = async () => { if(confirm('خروج؟')) await supabase.auth.signOut(); window.location.reload(); };
    </script>
</body>
</html>