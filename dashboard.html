<!DOCTYPE html>
<html lang="fa" dir="rtl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>فرماندهی فروشگاه | WEB LEGEND VIP</title>
    <link rel="icon" type="image/png" href="img/logo01.png">
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brand: { 
                            gold: '#D4AF37', 
                            goldHover: '#F9E59E', 
                            dark: '#050505', 
                            panel: '#0F1115', 
                            lightPanel: '#1A1D24'
                        } 
                    },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    boxShadow: {
                        'gold': '0 4px 20px -2px rgba(212, 175, 55, 0.2)',
                        'gold-glow': '0 0 15px rgba(212, 175, 55, 0.4)',
                        'card': '0 10px 30px -5px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-fast': 'spin 0.7s linear infinite',
                        'shine': 'shine 3s infinite',
                    },
                    keyframes: {
                        shine: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; }
        
        /* Glass & UI */
        .glass { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            box-shadow: var(--shadow-card);
        }
        .dark .glass { 
            background: rgba(20, 20, 20, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); 
        }

        /* Sidebar Improved Styling */
        .sidebar-link { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 0.9rem;
        }
        .sidebar-link:hover { 
            background: rgba(212, 175, 55, 0.08); 
            transform: translateX(-3px); 
            color: #D4AF37;
        }
        .dark .sidebar-link:hover { color: #F9E59E; }
        
        .sidebar-link.active { 
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%); 
            color: #D4AF37; 
            border-right: 3px solid #D4AF37; 
            font-weight: 800;
        }
        .sidebar-link.active i { color: #D4AF37; filter: drop-shadow(0 0 5px rgba(212,175,55,0.4)); }

        .bottom-nav-link { transition: all 0.3s ease; position: relative; opacity: 0.6; }
        .bottom-nav-link.active { opacity: 1; color: #D4AF37; transform: translateY(-3px); }
        
        .fab-btn { animation: pulse-gold 3s infinite; }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes highlightRow { 0% { background-color: rgba(16, 185, 129, 0.2); } 100% { background-color: transparent; } }
        .new-order-highlight { animation: highlightRow 2s ease-out; }

        /* Advanced Components */
        .upload-zone { border: 2px dashed #e2e8f0; transition: all 0.3s; background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); border: none; }
        .upload-zone:hover { background-color: rgba(212, 175, 55, 0.03); transform: scale(0.99); }
        .dark .upload-zone { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23333' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
        
        .img-preview-item { 
            position: relative; width: 100%; aspect-ratio: 1/1; 
            border-radius: 16px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); object-fit: cover;
        }
        
        /* Modern Color Picker */
        .color-option {
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s; position: relative;
        }
        .color-option.selected { transform: scale(1.15); border-color: #D4AF37; box-shadow: 0 0 10px rgba(212,175,55,0.3); }
        .color-option.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 10px; text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Smart Tags Input */
        .tags-input-container {
            display: flex; flex-wrap: wrap; gap: 6px; padding: 8px;
            background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;
            min-height: 48px; align-items: center;
        }
        .dark .tags-input-container { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .tags-input-container:focus-within { border-color: #D4AF37; }
        
        .tag-chip {
            background: #e5e7eb; color: #374151; padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px;
            animation: fadeIn 0.2s ease;
        }
        .dark .tag-chip { background: #333; color: #e5e7eb; }
        .tag-chip i { cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .tag-chip i:hover { color: #ef4444; }
        
        .tags-input {
            flex: 1; background: transparent; border: none; outline: none;
            font-size: 12px; min-width: 60px; color: inherit;
        }
        
        @keyframes fadeIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

        .order-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f3f4f6; transition: transform 0.2s; margin-bottom: 12px; }
        .dark .order-card { background: #151515; border-color: rgba(255,255,255,0.05); }
        .order-card:active { transform: scale(0.98); }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Loader Animation */
        .cube-loader { position: relative; width: 60px; height: 60px; transform-style: preserve-3d; animation: cubeRotate 4s infinite linear; }
        .cube-face { position: absolute; width: 60px; height: 60px; border: 2px solid #D4AF37; opacity: 0.5; box-shadow: 0 0 15px rgba(212,175,55,0.2); }
        .cube-face:nth-child(1) { transform: rotateY(0deg) translateZ(30px); }
        .cube-face:nth-child(2) { transform: rotateY(90deg) translateZ(30px); }
        .cube-face:nth-child(3) { transform: rotateY(180deg) translateZ(30px); }
        .cube-face:nth-child(4) { transform: rotateY(-90deg) translateZ(30px); }
        .cube-face:nth-child(5) { transform: rotateX(90deg) translateZ(30px); }
        .cube-face:nth-child(6) { transform: rotateX(-90deg) translateZ(30px); }
        @keyframes cubeRotate { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
        
        /* Spin Animation */
        .spin-once { animation: spin 0.8s ease-in-out; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tabs for Settings */
        .tab-btn { padding: 10px 20px; border-radius: 12px; font-weight: bold; font-size: 12px; transition: all 0.2s; opacity: 0.6; white-space: nowrap; }
        .tab-btn.active-tab { background: #D4AF37; color: black; opacity: 1; box-shadow: 0 4px 15px -3px rgba(212,175,55,0.4); }
        
        /* Category List Item */
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 12px; background: #f9fafb; margin-bottom: 8px; border: 1px solid #f3f4f6; transition: 0.2s; }
        .dark .cat-item { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .cat-item:hover { transform: translateX(-2px); }

        /* Product Tabs Styles */
        .prod-tab-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .dark .prod-tab-btn { color: #9ca3af; }
        .prod-tab-btn.active {
            color: #D4AF37;
            border-bottom-color: #D4AF37;
            background: linear-gradient(to top, rgba(212,175,55,0.05), transparent);
        }
        .step-content { display: none; animation: fadeIn 0.3s ease; }
        .step-content.active { display: block; }

        /* Upgrade Modal Styles */
        .gradient-text-gold {
            background: linear-gradient(to right, #F9E59E, #D4AF37, #AA8A2E);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .plan-card {
            border: 2px solid transparent; transition: all 0.3s;
        }
        .plan-card:hover { border-color: #D4AF37; transform: scale(1.02); }
        .plan-card.active { border-color: #D4AF37; background: rgba(212, 175, 55, 0.05); }
    </style>
</head>
<body class="font-sans h-screen overflow-hidden flex text-sm bg-[#f8f9fa] text-gray-800 dark:bg-black dark:text-gray-100">

    <div id="page-loader" class="fixed inset-0 z-[100] bg-[#000] flex items-center justify-center transition-opacity duration-700">
        <div class="cube-loader">
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="cube-face bg-black/80"></div>
            <div class="absolute inset-0 bg-brand-gold/20 blur-xl rounded-full animate-pulse-slow"></div>
        </div>
    </div>

    <aside class="hidden lg:flex w-72 bg-white dark:bg-brand-panel border-l border-gray-100 dark:border-white/5 flex-col z-20 transition-all duration-300 shadow-xl dark:shadow-none">
        <div class="p-6 flex items-center justify-start gap-3 h-20 border-b border-gray-50 dark:border-white/5">
            <div class="w-10 h-10 bg-gradient-to-br from-brand-gold to-yellow-600 rounded-xl flex items-center justify-center text-black font-black text-xl shadow-gold">W</div>
            <div>
                <h1 class="font-black tracking-tight text-lg text-gray-900 dark:text-white">WEB <span class="text-brand-gold">LEGEND</span></h1>
                <p class="text-[9px] text-gray-400 uppercase tracking-[0.2em] opacity-80">Seller Cockpit</p>
            </div>
        </div>

        <nav class="flex-1 px-3 space-y-1.5 overflow-y-auto pt-4">
            <p class="px-4 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-2 tracking-wider">مدیریت</p>
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full flex items-center justify-start gap-3 px-4 py-2.5 text-gray-500 dark:text-gray-400 rounded-xl transition group">
                <i class="fas fa-chart-pie text-lg transition w-5 text-center"></i> <span class="font-bold">داشبورد فروش</span>
            </button>
            <button onclick="switchTab('products')" class="sidebar-link w-full flex items-center justify-start gap-3 px-4 py-2.5 text-gray-500 dark:text-gray-400 rounded-xl transition group">
                <i class="fas fa-box-open text-lg transition w-5 text-center"></i> <span class="font-bold">محصولات</span>
            </button>
            <button onclick="switchTab('orders')" class="sidebar-link w-full flex items-center justify-start gap-3 px-4 py-2.5 text-gray-500 dark:text-gray-400 rounded-xl transition group relative">
                <i class="fas fa-receipt text-lg transition w-5 text-center"></i> <span class="font-bold">سفارشات</span>
                <span id="sidebar-badge-orders" class="absolute left-4 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full hidden animate-pulse">NEW</span>
            </button>
            
            <p class="px-4 text-[10px] text-gray-400 font-bold uppercase mb-2 mt-6 tracking-wider">ابزارها</p>
            <button onclick="openSmartSeller()" class="sidebar-link w-full flex items-center justify-start gap-3 px-4 py-2.5 text-gray-500 dark:text-gray-400 rounded-xl transition group">
                <i class="fas fa-brain text-lg transition w-5 text-center"></i> <span class="font-bold">فروشنده هوشمند</span>
                <span class="text-[8px] bg-brand-gold text-black px-1.5 py-0.5 rounded-md font-black ml-auto">AI</span>
            </button>
            <button onclick="openSettingsModal()" class="sidebar-link w-full flex items-center justify-start gap-3 px-4 py-2.5 text-gray-500 dark:text-gray-400 rounded-xl transition group">
                <i class="fas fa-cogs text-lg transition w-5 text-center"></i> <span class="font-bold">تنظیمات فروشگاه</span>
            </button>

            <button onclick="openUpgradeModal()" class="sidebar-link w-full flex items-center justify-start gap-3 px-4 py-3 text-brand-gold rounded-xl transition group mt-4 bg-brand-gold/5 border border-brand-gold/20 hover:bg-brand-gold hover:text-black">
                <i class="fas fa-crown text-lg transition w-5 text-center animate-pulse"></i> <span class="font-black">خرید اشتراک ویژه</span>
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 dark:border-white/5">
            <div class="bg-gray-50 dark:bg-white/5 rounded-2xl p-3 border border-gray-100 dark:border-white/5 mb-3">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center text-green-500"><i class="fas fa-globe text-sm"></i></div>
                    <div class="text-xs font-bold truncate">فروشگاه آنلاین</div>
                </div>
                <button onclick="viewMyShop()" class="w-full bg-white dark:bg-black border border-gray-200 dark:border-white/10 text-xs font-bold py-2 rounded-xl hover:text-brand-gold transition shadow-sm">مشاهده سایت من</button>
            </div>
            <button onclick="logout()" class="flex items-center justify-center gap-2 w-full py-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-xl transition font-bold text-xs">
                <i class="fas fa-sign-out-alt"></i> خروج امن
            </button>
        </div>
    </aside>

    <main class="flex-1 relative flex flex-col h-full overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-[400px] bg-gradient-to-b from-brand-gold/5 via-brand-gold/0 to-transparent pointer-events-none"></div>

        <header class="h-16 lg:h-20 flex justify-between items-center px-4 lg:px-8 z-10 bg-white/60 dark:bg-black/60 backdrop-blur-md sticky top-0 border-b border-gray-100 dark:border-white/5">
            <div class="flex items-center gap-4">
                <div class="lg:hidden w-9 h-9 bg-gradient-to-tr from-brand-gold to-yellow-600 rounded-xl flex items-center justify-center text-black font-black text-sm shadow-gold">W</div>
                <div>
                    <h2 class="text-sm lg:text-lg font-black text-gray-900 dark:text-white" id="greeting-text">امپراتوری شما</h2>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                        <p class="text-[10px] text-gray-500 font-mono tracking-wider">SYSTEM ONLINE</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="plan-badge" onclick="openUpgradeModal()" class="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-white/10 text-[10px] font-bold text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-white/10 cursor-pointer hover:bg-brand-gold hover:text-black transition shadow-sm hover:shadow-gold">
                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span id="plan-text">پلن رایگان (ارتقا)</span>
                </button>

                <button id="themeToggleBtn" class="w-10 h-10 rounded-full bg-transparent hover:bg-gray-100 dark:hover:bg-white/10 flex items-center justify-center text-gray-500 transition">
                    <i class="fas fa-moon hidden dark:block"></i>
                    <i class="fas fa-sun text-yellow-500 dark:hidden"></i>
                </button>
                <div class="h-6 w-[1px] bg-gray-200 dark:bg-white/10 mx-1"></div>
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition" onclick="openProfileModal()">
                    <div class="text-right hidden md:block">
                        <p class="text-xs font-bold text-gray-900 dark:text-white" id="header-shop-name">پروفایل فروشگاه</p>
                        <p class="text-[9px] text-brand-gold">VIP MEMBER</p>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-white/10 border-2 border-white dark:border-black overflow-hidden shadow-sm">
                        <img src="img/logo01.png" class="w-full h-full object-cover opacity-80" id="header-avatar" alt="Avatar">
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth pb-28 lg:pb-8 relative custom-scrollbar" id="main-scroll-area">
            
            <div id="view-dashboard" class="space-y-6 animate-slide-up">
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6">
                    <div class="col-span-2 lg:col-span-2 glass rounded-3xl p-6 relative overflow-hidden group border-t-4 border-brand-gold">
                        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-brand-gold/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">فروش کل (تومان)</p>
                                <h3 class="text-3xl lg:text-4xl font-black text-gray-900 dark:text-white tracking-tight" id="dash-total-sales">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-brand-gold text-black flex items-center justify-center text-xl shadow-gold">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                        <div class="relative z-10 mt-4 flex items-center gap-2 text-xs font-bold text-green-500 bg-green-50 dark:bg-green-900/20 px-3 py-1.5 rounded-lg w-fit">
                            <i class="fas fa-arrow-up"></i> <span>درآمد خالص</span>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-4 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center"><i class="fas fa-shopping-bag"></i></div>
                            <span class="text-[10px] bg-gray-100 dark:bg-white/10 px-2 py-1 rounded-md text-gray-500">موفق</span>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="dash-order-count">0</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold">تعداد سفارشات</p>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col justify-between group hover:border-brand-gold/30 transition border-t-4 border-transparent">
                        <div class="flex justify-between items-start">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/10 text-purple-500 flex items-center justify-center"><i class="fas fa-eye"></i></div>
                            <span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-md flex items-center gap-1"><i class="fas fa-caret-up"></i> زنده</span>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="dash-views">...</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold">بازدید فروشگاه</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass rounded-3xl p-6 lg:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2"><i class="fas fa-chart-line text-brand-gold"></i> روند رشد فروش</h3>
                            <select id="chart-filter" onchange="updateAnalytics()" class="bg-gray-50 dark:bg-white/5 border-none text-xs rounded-lg px-3 py-1 outline-none font-bold text-gray-500 cursor-pointer hover:bg-gray-100 transition">
                                <option value="7">۷ روز گذشته</option>
                                <option value="30">۳۰ روز گذشته</option>
                                <option value="all">کل دوره</option>
                            </select>
                        </div>
                        <div class="h-[250px] w-full">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 flex flex-col">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="fas fa-crown text-brand-gold"></i> محصولات برتر</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1" id="top-products-list">
                            <div class="text-center py-8 opacity-50"><p class="text-xs">در حال تحلیل داده‌ها...</p></div>
                        </div>
                        <button onclick="switchTab('products')" class="w-full mt-4 py-3 bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 rounded-xl text-xs font-bold transition">مدیریت محصولات</button>
                    </div>
                </div>
            </div>

            <div id="view-products" class="hidden space-y-6 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 dark:text-white">ویترین محصولات</h2>
                        <p class="text-xs text-gray-500 mt-1">مدیریت موجودی و قیمت‌ها</p>
                    </div>
                    <button onclick="openProductModal()" class="hidden lg:flex bg-brand-gold hover:bg-brand-goldHover text-black font-black px-6 py-3 rounded-xl shadow-gold transition transform hover:-translate-y-1 items-center gap-2">
                        <i class="fas fa-plus"></i> افزودن محصول
                    </button>
                </div>
                
                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20"></div>
            </div>

            <div id="view-orders" class="hidden space-y-6 animate-slide-up">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 dark:text-white">مدیریت سفارشات</h2>
                        <p class="text-xs text-gray-500 mt-1">لیست پرداختی‌های مشتریان</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="bg-white dark:bg-white/5 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-white/10 text-xs font-bold">
                            تعداد کل: <span id="total-orders-badge">0</span>
                        </div>
                        <button onclick="refreshOrdersData()" id="refresh-orders-btn" class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-white hover:text-brand-gold transition shadow-sm" title="بروزرسانی">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="hidden lg:block glass rounded-3xl overflow-hidden border border-gray-100 dark:border-white/5">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-gray-50 dark:bg-white/5 text-gray-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-5">شناسه</th>
                                <th class="p-5">مشتری</th>
                                <th class="p-5">محصولات</th>
                                <th class="p-5">مبلغ کل</th>
                                <th class="p-5">آدرس</th>
                                <th class="p-5 text-center">وضعیت</th>
                                <th class="p-5 text-center">اقدام</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-desktop" class="divide-y divide-gray-100 dark:divide-white/5"></tbody>
                    </table>
                </div>

                <div class="lg:hidden space-y-3" id="orders-list-mobile"></div>
            </div>

        </div>
    </main>

    <nav class="lg:hidden fixed bottom-0 left-0 w-full bg-white/95 dark:bg-[#0F1115]/95 backdrop-blur-xl border-t border-gray-200 dark:border-white/5 z-40 flex justify-between items-end px-6 pb-safe pt-2 shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
        <button onclick="switchTab('dashboard')" class="bottom-nav-link active flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-home text-xl"></i>
        </button>
        <button onclick="switchTab('orders')" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12 relative">
            <i class="fas fa-receipt text-xl"></i>
            <div id="mobile-badge-orders" class="absolute top-0 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-white dark:border-black hidden animate-pulse"></div>
        </button>
        <button onclick="openProductModal()" class="fab-btn mb-6 -mt-8 w-16 h-16 bg-gradient-to-tr from-brand-gold to-yellow-600 text-black rounded-full shadow-gold flex items-center justify-center transform active:scale-95 transition border-4 border-white dark:border-[#0F1115]">
            <i class="fas fa-plus text-2xl"></i>
        </button>
        <button onclick="switchTab('products')" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-box text-xl"></i>
        </button>
        <button onclick="viewMyShop()" class="bottom-nav-link flex flex-col items-center gap-1 mb-3 w-12">
            <i class="fas fa-globe text-xl"></i>
        </button>
    </nav>

    <div id="product-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-end lg:items-center justify-center sm:p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-xl lg:rounded-3xl rounded-t-[2rem] border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] lg:max-h-[85vh] animate-slide-up">
            
            <div class="p-6 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 lg:rounded-t-3xl rounded-t-[2rem]">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white" id="modal-title">محصول جدید</h3>
                    <p class="text-xs text-gray-500 mt-1">جزئیات را با دقت وارد کنید</p>
                </div>
                <button onclick="closeProductModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex px-4 pt-2 border-b border-gray-100 dark:border-white/5">
                <button class="prod-tab-btn active" onclick="switchProductStep(1)" id="step-btn-1">اطلاعات پایه</button>
                <button class="prod-tab-btn" onclick="switchProductStep(3)" id="step-btn-3">بازاریابی</button>
                <button class="prod-tab-btn" onclick="switchProductStep(2)" id="step-btn-2">انبار و تنوع</button>
            </div>
            
            <form id="product-form" class="p-6 space-y-6 overflow-y-auto custom-scrollbar pb-20 lg:pb-6 flex-1">
                
                <div id="step-content-1" class="step-content active space-y-5">
                    <div>
                        <label class="text-xs font-bold text-gray-500 mb-2 block flex justify-between">
                            <span>تصاویر محصول (مربع)</span>
                            <span class="text-[10px] text-brand-gold">اولین عکس = کاور</span>
                        </label>
                        <div class="flex gap-3 overflow-x-auto pb-2 items-center">
                            <div id="upload-trigger-btn" class="upload-zone w-20 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer flex-shrink-0 text-gray-400 hover:text-brand-gold transition" onclick="document.getElementById('image-upload-input').click()">
                                <i class="fas fa-camera text-xl mb-1"></i>
                                <span class="text-[9px] font-bold">افزودن</span>
                            </div>
                            <div id="image-previews-container" class="flex gap-2"></div>
                        </div>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*" multiple onchange="handleImageUpload(this)">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">نام محصول</label>
                        <input type="text" id="prod-name" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold focus:bg-white dark:focus:bg-black transition outline-none font-bold" placeholder="مثلا: کفش نایک جردن">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">قیمت (تومان)</label>
                            <input type="text" id="prod-price" inputmode="numeric" onkeyup="formatPriceInput(this)" class="w-full p-3 rounded-xl bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-black text-lg text-left dir-ltr" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">دسته‌بندی</label>
                            <div class="relative">
                                <select id="prod-category" class="w-full p-3 rounded-xl bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold appearance-none font-bold outline-none text-sm h-[50px]">
                                    <option value="">بدون دسته‌بندی</option>
                                </select>
                                <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="step-content-2" class="step-content space-y-5">
                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5 grid grid-cols-2 gap-4">
                        <div class="col-span-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-[-5px]">کنترل موجودی</div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">موجودی انبار</label>
                            <input type="number" id="prod-stock" class="w-full p-3 rounded-xl bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center" placeholder="∞">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">حد هشدار</label>
                            <input type="number" id="prod-threshold" class="w-full p-3 rounded-xl bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center" value="5">
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-xs font-bold text-gray-500 uppercase">ویژگی‌ها (تنوع)</label>
                            <div class="flex gap-1">
                                <button type="button" onclick="addAttributeBlock('colors')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="رنگ"><i class="fas fa-palette"></i></button>
                                <button type="button" onclick="addAttributeBlock('sizes')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="سایز"><i class="fas fa-ruler"></i></button>
                                <button type="button" onclick="addAttributeBlock('custom')" class="w-8 h-8 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/20 flex items-center justify-center hover:border-brand-gold transition text-gray-500" title="دلخواه"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div id="attributes-container" class="space-y-3">
                            <p class="text-[10px] text-gray-400 text-center italic" id="no-attr-msg">بدون ویژگی (محصول ساده)</p>
                        </div>
                    </div>
                </div>

                <div id="step-content-3" class="step-content space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">توضیحات کوتاه (زیر نام محصول)</label>
                        <input type="text" id="prod-short-desc" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold transition outline-none text-sm font-bold" placeholder="مثلا: مناسب برای مهمانی و روزمره، جنس کتان اصل">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">توضیحات کامل</label>
                        <textarea id="prod-desc" rows="4" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold transition outline-none resize-none" placeholder="جزئیات محصول..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-xs font-bold text-gray-500 mb-2">هزینه ارسال (تومان)</label>
                             <input type="text" id="prod-shipping" inputmode="numeric" onkeyup="formatPriceInput(this)" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-left dir-ltr" placeholder="0">
                        </div>
                        <div class="relative">
                             <label class="block text-xs font-bold text-gray-500 mb-2">تخفیف (%)</label>
                             <div class="relative">
                                <input type="number" id="prod-discount" class="w-full p-3 rounded-xl bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 text-gray-900 dark:text-white focus:border-red-500 outline-none font-black text-center" placeholder="0">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</span>
                            </div>
                        </div>
                    </div>
                     <input type="text" id="prod-discount-label" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none text-xs" placeholder="عنوان تخفیف (اختیاری: مثل بلک فرایدی)">
                </div>

            </form>
            
            <div class="p-4 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] lg:rounded-b-3xl flex flex-col md:flex-row gap-3 z-20">
                <button id="btn-delete-product" onclick="deleteProduct()" class="hidden md:w-auto w-full bg-red-50 dark:bg-red-900/10 text-red-500 border border-red-200 dark:border-red-900/30 font-bold py-4 px-6 rounded-xl transition hover:bg-red-100 dark:hover:bg-red-900/20 flex items-center justify-center gap-2">
                    <i class="fas fa-trash"></i>
                </button>
                
                <button id="btn-save-product" onclick="saveProduct()" class="flex-1 bg-brand-gold hover:bg-white hover:text-black hover:ring-2 hover:ring-brand-gold text-black font-black py-4 rounded-xl transition transform active:scale-95 shadow-gold flex items-center justify-center gap-2 text-base">
                    <span>ثبت نهایی محصول</span> <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="shop-settings-modal" class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] animate-slide-up">
            <div class="p-6 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 rounded-t-3xl">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white">تنظیمات فروشگاه</h3>
                    <p class="text-xs text-gray-500 mt-1">مدیریت مالی و ارسال</p>
                </div>
                <button onclick="document.getElementById('shop-settings-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="px-6 pt-4 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button class="tab-btn active-tab" onclick="switchConfigTab(this, 'conf-financial')">مالی</button>
                <button class="tab-btn" onclick="switchConfigTab(this, 'conf-cats')">دسته‌بندی</button>
                <button class="tab-btn" onclick="switchConfigTab(this, 'conf-general')">ارسال</button>
            </div>

            <div class="p-6 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                
                <div id="conf-financial" class="config-tab-content space-y-5">
                    
                    <div class="bg-gradient-to-br from-gray-900 to-black p-5 rounded-2xl border border-gray-800 relative overflow-hidden text-white">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-brand-gold/20 blur-2xl rounded-full"></div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">موجودی کیف پول</p>
                                <h3 class="text-3xl font-black text-brand-gold tracking-tighter" id="wallet-display">0</h3>
                                <p class="text-[10px] text-gray-500 mt-1">قابل برداشت</p>
                            </div>
                            <button onclick="requestWithdrawal()" id="btn-withdraw" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white text-xs font-bold px-4 py-2 rounded-lg transition backdrop-blur-md">
                                درخواست تسویه
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-yellow-50 dark:bg-yellow-900/10 p-4 rounded-xl border border-yellow-100 dark:border-yellow-900/30">
                            <h4 class="text-xs font-black text-yellow-700 dark:text-yellow-500 mb-2 flex items-center gap-2">
                                <i class="fas fa-shield-alt"></i> درگاه پرداخت ترکیبی
                            </h4>
                            <p class="text-[10px] text-yellow-600 dark:text-yellow-500/80 leading-relaxed mb-3">
                                اگر درگاه شخصی ندارید، فیلد زیر را خالی بگذارید تا از درگاه امن «وب‌لجند» استفاده کنید. درآمد شما به کیف پول واریز می‌شود.
                            </p>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">کد مرچنت زرین‌پال (36 رقمی)</label>
                                <input type="text" id="conf-zarinpal" class="w-full p-3 rounded-lg bg-white dark:bg-black/20 border border-yellow-200 dark:border-yellow-900/30 font-mono text-left dir-ltr text-xs" placeholder="مثلا: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            </div>
                        </div>

                        <p class="text-xs font-bold text-gray-500 border-b border-gray-100 dark:border-white/5 pb-2 mt-6">حساب مقصد تسویه</p>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">شماره شبا (بدون IR)</label>
                            <input type="text" id="conf-shaba" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 font-mono text-left dir-ltr" placeholder="120120000000...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">شماره کارت</label>
                            <input type="text" id="conf-card" class="w-full p-3 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 font-mono text-left dir-ltr" placeholder="6037...">
                        </div>
                    </div>
                </div>

                <div id="conf-cats" class="config-tab-content hidden space-y-4">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-cat-title" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-xs font-bold focus:border-brand-gold outline-none" placeholder="نام دسته‌بندی جدید...">
                        <button onclick="createCategory()" class="bg-black dark:bg-white text-white dark:text-black w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="categories-list-container" class="space-y-2"></div>
                </div>

                <div id="conf-general" class="config-tab-content hidden space-y-4">
                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/5">
                        <label class="block text-xs font-bold text-gray-500 mb-2">هزینه پایه ارسال (تومان)</label>
                        <input type="text" id="conf-shipping-base" class="w-full p-3 rounded-lg bg-white dark:bg-black/20 border border-gray-200 dark:border-white/10 font-mono" placeholder="0" inputmode="numeric">
                        <p class="text-[9px] text-gray-400 mt-1">این مبلغ به صورت پیش‌فرض برای ارسال پستی محاسبه می‌شود.</p>
                    </div>
                </div>
            </div>
             <div class="p-6 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] rounded-b-3xl">
                <button onclick="saveShopConfig()" class="w-full bg-black dark:bg-white text-white dark:text-black font-black py-4 rounded-xl shadow-lg hover:scale-[1.02] transition">ذخیره تنظیمات</button>
            </div>
        </div>
    </div>

    <div id="shop-profile-modal" class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl border border-gray-200 dark:border-white/10 shadow-2xl relative flex flex-col max-h-[90vh] animate-slide-up">
            <div class="p-6 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] z-10 rounded-t-3xl">
                <div>
                    <h3 class="text-xl font-black text-gray-900 dark:text-white">پروفایل فروشگاه</h3>
                    <p class="text-xs text-gray-500 mt-1">هویت و برندینگ</p>
                </div>
                <button onclick="document.getElementById('shop-profile-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                <div class="flex flex-col items-center mb-4">
                    <div class="relative w-28 h-28 rounded-full border-2 border-dashed border-gray-300 dark:border-white/20 p-1 mb-2 group cursor-pointer hover:border-brand-gold transition" onclick="document.getElementById('logo-upload-input').click()">
                        <div class="w-full h-full rounded-full bg-gray-50 dark:bg-white/5 overflow-hidden flex items-center justify-center">
                            <img id="settings-logo-preview" src="img/logo01.png" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-xs font-bold">تغییر لوگو</div>
                    </div>
                    <input type="file" id="logo-upload-input" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">نام فروشگاه</label>
                    <input type="text" id="setting-store-name" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-bold text-center" placeholder="نام برند شما">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                         <label class="block text-xs font-bold text-gray-500 mb-2">رنگ سازمانی</label>
                         <div class="flex items-center gap-2 bg-gray-50 dark:bg-white/5 p-2 rounded-xl border border-gray-100 dark:border-white/5">
                            <input type="color" id="setting-color" class="w-10 h-10 rounded-lg border-none p-0 cursor-pointer overflow-hidden" value="#D4AF37">
                            <span class="text-[10px] text-gray-400">انتخاب رنگ</span>
                         </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">آیدی اینستاگرام</label>
                        <input type="text" id="setting-instagram" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center dir-ltr text-sm" placeholder="username">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">بیوگرافی (توضیحات)</label>
                    <textarea id="setting-bio" rows="3" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none resize-none text-sm" placeholder="توضیحات کوتاه درباره فروشگاه..."></textarea>
                </div>
            </div>
             <div class="p-6 border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#111] rounded-b-3xl">
                <button onclick="saveShopProfile()" class="w-full bg-brand-gold text-black font-black py-4 rounded-xl shadow-gold hover:scale-[1.02] transition">ذخیره پروفایل</button>
            </div>
        </div>
    </div>

    <div id="order-action-modal" class="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#111] w-full max-w-lg rounded-3xl border border-gray-200 dark:border-white/10 shadow-2xl relative animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-100 dark:border-white/5 flex justify-between items-center sticky top-0 bg-white dark:bg-[#111] rounded-t-3xl z-10">
                <div>
                    <h3 class="font-black text-gray-900 dark:text-white text-lg flex items-center gap-2">
                        <i class="fas fa-file-invoice-dollar text-brand-gold"></i> جزئیات سفارش
                    </h3>
                </div>
                <button onclick="closeOrderAction()" class="w-8 h-8 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center text-gray-500 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                
                <div class="space-y-2">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">اطلاعات مشتری</h4>
                    <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-2xl border border-gray-100 dark:border-white/5 grid gap-4">
                        <div class="flex items-center justify-between border-b border-gray-100 dark:border-white/5 pb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-user"></i></div>
                                <div>
                                    <h4 class="font-bold text-sm text-gray-900 dark:text-white" id="modal-customer-name">...</h4>
                                    <span class="text-[10px] text-gray-400">خریدار</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <a href="#" id="modal-call-btn" class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center hover:bg-green-200 transition"><i class="fas fa-phone"></i></a>
                                <a href="#" id="modal-sms-btn" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 transition"><i class="fas fa-comment"></i></a>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white dark:bg-black/20 p-2 rounded-xl border border-gray-100 dark:border-white/5">
                                <label class="text-[9px] text-gray-400 block mb-1">شماره تماس</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-xs" id="modal-customer-phone">...</span>
                                    <button onclick="copyText('modal-customer-phone')" class="text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-black/20 p-2 rounded-xl border border-gray-100 dark:border-white/5">
                                <label class="text-[9px] text-gray-400 block mb-1">کد پستی</label>
                                <div class="flex justify-between items-center">
                                    <span class="font-mono font-bold text-xs" id="modal-customer-postal">...</span>
                                    <button onclick="copyText('modal-customer-postal')" class="text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5 relative">
                            <label class="text-[9px] text-gray-400 block mb-1">آدرس پستی</label>
                            <p class="text-xs font-medium leading-relaxed" id="modal-customer-address">...</p>
                            <button onclick="copyText('modal-customer-address')" class="absolute top-2 left-2 text-gray-400 hover:text-brand-gold"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">اقلام سفارش</h4>
                    <div class="bg-white dark:bg-white/5 p-3 rounded-2xl border border-brand-gold/30 shadow-sm flex gap-3">
                        <div class="w-20 h-20 bg-gray-100 dark:bg-black rounded-xl border border-gray-200 dark:border-white/10 flex items-center justify-center p-1 overflow-hidden">
                            <img id="modal-product-img" src="img/logo01.png" class="w-full h-full object-contain">
                        </div>
                        <div class="flex-1 flex flex-col justify-between">
                            <div>
                                <h5 class="font-black text-sm text-gray-900 dark:text-white line-clamp-1 mb-1" id="modal-product-name">...</h5>
                                <div class="flex flex-wrap gap-1" id="modal-product-variants">
                                    </div>
                            </div>
                            <div class="flex justify-between items-end border-t border-dashed border-gray-200 dark:border-white/10 pt-2">
                                <span class="text-xs text-gray-500 font-bold">تعداد: <span class="text-black dark:text-white" id="modal-order-qty">1</span></span>
                                <span class="font-black text-brand-gold text-lg font-mono" id="modal-order-total">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t-2 border-dashed border-gray-100 dark:border-white/5 pt-4">
                     <div id="order-action-paid" class="hidden space-y-3">
                        <label class="block text-xs font-bold text-gray-500">وضعیت سفارش: <span class="text-yellow-600">در انتظار ارسال</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="tracking-input" class="flex-1 p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:border-brand-gold outline-none font-mono text-center text-sm placeholder-gray-400" placeholder="کد رهگیری پستی">
                            <button onclick="submitTrackingCode()" class="bg-black dark:bg-white text-white dark:text-black font-bold px-6 rounded-xl hover:opacity-80 transition shadow-lg whitespace-nowrap">
                                ثبت ارسال
                            </button>
                        </div>
                    </div>

                    <div id="order-action-sent" class="hidden text-center bg-green-50 dark:bg-green-900/10 p-4 rounded-xl border border-green-100 dark:border-green-900/30">
                        <div class="flex items-center justify-center gap-2 text-green-600 mb-2">
                            <i class="fas fa-check-circle"></i> <span class="font-bold text-sm">ارسال شده برای مشتری</span>
                        </div>
                        <div class="flex items-center justify-center gap-2">
                             <span class="text-xs text-gray-500">کد رهگیری:</span>
                             <span class="font-mono font-bold text-gray-900 dark:text-white select-all text-lg tracking-widest" id="display-tracking-code">---</span>
                             <button onclick="copyText('display-tracking-code')" class="text-gray-400 hover:text-green-500"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="upgrade-modal" class="fixed inset-0 z-[90] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-gradient-to-br from-gray-900 to-black w-full max-w-2xl rounded-3xl border border-brand-gold/30 shadow-gold-glow relative animate-slide-up overflow-hidden text-white">
            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-gold/20 rounded-full blur-[50px] pointer-events-none"></div>
            
            <button onclick="closeUpgradeModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-red-500/20 hover:text-red-500 transition z-10"><i class="fas fa-times"></i></button>
            
            <div class="p-8 text-center relative z-10">
                <div class="w-16 h-16 bg-gradient-to-br from-brand-gold to-yellow-600 rounded-2xl flex items-center justify-center text-black font-black text-3xl shadow-gold mx-auto mb-6">
                    <i class="fas fa-crown"></i>
                </div>
                <h2 class="text-3xl font-black gradient-text-gold mb-2">امپراتوری خود را گسترش دهید</h2>
                <p class="text-gray-400 text-sm mb-8">شما به سقف مجاز پلن رایگان رسیده‌اید. برای ادامه رشد، ارتقا دهید.</p>
                
                <div class="grid md:grid-cols-2 gap-4 text-left">
                    <div class="plan-card bg-white/5 rounded-2xl p-6 relative cursor-pointer" onclick="selectPlan(this, 'pro')">
                        <div class="absolute -top-3 right-4 bg-gray-700 text-white text-[9px] font-bold px-2 py-1 rounded">اقتصادی</div>
                        <h4 class="text-xl font-bold text-white mb-1">حرفه‌ای</h4>
                        <div class="text-2xl font-black text-brand-gold mb-4">۱۹۹ <span class="text-xs font-normal text-gray-400">هزار تومان/ماه</span></div>
                        <ul class="space-y-2 text-xs text-gray-300 mb-6">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> ۵۰ محصول</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> درگاه پرداخت اختصاصی</li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> پشتیبانی تیکت</li>
                        </ul>
                        <button class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-2 rounded-xl text-xs transition" onclick="initiatePayment('pro')">انتخاب و پرداخت</button>
                    </div>

                    <div class="plan-card active bg-brand-gold/10 border-brand-gold rounded-2xl p-6 relative cursor-pointer" onclick="selectPlan(this, 'vip')">
                        <div class="absolute -top-3 right-4 bg-brand-gold text-black text-[9px] font-black px-2 py-1 rounded shadow-gold">پیشنهاد ویژه</div>
                        <h4 class="text-xl font-bold text-white mb-1">لجند (VIP)</h4>
                        <div class="text-2xl font-black text-brand-gold mb-4">۴۹۹ <span class="text-xs font-normal text-gray-400">هزار تومان/ماه</span></div>
                        <ul class="space-y-2 text-xs text-gray-300 mb-6">
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> <strong>محصول نامحدود</strong></li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> <strong>فروشنده هوشمند (AI)</strong></li>
                            <li class="flex items-center gap-2"><i class="fas fa-check text-brand-gold"></i> دامنه اختصاصی</li>
                        </ul>
                        <button class="w-full bg-brand-gold hover:bg-white hover:text-black text-black font-black py-2 rounded-xl text-xs transition shadow-gold" onclick="initiatePayment('vip')">انتخاب و پرداخت</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const supabaseUrl = 'https://bclbzdvupfiqihcdjltu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbGJ6ZHZ1cGZpcWloY2RqbHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NjA5NTcsImV4cCI6MjA4MjEzNjk1N30.fiCvS54TEbVZPm_chLcHEo8MAr1AHhP5CKNGbxr02JY'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let uploadedImages = []; 
        let editingProductId = null; 
        let salesChart = null;
        let activeOrderId = null;
        let storeProfile = null; 
        let newLogoUrl = null;
        let realtimeChannel = null;
        let allOrdersCache = []; 
        let productsMap = {}; 
        let allCategories = [];
        
        // Gatekeeper Variables
        let currentUserPlan = 'free'; // default
        let currentProductCount = 0;

        // --- UTILS ---
        window.formatPriceInput = (input) => {
            let val = input.value.replace(/\D/g, '');
            if(!val) { input.value = ''; return; }
            input.value = new Intl.NumberFormat('en-US').format(val);
        };
        const cleanPrice = (str) => {
            if(!str) return 0;
            const englishStr = str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            return englishStr.replace(/\D/g, '');
        };
        const toEnglishDigits = (str) => {
            if(!str) return '';
            return str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/,/g, '');
        };
        const formatMoney = (n) => new Intl.NumberFormat('fa-IR').format(n);
        
        function showToast(msg, type='success') {
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "center",
                style: { background: type === 'success' ? "#10B981" : "#EF4444", borderRadius: "12px", fontSize: "12px", fontFamily: "Vazirmatn", fontWeight: "bold" }
            }).showToast();
        }

        window.copyText = (elementId) => {
            const el = document.getElementById(elementId);
            if(el) {
                navigator.clipboard.writeText(el.innerText);
                showToast('کپی شد', 'success');
            }
        };

        // --- AUDIO ---
        function playNotification() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = "sine";
            osc.frequency.setValueAtTime(500, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        // --- INIT ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            document.getElementById('themeToggleBtn').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            });
        }
        initTheme();

        async function initApp() {
            const loader = document.getElementById('page-loader');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { window.location.href = 'index.html'; return; }
                currentUser = user;

                await loadCategories(); 
                await loadStoreProducts(); 
                await Promise.all([
                    loadOrders(),
                    loadProfile()
                ]);

                loadDashboardStats('7');
                subscribeToOrders();

                loader.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loader.style.display = 'none', 700);

            } catch (err) {
                console.error("Init Error:", err);
                showToast("خطا در ارتباط با سرور", "error");
                loader.style.display = 'none';
            }
        }
        initApp();

        // --- REALTIME ---
        function subscribeToOrders() {
            if (realtimeChannel) return;
            realtimeChannel = supabase
                .channel('public:store_orders')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'store_orders', filter: `seller_id=eq.${currentUser.id}` }, payload => {
                    handleOrderUpdate(payload);
                })
                .subscribe();
        }

        function handleOrderUpdate(payload) {
            const eventType = payload.eventType;
            const newOrder = payload.new;
            
            if (eventType === 'INSERT') {
                playNotification();
                showToast(`سفارش جدید: ${newOrder.customer_name}`, 'success');
                allOrdersCache.unshift(newOrder);
                renderSingleOrderRow(newOrder, true);
            } 
            else if (eventType === 'UPDATE') {
                const index = allOrdersCache.findIndex(o => o.id === newOrder.id);
                if (index !== -1) {
                    allOrdersCache[index] = newOrder;
                    showToast('وضعیت سفارش بروز شد');
                    renderOrdersList(); 
                }
            }
            updateAnalytics(); 
        }

        window.refreshOrdersData = async () => {
            const btn = document.getElementById('refresh-orders-btn');
            const icon = btn.querySelector('i');
            icon.classList.add('spin-fast'); btn.disabled = true;
            try {
                const { data } = await supabase.from('store_orders').select('*').eq('seller_id', currentUser.id).order('created_at', { ascending: false });
                allOrdersCache = data || [];
                renderOrdersList();
                updateAnalytics();
                showToast('اطلاعات بروزرسانی شد', 'success');
            } catch (e) { showToast('خطا در بروزرسانی', 'error'); } 
            finally { setTimeout(() => { icon.classList.remove('spin-fast'); btn.disabled = false; }, 500); }
        };

        // --- DASHBOARD LOGIC ---
        window.updateAnalytics = () => { loadDashboardStats(document.getElementById('chart-filter').value); };

        async function loadDashboardStats(range = '7') {
            const now = new Date();
            const cutoff = new Date();
            if (range !== 'all') cutoff.setDate(now.getDate() - parseInt(range));
            else cutoff.setFullYear(2000); 

            const filteredOrders = allOrdersCache.filter(o => new Date(o.created_at) > cutoff);
            let totalSales = 0;
            filteredOrders.forEach(o => totalSales += Number(o.total_price || 0));

            document.getElementById('dash-total-sales').innerText = formatMoney(totalSales);
            document.getElementById('dash-order-count').innerText = new Intl.NumberFormat('fa-IR').format(filteredOrders.length);
            
            renderChart(filteredOrders, range);
            renderTopProducts(filteredOrders);
        }

        function renderTopProducts(orders) {
            const productCounts = {};
            orders.forEach(o => { productCounts[o.product_id] = (productCounts[o.product_id] || 0) + (o.quantity || 1); });

            const sortedIds = Object.keys(productCounts).sort((a,b) => productCounts[b] - productCounts[a]).slice(0, 3);
            const list = document.getElementById('top-products-list');
            list.innerHTML = '';
            
            if(sortedIds.length === 0) {
                list.innerHTML = '<div class="text-center py-4 opacity-50"><p class="text-xs">داده‌ای موجود نیست</p></div>';
                return;
            }

            sortedIds.forEach((id, idx) => {
                const count = productCounts[id];
                const product = productsMap[id];
                let pName = 'محصول حذف شده';
                let pImg = 'img/logo01.png';

                if(product) {
                    pName = product.name;
                    try { const imgs = JSON.parse(product.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
                }

                list.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-black border border-gray-200 dark:border-white/10 p-1">
                                <img src="${pImg}" class="w-full h-full object-contain">
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-900 dark:text-white line-clamp-1">${pName}</h4>
                                <span class="text-[10px] text-gray-400">فروش: ${count} عدد</span>
                            </div>
                        </div>
                        <div class="w-6 h-6 rounded-full ${idx === 0 ? 'bg-yellow-400' : (idx===1 ? 'bg-gray-300' : 'bg-orange-300')} text-white flex items-center justify-center text-[10px] font-bold shadow-sm">${idx+1}</div>
                    </div>`;
            });
        }

        function renderChart(orders, range) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const grouped = {};
            if(range === '7') {
                for(let i=0; i<7; i++) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    grouped[d.toLocaleDateString('fa-IR')] = 0;
                }
            }

            orders.forEach(o => {
                const date = new Date(o.created_at).toLocaleDateString('fa-IR');
                grouped[date] = (grouped[date] || 0) + Number(o.total_price);
            });

            let sortedKeys = Object.keys(grouped); 
            if(range === '7') sortedKeys = sortedKeys.reverse(); 

            const dataPoints = sortedKeys.map(k => grouped[k]);

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: 'فروش', data: dataPoints, borderColor: '#D4AF37',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(212,175,55,0.2)');
                            gradient.addColorStop(1, 'rgba(212,175,55,0)');
                            return gradient;
                        },
                        borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#D4AF37', fill: true, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#999', font: { family: 'Vazirmatn' }, maxTicksLimit: 7 } },
                        y: { border: { display: false }, grid: { color: 'rgba(200,200,200,0.1)' }, ticks: { display: false } }
                    }
                }
            });
        }

        // --- PRODUCTS LOGIC ---
        async function loadStoreProducts() {
            const grid = document.getElementById('products-grid');
            const { data: products } = await supabase.from('store_products').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            
            grid.innerHTML = '';
            productsMap = {}; 
            currentProductCount = products ? products.length : 0; // Track count for gatekeeper

            if (!products || products.length === 0) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400 border-2 border-dashed border-gray-200 dark:border-white/10 rounded-3xl"><i class="fas fa-box-open text-4xl mb-3 opacity-50"></i><p>هنوز محصولی ندارید</p></div>`;
                return;
            }

            products.forEach(p => {
                productsMap[p.id] = p; 
                let imgUrl = 'img/logo01.png';
                try {
                    const parsed = JSON.parse(p.image);
                    if(Array.isArray(parsed) && parsed.length) imgUrl = parsed[0];
                } catch(e){}

                const card = document.createElement('div');
                card.className = "group bg-white dark:bg-[#151515] rounded-2xl border border-gray-100 dark:border-white/5 overflow-hidden hover:shadow-gold transition-all duration-300";
                
                card.innerHTML = `
                    <div class="relative w-full aspect-square bg-gray-50 dark:bg-white/5 p-4 flex items-center justify-center">
                        <img src="${imgUrl}" class="w-full h-full object-cover rounded-xl transition-transform duration-500 group-hover:scale-105 shadow-sm">
                    </div>
                    <div class="p-3">
                        <h4 class="font-bold text-xs text-gray-900 dark:text-white truncate">${p.name}</h4>
                        <p class="text-brand-gold font-black text-sm mt-1">${formatMoney(p.price)} <span class="text-[9px] text-gray-400 font-normal">تومان</span></p>
                        <div class="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-gray-50 dark:border-white/5">
                            <button onclick="openProductModal('${p.id}')" class="bg-gray-100 dark:bg-white/10 hover:bg-gray-200 text-gray-600 dark:text-gray-300 py-2 rounded-lg text-[10px] font-bold transition">ویرایش</button>
                            <button onclick="showLink('${p.id}')" class="bg-black text-white dark:bg-white dark:text-black py-2 rounded-lg text-[10px] font-bold transition flex items-center justify-center gap-1 hover:opacity-80">لینک <i class="fas fa-share"></i></button>
                        </div>
                    </div>
                `;
                // Store product data in a cleaner way to avoid quoting issues
                card.querySelector('button').onclick = () => openProductModal(p);
                grid.appendChild(card);
            });
        }

        window.deleteProduct = async () => {
            if(!editingProductId) return;
            if(!confirm('آیا از حذف این محصول مطمئن هستید؟')) return;
            const btn = document.getElementById('btn-delete-product');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            const { error } = await supabase.from('store_products').delete().eq('id', editingProductId);
            if(error) { showToast('خطا در حذف محصول: ' + error.message, 'error'); btn.innerHTML = '<i class="fas fa-trash"></i>'; btn.disabled = false; } 
            else { showToast('محصول حذف شد'); closeProductModal(); loadStoreProducts(); }
        };

        // --- ORDERS LOGIC ---
        async function loadOrders() {
            const { data } = await supabase.from('store_orders').select('*').eq('seller_id', currentUser.id).order('created_at', { ascending: false });
            allOrdersCache = data || [];
            renderOrdersList();
        }

        function renderOrdersList() {
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            document.getElementById('total-orders-badge').innerText = allOrdersCache.length;
            
            desktopBody.innerHTML = ''; mobileList.innerHTML = '';

            if (allOrdersCache.length === 0) {
                mobileList.innerHTML = `<div id="no-orders-msg" class="text-center py-10 text-gray-400">هنوز سفارشی ثبت نشده است</div>`;
                return;
            }
            allOrdersCache.forEach(o => renderSingleOrderRow(o));
        }

        function renderSingleOrderRow(o, prepend = false) {
            const desktopBody = document.getElementById('orders-table-desktop');
            const mobileList = document.getElementById('orders-list-mobile');
            
            const statusConfig = {
                'pending': { label: 'در انتظار', class: 'bg-yellow-100 text-yellow-700', icon: 'fa-clock' },
                'paid': { label: 'پرداخت شده', class: 'bg-green-100 text-green-700', icon: 'fa-check' },
                'sent': { label: 'ارسال شده', class: 'bg-blue-100 text-blue-700', icon: 'fa-truck' }
            };
            const st = statusConfig[o.status] || statusConfig['pending'];

            const row = document.createElement('tr');
            row.className = `hover:bg-gray-50 dark:hover:bg-white/5 transition border-b border-gray-100 dark:border-white/5 last:border-0 ${prepend ? 'new-order-highlight' : ''}`;
            row.innerHTML = `
                <td class="p-5 font-mono text-gray-400 text-xs">#${o.id.toString().slice(0,6)}</td>
                <td class="p-5 font-bold">${o.customer_name}<div class="text-[10px] text-gray-400 font-mono">${o.customer_phone}</div></td>
                <td class="p-5 text-xs text-gray-500">کد محصول: ${o.product_id} (×${o.quantity || 1})</td>
                <td class="p-5 font-black text-brand-gold font-mono">${formatMoney(o.total_price)}</td>
                <td class="p-5 text-xs truncate max-w-[150px]" title="${o.customer_address}">${o.customer_address}</td>
                <td class="p-5 text-center"><span class="${st.class} px-2 py-1 rounded text-[10px] font-bold whitespace-nowrap"><i class="fas ${st.icon}"></i> ${st.label}</span></td>
                <td class="p-5 text-center"><button class="order-action-btn bg-gray-100 dark:bg-white/10 hover:bg-brand-gold hover:text-black transition px-3 py-1.5 rounded-lg text-[10px] font-bold">مدیریت</button></td>
            `;
            row.querySelector('.order-action-btn').onclick = () => openOrderAction(o);
            if(prepend) desktopBody.prepend(row); else desktopBody.appendChild(row);

            const mCard = document.createElement('div');
            mCard.className = `order-card ${prepend ? 'new-order-highlight' : ''}`;
            mCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div><h4 class="font-bold text-sm text-gray-900 dark:text-white">${o.customer_name}</h4><p class="text-[10px] text-gray-500 font-mono mt-0.5">${o.customer_phone}</p></div>
                    <span class="${st.class} px-2 py-0.5 rounded text-[10px] font-bold">${st.label}</span>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-white/5 p-3 rounded-xl mb-3"><span class="text-xs text-gray-500">مبلغ کل</span><span class="font-black text-brand-gold text-sm">${formatMoney(o.total_price)} ت</span></div>
                <div class="flex gap-2">
                    <button class="flex-1 border border-dashed border-gray-300 dark:border-white/20 text-gray-500 py-2 rounded-xl text-xs font-bold hover:bg-gray-50 dark:hover:bg-white/5 transition flex items-center justify-center gap-1 copy-addr-btn"><i class="fas fa-copy"></i> آدرس</button>
                    <button class="mobile-manage-btn flex-1 bg-brand-gold text-black py-2 rounded-xl text-xs font-bold shadow-gold hover:scale-105 transition">مدیریت</button>
                </div>
            `;
            mCard.querySelector('.copy-addr-btn').onclick = () => { navigator.clipboard.writeText(o.customer_address); showToast('آدرس کپی شد'); };
            mCard.querySelector('.mobile-manage-btn').onclick = () => openOrderAction(o);
            if(prepend) mobileList.prepend(mCard); else mobileList.appendChild(mCard);
        }

        window.openOrderAction = async (order) => {
            activeOrderId = order.id;
            document.getElementById('order-action-modal').classList.remove('hidden');
            
            document.getElementById('modal-customer-name').innerText = order.customer_name;
            document.getElementById('modal-customer-phone').innerText = order.customer_phone;
            document.getElementById('modal-call-btn').href = `tel:${order.customer_phone}`;
            document.getElementById('modal-sms-btn').href = `sms:${order.customer_phone}`;
            document.getElementById('modal-customer-address').innerText = order.customer_address;
            document.getElementById('modal-customer-postal').innerText = order.customer_postal_code || 'ندارد';
            document.getElementById('modal-order-qty').innerText = order.quantity || 1;
            document.getElementById('modal-order-total').innerText = formatMoney(order.total_price) + ' تومان';

            const variantsContainer = document.getElementById('modal-product-variants');
            variantsContainer.innerHTML = '';
            if(order.selected_options) {
                try {
                    const opts = typeof order.selected_options === 'string' ? JSON.parse(order.selected_options) : order.selected_options;
                    for (const [key, val] of Object.entries(opts)) {
                        const isColor = val.startsWith && val.startsWith('#');
                        if(isColor) variantsContainer.innerHTML += `<div class="flex items-center gap-1 bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md text-[10px] font-bold"><div class="w-3 h-3 rounded-full border border-gray-300" style="background:${val}"></div> ${key}</div>`;
                        else variantsContainer.innerHTML += `<span class="text-[10px] bg-gray-100 dark:bg-white/10 px-2 py-0.5 rounded-md text-gray-600 dark:text-gray-300 font-bold">${key}: ${val}</span>`;
                    }
                } catch(e) {}
            }

            let pName = 'محصول یافت نشد (حذف شده)';
            let pImg = 'img/logo01.png';
            if(productsMap[order.product_id]) {
                const p = productsMap[order.product_id];
                pName = p.name;
                try { const imgs = JSON.parse(p.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
            } else {
                const { data } = await supabase.from('store_products').select('name, image').eq('id', order.product_id).single();
                if(data) {
                    pName = data.name;
                    try { const imgs = JSON.parse(data.image); if(imgs.length) pImg = imgs[0]; } catch(e){}
                }
            }
            document.getElementById('modal-product-name').innerText = pName;
            document.getElementById('modal-product-img').src = pImg;

            const paidView = document.getElementById('order-action-paid');
            const sentView = document.getElementById('order-action-sent');
            if (order.status === 'sent') {
                paidView.classList.add('hidden'); sentView.classList.remove('hidden');
                document.getElementById('display-tracking-code').innerText = order.tracking_code || '-';
            } else {
                paidView.classList.remove('hidden'); sentView.classList.add('hidden');
            }
        };

        window.closeOrderAction = () => document.getElementById('order-action-modal').classList.add('hidden');

        window.submitTrackingCode = async () => {
            const code = document.getElementById('tracking-input').value.trim();
            if(!code) { showToast('لطفا کد رهگیری را وارد کنید', 'error'); return; }
            const { error } = await supabase.from('store_orders').update({ status: 'sent', tracking_code: code }).eq('id', activeOrderId);
            if(error) { showToast('خطا: ' + error.message, 'error'); } 
            else {
                showToast('وضعیت سفارش بروزرسانی شد'); showToast('پیامک پیگیری برای مشتری ارسال شد', 'success'); 
                closeOrderAction();
                const orderIdx = allOrdersCache.findIndex(o => o.id == activeOrderId);
                if(orderIdx > -1) {
                    allOrdersCache[orderIdx].status = 'sent'; allOrdersCache[orderIdx].tracking_code = code; renderOrdersList(); 
                }
            }
        };

        // --- IMAGE UPLOAD (FIXED BY ID TARGETING) ---
        const compressImageToBlob = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const scale = 800 / img.width; 
                        canvas.width = 800; canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/webp', 0.85); 
                    }
                }
            })
        };

        window.handleImageUpload = async (input) => {
            if(!input.files.length) return;
            const uploadBtn = document.getElementById('upload-trigger-btn');
            if(uploadBtn) uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
            try {
                for(let file of input.files) {
                    showToast('در حال آپلود...', 'info');
                    const blob = await compressImageToBlob(file);
                    const cleanName = `${Date.now()}_${Math.random().toString(36).substring(7)}.webp`;
                    const fileName = `${currentUser.id}/${cleanName}`;
                    const { data, error } = await supabase.storage.from('product-images').upload(fileName, blob, { contentType: 'image/webp', upsert: false });
                    if (error && !data) throw error; 
                    const { data: { publicUrl } } = supabase.storage.from('product-images').getPublicUrl(fileName);
                    uploadedImages.push(publicUrl);
                }
                renderPreviews();
                showToast('تصویر با موفقیت افزوده شد');
            } catch (err) {
                if(err.message !== 'The resource already exists') showToast('خطا در آپلود', 'error');
            } finally {
                if(uploadBtn) uploadBtn.innerHTML = '<i class="fas fa-camera text-xl mb-1"></i><span class="text-[9px] font-bold">افزودن</span>';
                input.value = '';
            }
        };

        function renderPreviews() {
            const c = document.getElementById('image-previews-container');
            c.innerHTML = '';
            uploadedImages.forEach((imgUrl, idx) => {
                c.innerHTML += `
                    <div class="relative w-20 h-20 flex-shrink-0 group">
                        <img src="${imgUrl}" class="img-preview-item">
                        <div onclick="removeImg(${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] cursor-pointer shadow-sm z-10 hover:bg-red-600 transition"><i class="fas fa-times"></i></div>
                        ${idx === 0 ? '<div class="absolute bottom-0 left-0 w-full bg-brand-gold text-black text-[8px] font-bold text-center py-0.5 rounded-b-[16px]">کاور</div>' : ''}
                    </div>`;
            });
        }
        window.removeImg = (i) => { uploadedImages.splice(i, 1); renderPreviews(); };

        // --- CATEGORIES LOGIC (V3) ---
        async function loadCategories() {
            const { data } = await supabase.from('store_categories').select('*').eq('user_id', currentUser.id).order('sort_order', {ascending: true});
            allCategories = data || [];
            
            // Render in Settings
            const listContainer = document.getElementById('categories-list-container');
            if(listContainer) {
                listContainer.innerHTML = '';
                allCategories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'cat-item';
                    item.innerHTML = `<span class="text-xs font-bold text-gray-700 dark:text-gray-300">${cat.title}</span><i class="fas fa-trash text-red-500 cursor-pointer p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition" onclick="deleteCategory(${cat.id})"></i>`;
                    listContainer.appendChild(item);
                });
            }

            // Render in Product Dropdown
            const dropdown = document.getElementById('prod-category');
            if(dropdown) {
                dropdown.innerHTML = '<option value="">بدون دسته‌بندی</option>';
                allCategories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.id;
                    opt.innerText = cat.title;
                    dropdown.appendChild(opt);
                });
            }
        }

        window.createCategory = async () => {
            const input = document.getElementById('new-cat-title');
            const title = input.value.trim();
            if(!title) return;
            const { error } = await supabase.from('store_categories').insert([{ user_id: currentUser.id, title: title }]);
            if(error) showToast('خطا در ساخت دسته', 'error');
            else { showToast('دسته‌بندی ساخته شد'); input.value=''; loadCategories(); }
        };

        window.deleteCategory = async (id) => {
            if(!confirm('آیا مطمئن هستید؟')) return;
            const { error } = await supabase.from('store_categories').delete().eq('id', id);
            if(error) showToast('خطا در حذف', 'error');
            else { showToast('حذف شد'); loadCategories(); }
        };

        // --- ATTRIBUTES & LINK ---
        window.addAttributeBlock = (type) => {
            const c = document.getElementById('attributes-container');
            document.getElementById('no-attr-msg').style.display = 'none';
            const id = Date.now();
            let content = '';
            
            if(type === 'colors') {
                const palette = ['#000000','#FFFFFF','#1F2937','#DC2626','#2563EB','#059669','#D97706','#7C3AED'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="colors" id="${id}">
                        <div class="flex justify-between mb-3"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-palette text-gray-400"></i> رنگ‌بندی</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-2 items-center">
                            ${palette.map(col => `<div class="color-option" style="background:${col}; border-color:${col==='#FFFFFF'?'#e5e7eb':'transparent'}" data-val="${col}" onclick="this.classList.toggle('selected')"></div>`).join('')}
                            <div class="relative w-8 h-8 rounded-full overflow-hidden border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center cursor-pointer hover:border-brand-gold transition">
                                <i class="fas fa-plus text-[10px] text-gray-400"></i>
                                <input type="color" class="absolute inset-0 opacity-0 cursor-pointer" onchange="addCustomColor(this)">
                            </div>
                        </div>
                    </div>`;
            } else if (type === 'sizes') {
                const sizes = ['S','M','L','XL','XXL','36','37','38','39','40','41','42'];
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="sizes" id="${id}">
                        <div class="flex justify-between mb-3"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-ruler text-gray-400"></i> سایزبندی</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <div class="flex flex-wrap gap-2">
                            ${sizes.map(s => `<div class="px-3 py-1 rounded-lg border border-gray-200 dark:border-white/10 text-xs font-bold cursor-pointer hover:border-brand-gold bg-gray-50 dark:bg-white/5 transition select-chip" data-val="${s}" onclick="this.classList.toggle('bg-brand-gold');this.classList.toggle('text-black');this.classList.toggle('selected')">${s}</div>`).join('')}
                        </div>
                    </div>`;
            } else {
                content = `
                    <div class="attr-block bg-white dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5" data-type="custom" id="${id}">
                        <div class="flex justify-between mb-2"><span class="text-xs font-bold flex items-center gap-2"><i class="fas fa-pen text-gray-400"></i> ویژگی دلخواه</span><i class="fas fa-times text-red-500 cursor-pointer" onclick="document.getElementById('${id}').remove()"></i></div>
                        <input class="custom-label w-full bg-transparent border-b border-gray-200 dark:border-white/10 text-xs mb-3 py-1 outline-none font-bold placeholder-gray-400" placeholder="عنوان ویژگی (مثلا: جنس پارچه)">
                        <div class="tags-input-container" onclick="this.querySelector('input').focus()"><input type="text" class="tags-input" placeholder="تایپ کنید و Enter بزنید..." onkeydown="handleTagInput(event)"></div>
                    </div>`;
            }
            c.innerHTML += content;
        };

        window.addCustomColor = (inp) => {
            const col = inp.value; const div = document.createElement('div'); div.className = "color-option selected"; div.style.background = col; div.dataset.val = col; div.onclick = function(){this.classList.toggle('selected')}; inp.parentElement.parentElement.insertBefore(div, inp.parentElement);
        };
        window.handleTagInput = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); const val = e.target.value.trim();
                if (val) {
                    const chip = document.createElement('div'); chip.className = 'tag-chip custom-val-chip'; chip.dataset.val = val; chip.innerHTML = `<span>${val}</span><i class="fas fa-times" onclick="this.parentElement.remove()"></i>`;
                    e.target.parentElement.insertBefore(chip, e.target); e.target.value = '';
                }
            }
        };

        // --- PRODUCT MODAL LOGIC (TABS & SAVE) ---
        window.switchProductStep = (step) => {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.prod-tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`step-content-${step}`).classList.add('active');
            document.getElementById(`step-btn-${step}`).classList.add('active');
        };

        // --- GATEKEEPER LOGIC (NEW V5.1) ---
        
        window.checkPlanLimit = () => {
            // Free plan limit: 5 products
            if (currentUserPlan === 'free' && currentProductCount >= 5) {
                openUpgradeModal();
                return false;
            }
            return true;
        };

        window.openProductModal = (p = null) => {
            // Check limits for NEW products
            if (!p) { 
                if (!checkPlanLimit()) return;
            }

            document.getElementById('product-modal').classList.remove('hidden');
            document.getElementById('image-previews-container').innerHTML = '';
            document.getElementById('attributes-container').innerHTML = '<p class="text-[10px] text-gray-400 text-center italic" id="no-attr-msg">بدون ویژگی (محصول ساده)</p>';
            uploadedImages = []; const delBtn = document.getElementById('btn-delete-product');
            
            switchProductStep(1);

            if(p) {
                editingProductId = p.id; delBtn.classList.remove('hidden'); 
                document.getElementById('modal-title').innerText = 'ویرایش محصول';
                
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = formatMoney(p.price);
                if(p.category_id) document.getElementById('prod-category').value = p.category_id;
                
                document.getElementById('prod-stock').value = p.stock_quantity || '';
                document.getElementById('prod-threshold').value = p.low_stock_threshold || 5;
                
                document.getElementById('prod-short-desc').value = p.short_description || '';
                document.getElementById('prod-desc').value = p.description || '';
                document.getElementById('prod-shipping').value = formatMoney(p.shipping_cost || 0);
                
                if(p.discount_info) {
                    document.getElementById('prod-discount').value = p.discount_info.percent || '';
                    document.getElementById('prod-discount-label').value = p.discount_info.label || '';
                } else {
                    document.getElementById('prod-discount').value = '';
                    document.getElementById('prod-discount-label').value = '';
                }

                try { uploadedImages = JSON.parse(p.image); if(!Array.isArray(uploadedImages)) uploadedImages = [p.image]; renderPreviews(); } catch(e){}
                
            } else {
                editingProductId = null; delBtn.classList.add('hidden'); 
                document.getElementById('modal-title').innerText = 'محصول جدید';
                document.getElementById('product-form').reset();
            }
        };
        
        window.closeProductModal = () => document.getElementById('product-modal').classList.add('hidden');

        // --- UPGRADE MODAL LOGIC (UPDATED) ---
        window.openUpgradeModal = () => {
            document.getElementById('upgrade-modal').classList.remove('hidden');
        };
        
        window.closeUpgradeModal = () => {
            document.getElementById('upgrade-modal').classList.add('hidden');
        };
        
        window.selectPlan = (el, plan) => {
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        };

        window.initiatePayment = (planType) => {
            if (!currentUser) return;
            
            const btn = event.currentTarget; // Get the button that was clicked
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال اتصال...';
            btn.disabled = true;

            showToast('در حال انتقال به درگاه پرداخت...', 'info');
            
            // Redirect to payment page with params
            setTimeout(() => {
                window.location.href = `payment.html?plan=${planType}&user_id=${currentUser.id}`;
            }, 1000);
        };

        window.saveProduct = async () => {
            const btn = document.getElementById('btn-save-product');
            const name = document.getElementById('prod-name').value;
            
            const price = cleanPrice(document.getElementById('prod-price').value);
            const shipping = cleanPrice(document.getElementById('prod-shipping').value);
            const stockStr = toEnglishDigits(document.getElementById('prod-stock').value);
            const thresholdStr = toEnglishDigits(document.getElementById('prod-threshold').value);
            const discountStr = toEnglishDigits(document.getElementById('prod-discount').value);
            
            const desc = document.getElementById('prod-desc').value;
            const shortDesc = document.getElementById('prod-short-desc').value;
            
            const stock = parseInt(stockStr) || 0;
            const threshold = parseInt(thresholdStr) || 5;
            const categoryId = document.getElementById('prod-category').value || null;
            const discountPercent = parseInt(discountStr) || 0;
            const discountLabel = document.getElementById('prod-discount-label').value;
            
            const discountInfo = discountPercent > 0 ? { active: true, percent: discountPercent, label: discountLabel } : null;

            if(!name || !price) { 
                showToast('نام و قیمت الزامی است', 'error'); 
                switchProductStep(1); 
                return; 
            }
            
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const attributes = {};
            document.querySelectorAll('.attr-block').forEach(b => {
                const type = b.dataset.type;
                if(type === 'custom') { 
                    const l = b.querySelector('.custom-label').value; const vals = [];
                    b.querySelectorAll('.custom-val-chip').forEach(chip => vals.push(chip.dataset.val));
                    if(l && vals.length) attributes[l] = vals; 
                } else if (type === 'sizes') {
                    const vals = []; b.querySelectorAll('.select-chip.selected').forEach(s => vals.push(s.dataset.val)); if(vals.length) attributes[type] = vals; 
                } else { 
                    const vals = []; b.querySelectorAll('.color-option.selected').forEach(s => vals.push(s.dataset.val)); if(vals.length) attributes[type] = vals; 
                }
            });

            const payload = { 
                user_id: currentUser.id, 
                name, 
                price: parseInt(price), 
                shipping_cost: parseInt(shipping) || 0, 
                description: desc, 
                short_description: shortDesc, 
                image: JSON.stringify(uploadedImages), 
                attributes,
                stock_quantity: stock,
                low_stock_threshold: threshold,
                inventory_type: stock > 0 ? 'managed' : 'unlimited',
                category_id: categoryId,
                discount_info: discountInfo
            };
            
            let err;
            if(editingProductId) { 
                delete payload.user_id; 
                const { error } = await supabase.from('store_products').update(payload).eq('id', editingProductId); 
                err = error; 
            } else { 
                const { data, error } = await supabase.from('store_products').insert([payload]).select(); 
                err = error; 
                if(data) showLink(data[0].id); 
            }
            
            if(err) {
                showToast(err.message, 'error');
            } else { 
                showToast('محصول ذخیره شد'); 
                closeProductModal(); 
                loadStoreProducts(); 
            }
            btn.disabled = false; btn.innerHTML = '<span>ثبت نهایی محصول</span> <i class="fas fa-check"></i>';
        };

        window.showLink = (id) => {
            document.getElementById('link-modal').classList.remove('hidden');
            const path = window.location.pathname; const directory = path.substring(0, path.lastIndexOf('/')); const cleanDir = directory === '/' ? '' : directory;
            const link = `${window.location.origin}${cleanDir}/sale.html?id=${id}`;
            document.getElementById('generated-link').value = link;
            document.getElementById('preview-btn').href = link;
        };
        window.copyLink = () => { const copyText = document.getElementById("generated-link"); copyText.select(); document.execCommand("copy"); showToast("لینک کپی شد"); };

        window.switchTab = (tab) => {
            document.querySelectorAll('.sidebar-link, .bottom-nav-link').forEach(el => el.classList.remove('active')); event.currentTarget.classList.add('active');
            if(tab === 'orders') {
                document.getElementById('sidebar-badge-orders').classList.add('hidden'); document.getElementById('mobile-badge-orders').classList.add('hidden');
                setTimeout(() => { document.querySelectorAll('.new-order-highlight').forEach(el => el.classList.remove('new-order-highlight')); }, 3000);
            }
            ['dashboard', 'products', 'orders'].forEach(v => { const el = document.getElementById('view-' + v); if(el) { el.classList.add('hidden'); el.classList.remove('animate-slide-up'); } });
            const target = document.getElementById('view-' + tab); target.classList.remove('hidden'); setTimeout(() => target.classList.add('animate-slide-up'), 10);
        };
        
        window.viewMyShop = () => {
            if(currentUser) {
                const path = window.location.pathname; const directory = path.substring(0, path.lastIndexOf('/')); const cleanDir = directory === '/' ? '' : directory;
                window.location.href = `${window.location.origin}${cleanDir}/store.html?id=${currentUser.id}`;
            }
        };
        
        window.openSmartSeller = () => {
            if (currentUserPlan === 'free') {
                openUpgradeModal();
            } else {
                alert("سرویس فروشنده هوشمند به زودی برای شما فعال می‌شود!");
            }
        };
        
        window.logout = async () => { if(confirm('خروج؟')) await supabase.auth.signOut(); window.location.reload(); };

        // --- SEPARATED PROFILE & SETTINGS ---
        
        async function loadProfile() {
            const { data } = await supabase.from('store_profiles').select('*').eq('user_id', currentUser.id).single();
            if(data) {
                storeProfile = data;
                
                // Set Plan Info
                currentUserPlan = data.plan_type || 'free'; 
                
                document.getElementById('header-shop-name').innerText = data.store_name || 'فروشگاه من';
                document.getElementById('greeting-text').innerText = data.store_name || 'امپراتوری شما';
                if(data.store_logo) document.getElementById('header-avatar').src = data.store_logo;
                
                document.getElementById('wallet-display').innerText = formatMoney(data.wallet_balance || 0);
                document.getElementById('conf-zarinpal').value = data.zarinpal_merchant_id || '';
            }
        }
        
        window.copyBioLink = () => { const copyText = document.getElementById("generated-link"); copyText.select(); document.execCommand("copy"); showToast("لینک کپی شد"); };
        
        window.handleLogoUpload = async (input) => {
            if(!input.files.length) return;
            const file = input.files[0]; const blob = await compressImageToBlob(file);
            const fileName = `logos/${currentUser.id}_${Date.now()}.webp`; 
            const { error } = await supabase.storage.from('store-assets').upload(fileName, blob, { contentType: 'image/webp' });
            if(!error) { const { data: { publicUrl } } = supabase.storage.from('store-assets').getPublicUrl(fileName); newLogoUrl = publicUrl; document.getElementById('settings-logo-preview').src = publicUrl; }
        };

        // 1. Open Profile Modal (Header)
        window.openProfileModal = () => {
            document.getElementById('shop-profile-modal').classList.remove('hidden');
            if(storeProfile) {
                document.getElementById('setting-store-name').value = storeProfile.store_name || '';
                document.getElementById('setting-instagram').value = storeProfile.instagram_id || '';
                document.getElementById('setting-bio').value = storeProfile.bio || '';
                document.getElementById('setting-color').value = storeProfile.theme_color || '#D4AF37';
                if(storeProfile.store_logo) document.getElementById('settings-logo-preview').src = storeProfile.store_logo;
            }
        };

        window.saveShopProfile = async () => {
             const updates = {
                user_id: currentUser.id,
                store_name: document.getElementById('setting-store-name').value,
                instagram_id: document.getElementById('setting-instagram').value,
                bio: document.getElementById('setting-bio').value,
                theme_color: document.getElementById('setting-color').value,
                updated_at: new Date()
            };
            if(newLogoUrl) updates.store_logo = newLogoUrl;
            
            const { error } = await supabase.from('store_profiles').upsert(updates);
            if(error) showToast(error.message, 'error');
            else { showToast('پروفایل بروز شد'); location.reload(); }
        };

        // 2. Open Settings Modal (Sidebar)
        window.openSettingsModal = () => {
            document.getElementById('shop-settings-modal').classList.remove('hidden');
        };

        window.switchConfigTab = (btn, targetId) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            btn.classList.add('active-tab');
            document.querySelectorAll('.config-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
        };

        window.saveShopConfig = async () => {
            const btn = document.querySelector('button[onclick="saveShopConfig()"]');
            btn.disabled = true; btn.innerHTML = '...';

            // We are saving financial info to store_profiles for simplicity
            const updates = {
                user_id: currentUser.id,
                zarinpal_merchant_id: document.getElementById('conf-zarinpal').value.trim(),
                updated_at: new Date()
            };

            const { error } = await supabase.from('store_profiles').upsert(updates);
            
            if(error) {
                showToast('خطا در ذخیره تنظیمات', 'error');
            } else {
                showToast('تنظیمات مالی ذخیره شد');
                document.getElementById('shop-settings-modal').classList.add('hidden');
                loadProfile(); 
            }
            btn.disabled = false; btn.innerHTML = 'ذخیره تنظیمات';
        };

        window.requestWithdrawal = async () => {
            const balance = storeProfile?.wallet_balance || 0;
            const shaba = document.getElementById('conf-shaba').value;
            
            if(balance < 50000) {
                showToast('حداقل موجودی برای تسویه ۵۰,۰۰۰ تومان است', 'error');
                return;
            }
            if(!shaba || shaba.length < 10) {
                 showToast('شماره شبا معتبر وارد کنید', 'error');
                 return;
            }

            if(!confirm('آیا درخواست تسویه کل موجودی را دارید؟')) return;

            const btn = document.getElementById('btn-withdraw');
            btn.disabled = true; btn.innerHTML = '...';

            const { error } = await supabase.from('withdrawal_requests').insert([{
                user_id: currentUser.id,
                amount: balance,
                shaba_number: shaba,
                status: 'pending'
            }]);

            if(error) {
                showToast(error.message, 'error');
            } else {
                showToast('درخواست تسویه ثبت شد');
            }
            btn.disabled = false; btn.innerHTML = 'درخواست تسویه';
        };

    </script>
</body>
</html>