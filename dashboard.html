<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پورتال مشتریان | WEB LEGEND VIP</title>
    <link rel="icon" type="image/png" href="img/logo01.png">
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { brand: { gold: '#D4AF37', dark: '#050505', panel: '#0F1115' } },
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #000; color: white; }
        .glass { background: rgba(25, 25, 25, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%); color: #D4AF37; border-right: 3px solid #D4AF37; }
        .gold-glow { text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        /* Card Shine Effect */
        .credit-card { background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); position: relative; overflow: hidden; }
        .credit-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,175,55,0.1) 0%, transparent 60%); transform: rotate(45deg); pointer-events: none; }
    </style>
</head>
<body class="font-sans h-screen overflow-hidden flex text-sm">

    <div id="page-loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-white/10 rounded-full"></div>
            <div class="w-20 h-20 border-4 border-brand-gold border-t-transparent rounded-full animate-spin absolute top-0 left-0 shadow-[0_0_20px_rgba(212,175,55,0.5)]"></div>
        </div>
        <p class="mt-4 text-brand-gold text-xs font-bold tracking-[0.3em] animate-pulse">AUTHENTICATING...</p>
    </div>

    <aside class="w-20 lg:w-72 bg-brand-panel border-l border-white/5 flex flex-col z-20 transition-all duration-300">
        <div class="p-6 flex items-center justify-center lg:justify-start gap-3 border-b border-white/5 h-20">
            <div class="w-10 h-10 bg-gradient-to-br from-brand-gold to-yellow-700 rounded-xl flex items-center justify-center text-black font-black text-xl shadow-[0_0_15px_rgba(212,175,55,0.3)]">W</div>
            <div class="hidden lg:block">
                <h1 class="font-black tracking-tighter text-lg">WEB <span class="text-brand-gold">LEGEND</span></h1>
                <p class="text-[9px] text-gray-500 uppercase tracking-widest">Client Portal</p>
            </div>
        </div>

        <nav class="flex-1 py-8 px-3 space-y-2">
            <a href="#" class="sidebar-link active flex items-center justify-center lg:justify-start gap-4 px-4 py-4 lg:py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-2xl transition group">
                <i class="fas fa-th-large text-xl lg:text-base group-hover:scale-110 transition"></i> <span class="hidden lg:block font-bold">داشبورد من</span>
            </a>
            <a href="#" class="sidebar-link flex items-center justify-center lg:justify-start gap-4 px-4 py-4 lg:py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-2xl transition group">
                <i class="fas fa-file-invoice-dollar text-xl lg:text-base group-hover:scale-110 transition"></i> <span class="hidden lg:block font-bold">فاکتورها</span>
            </a>
            <a href="#" class="sidebar-link flex items-center justify-center lg:justify-start gap-4 px-4 py-4 lg:py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-2xl transition group">
                <i class="fas fa-headset text-xl lg:text-base group-hover:scale-110 transition"></i> <span class="hidden lg:block font-bold">پشتیبانی VIP</span>
            </a>
        </nav>

        <div class="p-4 border-t border-white/5">
            <button onclick="logout()" class="flex items-center justify-center lg:justify-start gap-3 w-full px-4 py-3 text-red-500/80 hover:bg-red-500/10 hover:text-red-500 rounded-xl transition">
                <i class="fas fa-sign-out-alt text-lg"></i> <span class="hidden lg:block font-bold">خروج</span>
            </button>
        </div>
    </aside>

    <main class="flex-1 bg-black relative flex flex-col h-full overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-[300px] bg-gradient-to-b from-brand-gold/5 to-transparent pointer-events-none"></div>

        <header class="h-20 flex justify-between items-center px-8 z-10">
            <div>
                <h2 class="text-xl font-black text-white" id="greeting-text">خوش آمدید</h2>
                <p class="text-xs text-gray-500" id="current-date">...</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/5">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-[10px] text-gray-400 font-mono tracking-wider">SYSTEM ONLINE</span>
                </div>
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-700 to-gray-900 border border-white/20 flex items-center justify-center">
                    <i class="fas fa-user text-gray-400"></i>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth pb-20">
            
            <div id="no-project-msg" class="hidden h-full flex flex-col items-center justify-center text-center opacity-0 transition-opacity duration-700">
                <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <i class="fas fa-folder-plus text-4xl text-gray-600"></i>
                </div>
                <h3 class="text-3xl font-black text-white mb-2">هنوز پروژه‌ای ندارید؟</h3>
                <p class="text-gray-500 mb-8 max-w-md">شما وارد پنل شده‌اید، اما هنوز پروژه فعالی برای این شماره ثبت نشده است.</p>
                <a href="index.html" class="bg-brand-gold hover:bg-white text-black font-black px-8 py-4 rounded-xl shadow-[0_0_30px_rgba(212,175,55,0.4)] transition hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-plus"></i> ثبت سفارش جدید
                </a>
            </div>

            <div id="dashboard-content" class="hidden space-y-6 opacity-0 transition-opacity duration-700">
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 glass rounded-[2rem] p-8 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-brand-gold/10 rounded-full blur-[50px] -mr-10 -mt-10"></div>
                        
                        <div class="flex justify-between items-start mb-6 relative z-10">
                            <div>
                                <span class="bg-brand-gold/20 text-brand-gold px-3 py-1 rounded-full text-[10px] font-bold border border-brand-gold/30 tracking-wider">PROJECT STATUS</span>
                                <h2 class="text-2xl lg:text-4xl font-black text-white mt-3 leading-tight" id="project-title">...</h2>
                                <p class="text-gray-400 mt-2 text-sm flex items-center gap-2">
                                    <i class="fas fa-user-circle text-brand-gold"></i> <span id="client-name">...</span>
                                </p>
                            </div>
                            <div class="text-right hidden md:block">
                                <p class="text-xs text-gray-500 mb-1">کد پروژه</p>
                                <p class="font-mono text-white font-bold" id="project-id">#WL-782</p>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-8 items-center mt-8">
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-xs mb-2">
                                        <span class="text-gray-400">پیشرفت کلی</span>
                                        <span class="text-white font-bold" id="progress-percent">0%</span>
                                    </div>
                                    <div class="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                                        <div id="progress-bar" class="h-full bg-gradient-to-r from-brand-gold to-yellow-600 w-0 transition-all duration-1000 shadow-[0_0_10px_#D4AF37]"></div>
                                    </div>
                                </div>
                                <div class="bg-black/30 rounded-xl p-4 border border-white/5 flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 animate-pulse">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] text-gray-500 uppercase">وضعیت فعلی</p>
                                        <p class="text-sm font-bold text-white" id="status-text">...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="h-32 flex justify-center md:justify-end relative">
                                <canvas id="progressChart"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span class="text-2xl font-black text-white" id="chart-center-text">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="credit-card rounded-[2rem] p-8 flex flex-col justify-between border border-white/10 shadow-2xl">
                        <div class="flex justify-between items-start">
                            <i class="fas fa-wifi text-white/20 text-2xl rotate-90"></i>
                            <span class="text-brand-gold font-black text-lg italic tracking-widest">WebLegend</span>
                        </div>
                        
                        <div class="my-6">
                            <p class="text-xs text-gray-500 mb-1 uppercase tracking-widest">مانده بدهی (تومان)</p>
                            <h3 class="text-3xl font-mono font-bold text-white tracking-tight" id="debt-amount">0</h3>
                        </div>

                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[9px] text-gray-500 uppercase mb-1">کل قرارداد</p>
                                <p class="text-sm font-mono text-gray-300" id="total-amount">0</p>
                            </div>
                            <div>
                                <p class="text-[9px] text-gray-500 uppercase mb-1">پرداخت شده</p>
                                <p class="text-sm font-mono text-green-400" id="paid-amount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 glass rounded-[2rem] p-8 border border-white/5">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-stream text-brand-gold"></i> مسیر پروژه
                        </h3>
                        <div class="relative flex justify-between items-center px-4">
                            <div class="absolute top-1/2 left-0 w-full h-1 bg-white/5 -z-10 rounded-full"></div>
                            <div class="absolute top-1/2 right-0 h-1 bg-brand-gold -z-0 rounded-full transition-all duration-1000" id="timeline-line" style="width: 0%"></div>

                            <div class="timeline-step relative group">
                                <div class="w-8 h-8 bg-brand-gold rounded-full flex items-center justify-center text-black font-bold text-xs shadow-[0_0_15px_#D4AF37] z-10 relative">
                                    <i class="fas fa-check"></i>
                                </div>
                                <span class="absolute -bottom-8 right-1/2 translate-x-1/2 text-[10px] text-brand-gold font-bold whitespace-nowrap">شروع</span>
                            </div>
                            
                            <div class="timeline-step relative group opacity-50" id="step-design">
                                <div class="w-8 h-8 bg-black border-2 border-gray-600 rounded-full flex items-center justify-center text-gray-500 font-bold text-xs z-10 relative transition-all">2</div>
                                <span class="absolute -bottom-8 right-1/2 translate-x-1/2 text-[10px] text-gray-500 font-bold whitespace-nowrap">طراحی</span>
                            </div>

                            <div class="timeline-step relative group opacity-50" id="step-code">
                                <div class="w-8 h-8 bg-black border-2 border-gray-600 rounded-full flex items-center justify-center text-gray-500 font-bold text-xs z-10 relative transition-all">3</div>
                                <span class="absolute -bottom-8 right-1/2 translate-x-1/2 text-[10px] text-gray-500 font-bold whitespace-nowrap">کدنویسی</span>
                            </div>

                            <div class="timeline-step relative group opacity-50" id="step-launch">
                                <div class="w-8 h-8 bg-black border-2 border-gray-600 rounded-full flex items-center justify-center text-gray-500 font-bold text-xs z-10 relative transition-all">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <span class="absolute -bottom-8 right-1/2 translate-x-1/2 text-[10px] text-gray-500 font-bold whitespace-nowrap">تحویل</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-[2rem] p-8 border border-white/5 flex flex-col justify-center items-center text-center">
                        <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4 text-2xl text-gray-400">
                            <i class="fas fa-headset"></i>
                        </div>
                        <h4 class="font-bold text-white">نیاز به راهنمایی دارید؟</h4>
                        <p class="text-xs text-gray-500 mt-2 mb-6">تیم پشتیبانی وب لجند آماده پاسخگویی است.</p>
                        <a href="https://t.me/WebLegendSupport" target="_blank" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 text-white py-3 rounded-xl transition text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fab fa-telegram"></i> ارسال پیام
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYx8TlwxZMf8_Ij2pAMYHAVGJev-qh8SE",
            authDomain: "weblegend-7e43a.firebaseapp.com",
            projectId: "weblegend-7e43a",
            storageBucket: "weblegend-7e43a.firebasestorage.app",
            messagingSenderId: "828252523206",
            appId: "1:828252523206:web:747ead66f393f8e6a725c7",
            measurementId: "G-WG19LN793S"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let progressChartInstance = null;

        // 1. DATE & GREETING
        function updateDate() {
            const date = new Date().toLocaleDateString('fa-IR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('current-date').innerText = date;
            
            const hour = new Date().getHours();
            let greeting = "روز خوش";
            if(hour >= 5 && hour < 12) greeting = "صبح بخیر";
            else if(hour >= 12 && hour < 19) greeting = "ظهر/عصر بخیر";
            else greeting = "شب بخیر";
            
            document.getElementById('greeting-text').innerText = `${greeting}، خوش اومدید`;
        }
        updateDate();

        // 2. AUTH & DATA
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('page-loader');
            
            if (user) {
                try {
                    // Query Project
                    const q = query(collection(db, "projects"), where("owner_phone", "==", user.phoneNumber));
                    const querySnapshot = await getDocs(q);

                    // Fade Out Loader
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.style.display = 'none', 500);

                    if (!querySnapshot.empty) {
                        const projectData = querySnapshot.docs[0].data();
                        
                        // Show Dashboard
                        const dashContent = document.getElementById('dashboard-content');
                        dashContent.classList.remove('hidden');
                        setTimeout(() => dashContent.classList.remove('opacity-0'), 100);
                        
                        updateUI(projectData);
                    } else {
                        // Show No Project
                        const noProj = document.getElementById('no-project-msg');
                        noProj.classList.remove('hidden');
                        setTimeout(() => noProj.classList.remove('opacity-0'), 100);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("خطا در ارتباط با سرور");
                    loader.style.display = 'none';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // 3. UI UPDATE LOGIC
        function updateUI(data) {
            // Text Data
            document.getElementById('client-name').innerText = data.client_name || "کاربر گرامی";
            document.getElementById('project-title').innerText = data.project_name || "پروژه فعال";
            document.getElementById('status-text').innerText = data.status || "در حال بررسی";
            document.getElementById('greeting-text').innerText = document.getElementById('greeting-text').innerText.replace('فرمانده', (data.client_name ? data.client_name.split(' ')[0] : 'عزیز'));

            // Progress Bar & Percent
            const progress = data.progress || 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-percent').innerText = `${progress}%`;
            document.getElementById('chart-center-text').innerText = `${progress}%`;

            // Financials
            const formatMoney = (n) => new Intl.NumberFormat('fa-IR').format(n);
            const total = Number(data.total_price || 0);
            const paid = Number(data.paid_amount || 0);
            const debt = total - paid;

            document.getElementById('total-amount').innerText = formatMoney(total);
            document.getElementById('paid-amount').innerText = formatMoney(paid);
            document.getElementById('debt-amount').innerText = formatMoney(debt);

            // Timeline Logic (Visual)
            updateTimeline(progress);

            // Init Chart
            initChart(progress);
        }

        function updateTimeline(progress) {
            const line = document.getElementById('timeline-line');
            const stepDesign = document.getElementById('step-design');
            const stepCode = document.getElementById('step-code');
            const stepLaunch = document.getElementById('step-launch');

            // Reset classes
            [stepDesign, stepCode, stepLaunch].forEach(el => {
                el.classList.add('opacity-50');
                el.querySelector('div').classList.remove('bg-brand-gold', 'text-black', 'border-none', 'shadow-[0_0_15px_#D4AF37]');
                el.querySelector('div').classList.add('bg-black', 'border-2', 'border-gray-600', 'text-gray-500');
            });

            // Logic based on progress (Simplified logic)
            let width = '0%';
            if (progress > 10) { width = '33%'; activateStep(stepDesign); }
            if (progress > 50) { width = '66%'; activateStep(stepCode); }
            if (progress > 90) { width = '100%'; activateStep(stepLaunch); }
            
            line.style.width = width;
        }

        function activateStep(el) {
            el.classList.remove('opacity-50');
            const circle = el.querySelector('div');
            circle.classList.remove('bg-black', 'border-2', 'border-gray-600', 'text-gray-500');
            circle.classList.add('bg-brand-gold', 'text-black', 'border-none', 'shadow-[0_0_15px_#D4AF37]');
        }

        function initChart(progress) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if(progressChartInstance) progressChartInstance.destroy();

            progressChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['تکمیل', 'باقیمانده'],
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: ['#D4AF37', 'rgba(255,255,255,0.05)'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        // Logout
        window.logout = () => {
            if(confirm("خروج از حساب کاربری؟")) {
                signOut(auth).then(() => window.location.href = 'index.html');
            }
        };
    </script>
</body>
</html>